<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOCY â€” Money Personality</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        :root{--bg:#0a0a0a;--surface:#111;--border:rgba(255,255,255,0.06);--text:#fff;--text2:#ccc;--dim:#888;--muted:#555;--accent:#E8C872;--coral:#E87272;--mint:#72E8B0;--lavender:#B272E8;--sky:#72B0E8}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;line-height:1.6}
        #root{min-height:100vh}
        #ascii-bg{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:0.4}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .fade-in{animation:fadeIn .6s ease forwards}
        .slide-up{animation:slideUp .5s ease forwards}
        .mono{font-family:'Space Mono',monospace}
        input::placeholder{color:var(--muted)}
        .section-title{font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:0.15em;color:var(--accent);margin-bottom:0.75rem;text-transform:uppercase}
        .card-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1.25rem;margin-bottom:1rem}
        .trust-badge{display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.75rem;background:rgba(114,232,176,0.06);border:1px solid rgba(114,232,176,0.15);border-radius:20px;font-size:0.7rem;color:var(--mint)}
        .file-chip{display:inline-flex;align-items:center;gap:0.4rem;padding:0.3rem 0.6rem;background:var(--surface);border:1px solid var(--border);border-radius:4px;font-size:0.7rem;color:var(--text2);margin:0.25rem}
        .file-chip button{background:none;border:none;color:var(--coral);cursor:pointer;padding:0;margin-left:0.3rem;font-size:0.8rem}
        .trait-tag{display:inline-flex;align-items:center;gap:0.3rem;padding:0.25rem 0.6rem;background:rgba(232,200,114,0.08);border:1px solid rgba(232,200,114,0.15);border-radius:12px;font-size:0.75rem;color:var(--accent);margin:0.2rem}
    </style>
</head>
<body>
<canvas id="ascii-bg"></canvas>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef}=React;
const CONFIG={googleScript:'https://script.google.com/macros/s/AKfycbxwOJ7DwZo4z3jiW25aH6nu5cC3qkIQs-GIizz0-xyeaoxe5Hdxg1TK3jxl_K1yJpIFRg/exec',landingPage:'https://www.bocy.io'};
const CLAUDE_CONFIG={endpoint:'/api/claude/enrich'};
const TRUELAYER_CONFIG={clientId:'bocymoneypersonality-a01ae4',authBaseUrl:'https://auth.truelayer.com',scope:'info accounts balance transactions cards',providers:'uk-ob-all uk-oauth-all',redirectUri:'https://telegram-truelayer-webapp.vercel.app/'};
const UK_BENCHMARKS={subscriptions:{count:5,monthly:52},foodDelivery:68,savingsRate:11};

// PDF.js worker setup
if(typeof pdfjsLib!=='undefined'){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'}

const ARCHETYPE_ASCII={
subscription_collector:"   [=] [=] [=]\\n   [=] [=] [=]\\n   [=] [=] [=]",
convenience_seeker:"     ~[FAST]~\\n    /        \\\\\\n   [  O  O  ]",
lifestyle_investor:"    *  .  *\\n   . \\\\__/ .\\n    *  .  *",
quiet_builder:"       /\\\\\\n      /  \\\\\\n     / $$ \\\\\\n    /______\\\\",
edge_walker:"   ~~~~~~~~~\\n   | O  O |\\n   ~~~~~~~~~",
debt_juggler:"    O   O   O\\n     \\\\ | /\\n      \\\\|/\\n       *",
balanced_realist:"   +-------+\\n   |  ===  |\\n   +-------+",
impulse_surfer:"    ~ ~ ~ ~\\n   ~  $$$  ~\\n    ~ ~ ~ ~",
comfort_spender:"    .  *  .\\n   * (~~) *\\n    .  *  .",
side_hustler:"   $$  >>  $$\\n   ||  >>  ||\\n   $$  >>  $$"
};


// MERCHANT DATABASE - Strict isSubscription flags
const MERCHANT_DB={
// SUBSCRIPTIONS (isSubscription: true)
'netflix':{name:'Netflix',category:'Subscriptions',isSubscription:true},
'spotify':{name:'Spotify',category:'Subscriptions',isSubscription:true},
'disney+':{name:'Disney+',category:'Subscriptions',isSubscription:true},
'disney plus':{name:'Disney+',category:'Subscriptions',isSubscription:true},
'amazon prime video':{name:'Prime Video',category:'Subscriptions',isSubscription:true},
'prime video':{name:'Prime Video',category:'Subscriptions',isSubscription:true},
'apple tv':{name:'Apple TV+',category:'Subscriptions',isSubscription:true},
'apple music':{name:'Apple Music',category:'Subscriptions',isSubscription:true},
'youtube premium':{name:'YouTube Premium',category:'Subscriptions',isSubscription:true},
'youtube music':{name:'YouTube Music',category:'Subscriptions',isSubscription:true},
'now tv':{name:'NOW TV',category:'Subscriptions',isSubscription:true},
'audible':{name:'Audible',category:'Subscriptions',isSubscription:true},
'openai':{name:'ChatGPT',category:'Subscriptions',isSubscription:true},
'chatgpt':{name:'ChatGPT',category:'Subscriptions',isSubscription:true},
'anthropic':{name:'Claude',category:'Subscriptions',isSubscription:true},
'claude':{name:'Claude',category:'Subscriptions',isSubscription:true},
'midjourney':{name:'Midjourney',category:'Subscriptions',isSubscription:true},
'adobe':{name:'Adobe',category:'Subscriptions',isSubscription:true},
'canva':{name:'Canva',category:'Subscriptions',isSubscription:true},
'figma':{name:'Figma',category:'Subscriptions',isSubscription:true},
'notion':{name:'Notion',category:'Subscriptions',isSubscription:true},
'microsoft 365':{name:'Microsoft 365',category:'Subscriptions',isSubscription:true},
'office 365':{name:'Microsoft 365',category:'Subscriptions',isSubscription:true},
'google one':{name:'Google One',category:'Subscriptions',isSubscription:true},
'dropbox':{name:'Dropbox',category:'Subscriptions',isSubscription:true},
'nordvpn':{name:'NordVPN',category:'Subscriptions',isSubscription:true},
'expressvpn':{name:'ExpressVPN',category:'Subscriptions',isSubscription:true},
'lovable':{name:'Lovable',category:'Subscriptions',isSubscription:true},
'cursor':{name:'Cursor',category:'Subscriptions',isSubscription:true},
'headspace':{name:'Headspace',category:'Subscriptions',isSubscription:true},
'calm':{name:'Calm',category:'Subscriptions',isSubscription:true},
'strava':{name:'Strava',category:'Subscriptions',isSubscription:true},
'peloton':{name:'Peloton',category:'Subscriptions',isSubscription:true},
'pure gym':{name:'PureGym',category:'Subscriptions',isSubscription:true},
'puregym':{name:'PureGym',category:'Subscriptions',isSubscription:true},
'the gym':{name:'The Gym',category:'Subscriptions',isSubscription:true},
'david lloyd':{name:'David Lloyd',category:'Subscriptions',isSubscription:true},
'skillshare':{name:'Skillshare',category:'Subscriptions',isSubscription:true},
'masterclass':{name:'MasterClass',category:'Subscriptions',isSubscription:true},
'duolingo':{name:'Duolingo',category:'Subscriptions',isSubscription:true},
'paramount+':{name:'Paramount+',category:'Subscriptions',isSubscription:true},
'paramount plus':{name:'Paramount+',category:'Subscriptions',isSubscription:true},
'crunchyroll':{name:'Crunchyroll',category:'Subscriptions',isSubscription:true},
'xbox game pass':{name:'Xbox Game Pass',category:'Subscriptions',isSubscription:true},
'ps plus':{name:'PS Plus',category:'Subscriptions',isSubscription:true},
'playstation plus':{name:'PS Plus',category:'Subscriptions',isSubscription:true},
'amazon prime':{name:'Amazon Prime',category:'Subscriptions',isSubscription:true},
'icloud':{name:'iCloud',category:'Subscriptions',isSubscription:true},
'apple.com/bill':{name:'Apple Subscription',category:'Subscriptions',isSubscription:true},
'tidal':{name:'Tidal',category:'Subscriptions',isSubscription:true},
'deezer':{name:'Deezer',category:'Subscriptions',isSubscription:true},

// DEBT PAYMENTS (isSubscription: false)
'american express':{name:'American Express',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'amex':{name:'American Express',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'capital one':{name:'Capital One',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'capitalone':{name:'Capital One',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'barclaycard':{name:'Barclaycard',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'mbna':{name:'MBNA',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'aqua':{name:'Aqua',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'vanquis':{name:'Vanquis',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'klarna':{name:'Klarna',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'clearpay':{name:'Clearpay',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'afterpay':{name:'Afterpay',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'zilch':{name:'Zilch',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'laybuy':{name:'Laybuy',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},

// TRANSFERS (isSubscription: false)
'transfer to':{name:'Transfer',category:'Transfers',isSubscription:false},
'transfer from':{name:'Transfer',category:'Transfers',isSubscription:false},
'standing order':{name:'Standing Order',category:'Transfers',isSubscription:false},
'faster payment':{name:'Faster Payment',category:'Transfers',isSubscription:false},
'pot transfer':{name:'Pot Transfer',category:'Transfers',isSubscription:false},

// TRANSPORT (isSubscription: false)
'tfl':{name:'TfL',category:'Transport',isSubscription:false},
'oyster':{name:'Oyster',category:'Transport',isSubscription:false},
'trainline':{name:'Trainline',category:'Transport',isSubscription:false},
'uber':{name:'Uber',category:'Transport',isSubscription:false},
'bolt ':{name:'Bolt',category:'Transport',isSubscription:false,_wordBound:true},
'bolt.eu':{name:'Bolt',category:'Transport',isSubscription:false},
'addison lee':{name:'Addison Lee',category:'Transport',isSubscription:false},
'lime ':{name:'Lime',category:'Transport',isSubscription:false,_wordBound:true},
'voi ':{name:'Voi',category:'Transport',isSubscription:false,_wordBound:true},
'shell ':{name:'Shell',category:'Transport',isSubscription:false,_wordBound:true},
'bp ':{name:'BP',category:'Transport',isSubscription:false,_wordBound:true},
'esso':{name:'Esso',category:'Transport',isSubscription:false},
'texaco':{name:'Texaco',category:'Transport',isSubscription:false},
'avanti west':{name:'Avanti',category:'Transport',isSubscription:false},
'lner':{name:'LNER',category:'Transport',isSubscription:false},
'gwr ':{name:'GWR',category:'Transport',isSubscription:false,_wordBound:true},
'northern rail':{name:'Northern Rail',category:'Transport',isSubscription:false},

// FOOD DELIVERY (isSubscription: false) â€” delivery apps ONLY, NOT grocery shops
'deliveroo':{name:'Deliveroo',category:'Food Delivery',isSubscription:false},
'uber eats':{name:'Uber Eats',category:'Food Delivery',isSubscription:false},
'ubereats':{name:'Uber Eats',category:'Food Delivery',isSubscription:false},
'just eat':{name:'Just Eat',category:'Food Delivery',isSubscription:false},
'justeat':{name:'Just Eat',category:'Food Delivery',isSubscription:false},
'gousto':{name:'Gousto',category:'Food Delivery',isSubscription:true},
'hello fresh':{name:'HelloFresh',category:'Food Delivery',isSubscription:true},
'hellofresh':{name:'HelloFresh',category:'Food Delivery',isSubscription:true},

// GROCERIES â€” supermarkets and grocery shops, NOT food delivery
'tesco':{name:'Tesco',category:'Groceries',isSubscription:false},
'sainsbury':{name:'Sainsburys',category:'Groceries',isSubscription:false},
'asda':{name:'ASDA',category:'Groceries',isSubscription:false},
'morrisons':{name:'Morrisons',category:'Groceries',isSubscription:false},
'aldi':{name:'Aldi',category:'Groceries',isSubscription:false},
'lidl':{name:'Lidl',category:'Groceries',isSubscription:false},
'waitrose':{name:'Waitrose',category:'Groceries',isSubscription:false},
'ocado':{name:'Ocado',category:'Groceries',isSubscription:false},
'iceland':{name:'Iceland',category:'Groceries',isSubscription:false},
'marks spencer':{name:'M&S Food',category:'Groceries',isSubscription:false},
'm&s':{name:'M&S Food',category:'Groceries',isSubscription:false},
'co-op':{name:'Co-op',category:'Groceries',isSubscription:false},
'coop':{name:'Co-op',category:'Groceries',isSubscription:false},
'whole foods':{name:'Whole Foods',category:'Groceries',isSubscription:false},
'getir':{name:'Getir',category:'Groceries',isSubscription:false},
'gorillas':{name:'Gorillas',category:'Groceries',isSubscription:false},

// EATING OUT
'starbucks':{name:'Starbucks',category:'Eating Out',isSubscription:false},
'costa coffee':{name:'Costa',category:'Eating Out',isSubscription:false},
'costa ':{name:'Costa',category:'Eating Out',isSubscription:false},
'pret a manger':{name:'Pret',category:'Eating Out',isSubscription:false},
'pret ':{name:'Pret',category:'Eating Out',isSubscription:false},
'greggs':{name:'Greggs',category:'Eating Out',isSubscription:false},
'mcdonalds':{name:'McDonalds',category:'Eating Out',isSubscription:false},
'mcdonald':{name:'McDonalds',category:'Eating Out',isSubscription:false},
'nandos':{name:'Nandos',category:'Eating Out',isSubscription:false},
'nando':{name:'Nandos',category:'Eating Out',isSubscription:false},
'wagamama':{name:'Wagamama',category:'Eating Out',isSubscription:false},
'kfc':{name:'KFC',category:'Eating Out',isSubscription:false},
'burger king':{name:'Burger King',category:'Eating Out',isSubscription:false},
'five guys':{name:'Five Guys',category:'Eating Out',isSubscription:false},
'subway':{name:'Subway',category:'Eating Out',isSubscription:false},
'pizza express':{name:'Pizza Express',category:'Eating Out',isSubscription:false},
'pizza hut':{name:'Pizza Hut',category:'Eating Out',isSubscription:false},
'dominos':{name:'Dominos',category:'Eating Out',isSubscription:false},
'wetherspoon':{name:'Wetherspoons',category:'Eating Out',isSubscription:false},
'itsu':{name:'Itsu',category:'Eating Out',isSubscription:false},
'leon ':{name:'Leon',category:'Eating Out',isSubscription:false,_wordBound:true},
'tortilla':{name:'Tortilla',category:'Eating Out',isSubscription:false},
'gails':{name:'Gails',category:'Eating Out',isSubscription:false},
'gail s':{name:'Gails',category:'Eating Out',isSubscription:false},
'caffe nero':{name:'Caffe Nero',category:'Eating Out',isSubscription:false},
'eat.':{name:'EAT.',category:'Eating Out',isSubscription:false},
'eat ':{name:'EAT.',category:'Eating Out',isSubscription:false,_wordBound:true},
'franco manca':{name:'Franco Manca',category:'Eating Out',isSubscription:false},
'dishoom':{name:'Dishoom',category:'Eating Out',isSubscription:false},
'yo sushi':{name:'Yo! Sushi',category:'Eating Out',isSubscription:false},
'honest burger':{name:'Honest Burgers',category:'Eating Out',isSubscription:false},
'bills restaurant':{name:"Bill's",category:'Eating Out',isSubscription:false},
'cote ':{name:'Cote',category:'Eating Out',isSubscription:false},
'brewdog':{name:'Brewdog',category:'Eating Out',isSubscription:false},

// SHOPPING
'amazon':{name:'Amazon',category:'Shopping',isSubscription:false},
'amzn':{name:'Amazon',category:'Shopping',isSubscription:false},
'asos':{name:'ASOS',category:'Shopping',isSubscription:false},
'zara':{name:'Zara',category:'Shopping',isSubscription:false},
'ikea':{name:'IKEA',category:'Shopping',isSubscription:false},
'h&m':{name:'H&M',category:'Shopping',isSubscription:false},
'primark':{name:'Primark',category:'Shopping',isSubscription:false},
'uniqlo':{name:'Uniqlo',category:'Shopping',isSubscription:false},
'john lewis':{name:'John Lewis',category:'Shopping',isSubscription:false},
'next ':{name:'Next',category:'Shopping',isSubscription:false,_wordBound:true},
'next.co':{name:'Next',category:'Shopping',isSubscription:false},
'tk maxx':{name:'TK Maxx',category:'Shopping',isSubscription:false},
'tkmaxx':{name:'TK Maxx',category:'Shopping',isSubscription:false},
'ebay':{name:'eBay',category:'Shopping',isSubscription:false},
'shein':{name:'Shein',category:'Shopping',isSubscription:false},
'boohoo':{name:'Boohoo',category:'Shopping',isSubscription:false},
'currys':{name:'Currys',category:'Shopping',isSubscription:false},
'argos':{name:'Argos',category:'Shopping',isSubscription:false},
'apple store':{name:'Apple Store',category:'Shopping',isSubscription:false},
'nike':{name:'Nike',category:'Shopping',isSubscription:false},
'adidas':{name:'Adidas',category:'Shopping',isSubscription:false},
'gymshark':{name:'Gymshark',category:'Shopping',isSubscription:false},
'decathlon':{name:'Decathlon',category:'Shopping',isSubscription:false},
'waterstones':{name:'Waterstones',category:'Shopping',isSubscription:false},
'screwfix':{name:'Screwfix',category:'Shopping',isSubscription:false},
'b&q':{name:'B&Q',category:'Shopping',isSubscription:false},
'halfords':{name:'Halfords',category:'Shopping',isSubscription:false},
'sports direct':{name:'Sports Direct',category:'Shopping',isSubscription:false},
'river island':{name:'River Island',category:'Shopping',isSubscription:false},
'new look':{name:'New Look',category:'Shopping',isSubscription:false},
'matalan':{name:'Matalan',category:'Shopping',isSubscription:false},
'boots':{name:'Boots',category:'Health',isSubscription:false},
'superdrug':{name:'Superdrug',category:'Health',isSubscription:false},

// ENTERTAINMENT
'odeon':{name:'Odeon',category:'Entertainment',isSubscription:false},
'cineworld':{name:'Cineworld',category:'Entertainment',isSubscription:false},
'vue cinema':{name:'Vue',category:'Entertainment',isSubscription:false},
'curzon':{name:'Curzon',category:'Entertainment',isSubscription:false},
'steam':{name:'Steam',category:'Entertainment',isSubscription:false},
'playstation':{name:'PlayStation',category:'Entertainment',isSubscription:false},
'xbox':{name:'Xbox',category:'Entertainment',isSubscription:false},
'nintendo':{name:'Nintendo',category:'Entertainment',isSubscription:false},
'ticketmaster':{name:'Ticketmaster',category:'Entertainment',isSubscription:false},
'dice ':{name:'DICE',category:'Entertainment',isSubscription:false,_wordBound:true},
'dice.fm':{name:'DICE',category:'Entertainment',isSubscription:false},
'eventbrite':{name:'Eventbrite',category:'Entertainment',isSubscription:false},

// BILLS
'british gas':{name:'British Gas',category:'Bills',isSubscription:false},
'octopus energy':{name:'Octopus Energy',category:'Bills',isSubscription:false},
'octopus':{name:'Octopus Energy',category:'Bills',isSubscription:false},
'bulb':{name:'Bulb',category:'Bills',isSubscription:false},
'ovo energy':{name:'OVO Energy',category:'Bills',isSubscription:false},
'edf':{name:'EDF',category:'Bills',isSubscription:false},
'scottish power':{name:'Scottish Power',category:'Bills',isSubscription:false},
'council tax':{name:'Council Tax',category:'Bills',isSubscription:false},
'rent ':{name:'Rent',category:'Bills',isSubscription:false,_wordBound:true},
'rental':{name:'Rent',category:'Bills',isSubscription:false},
'mortgage':{name:'Mortgage',category:'Bills',isSubscription:false},
'thames water':{name:'Thames Water',category:'Bills',isSubscription:false},
'anglian water':{name:'Anglian Water',category:'Bills',isSubscription:false},
'united utilities':{name:'United Utilities',category:'Bills',isSubscription:false},
'severn trent':{name:'Severn Trent',category:'Bills',isSubscription:false},
'yorkshire water':{name:'Yorkshire Water',category:'Bills',isSubscription:false},
'water ':{name:'Water',category:'Bills',isSubscription:false,_wordBound:true},
'bt broadband':{name:'BT',category:'Bills',isSubscription:false},
'bt group':{name:'BT',category:'Bills',isSubscription:false},
'bt.com':{name:'BT',category:'Bills',isSubscription:false},
'sky tv':{name:'Sky',category:'Bills',isSubscription:false},
'sky digital':{name:'Sky',category:'Bills',isSubscription:false},
'sky broadband':{name:'Sky',category:'Bills',isSubscription:false},
'virgin media':{name:'Virgin Media',category:'Bills',isSubscription:false},
'plusnet':{name:'Plusnet',category:'Bills',isSubscription:false},
'hyperoptic':{name:'Hyperoptic',category:'Bills',isSubscription:false},
'ee ltd':{name:'EE',category:'Bills',isSubscription:false},
'ee mobile':{name:'EE',category:'Bills',isSubscription:false},
'vodafone':{name:'Vodafone',category:'Bills',isSubscription:false},
'o2 uk':{name:'O2',category:'Bills',isSubscription:false},
'three mobile':{name:'Three',category:'Bills',isSubscription:false},
'three.co':{name:'Three',category:'Bills',isSubscription:false},
'giffgaff':{name:'Giffgaff',category:'Bills',isSubscription:false},
'tv licence':{name:'TV Licence',category:'Bills',isSubscription:false},
'insurance':{name:'Insurance',category:'Bills',isSubscription:false},

// HEALTH
'bupa':{name:'Bupa',category:'Health',isSubscription:false},
'dentist':{name:'Dentist',category:'Health',isSubscription:false},
'pharmacy':{name:'Pharmacy',category:'Health',isSubscription:false},
'optician':{name:'Optician',category:'Health',isSubscription:false},
'specsavers':{name:'Specsavers',category:'Health',isSubscription:false},
'vision express':{name:'Vision Express',category:'Health',isSubscription:false},

// TRAVEL
'ryanair':{name:'Ryanair',category:'Travel',isSubscription:false},
'easyjet':{name:'easyJet',category:'Travel',isSubscription:false},
'british airways':{name:'British Airways',category:'Travel',isSubscription:false},
'jet2':{name:'Jet2',category:'Travel',isSubscription:false},
'wizz air':{name:'Wizz Air',category:'Travel',isSubscription:false},
'wizzair':{name:'Wizz Air',category:'Travel',isSubscription:false},
'tui ':{name:'TUI',category:'Travel',isSubscription:false,_wordBound:true},
'booking.com':{name:'Booking.com',category:'Travel',isSubscription:false},
'airbnb':{name:'Airbnb',category:'Travel',isSubscription:false},
'hotels.com':{name:'Hotels.com',category:'Travel',isSubscription:false},
'expedia':{name:'Expedia',category:'Travel',isSubscription:false},
'skyscanner':{name:'Skyscanner',category:'Travel',isSubscription:false},
'eurostar':{name:'Eurostar',category:'Travel',isSubscription:false},
'national express':{name:'National Express',category:'Travel',isSubscription:false},

// CHARITY
'justgiving':{name:'JustGiving',category:'Charity',isSubscription:false},
'gofundme':{name:'GoFundMe',category:'Charity',isSubscription:false},
'charity':{name:'Charity',category:'Charity',isSubscription:false},
'donation':{name:'Donation',category:'Charity',isSubscription:false},
'cancer research':{name:'Cancer Research',category:'Charity',isSubscription:false},
'british heart':{name:'British Heart Foundation',category:'Charity',isSubscription:false},
'red cross':{name:'Red Cross',category:'Charity',isSubscription:false},
'oxfam':{name:'Oxfam',category:'Charity',isSubscription:false},
'macmillan':{name:'Macmillan',category:'Charity',isSubscription:false},

// EDUCATION
'udemy':{name:'Udemy',category:'Education',isSubscription:false},
'coursera':{name:'Coursera',category:'Education',isSubscription:false},
'linkedin learning':{name:'LinkedIn Learning',category:'Education',isSubscription:false},
'student loan':{name:'Student Loan',category:'Education',isSubscription:false},
'student loans':{name:'Student Loan',category:'Education',isSubscription:false},
'university':{name:'University',category:'Education',isSubscription:false},
'tuition':{name:'Tuition',category:'Education',isSubscription:false},
'nursery':{name:'Nursery',category:'Education',isSubscription:false},
'school fees':{name:'School Fees',category:'Education',isSubscription:false},

// SAVINGS & INVESTMENTS (not counted as spending)
'vanguard':{name:'Vanguard',category:'Savings',isSubscription:false},
'nutmeg':{name:'Nutmeg',category:'Savings',isSubscription:false},
'freetrade':{name:'Freetrade',category:'Savings',isSubscription:false},
'trading 212':{name:'Trading 212',category:'Savings',isSubscription:false},
'hargreaves':{name:'Hargreaves Lansdown',category:'Savings',isSubscription:false},
'aj bell':{name:'AJ Bell',category:'Savings',isSubscription:false},
'moneybox':{name:'Moneybox',category:'Savings',isSubscription:false},
'plum ':{name:'Plum',category:'Savings',isSubscription:false,_wordBound:true},
'chip ':{name:'Chip',category:'Savings',isSubscription:false,_wordBound:true},

// INCOME â€” only genuine income sources, NOT refunds
'salary':{name:'Salary',category:'Income',isSubscription:false},
'wages':{name:'Wages',category:'Income',isSubscription:false},
'payroll':{name:'Payroll',category:'Income',isSubscription:false},
'interest':{name:'Interest',category:'Income',isSubscription:false},
'dividend':{name:'Dividend',category:'Income',isSubscription:false},
'hmrc':{name:'HMRC',category:'Income',isSubscription:false},
'tax refund':{name:'Tax Refund',category:'Income',isSubscription:false},
'bacs':{name:'BACS Payment',category:'Income',isSubscription:false},
'chaps':{name:'CHAPS Payment',category:'Income',isSubscription:false},
'dwp':{name:'DWP',category:'Income',isSubscription:false},
'universal credit':{name:'Universal Credit',category:'Income',isSubscription:false},
'child benefit':{name:'Child Benefit',category:'Income',isSubscription:false},
'tax credits':{name:'Tax Credits',category:'Income',isSubscription:false},
'pension':{name:'Pension',category:'Income',isSubscription:false},
'state pension':{name:'State Pension',category:'Income',isSubscription:false},
'jobseeker':{name:'Jobseekers Allowance',category:'Income',isSubscription:false},
'sage payroll':{name:'Sage Payroll',category:'Income',isSubscription:false},
'xero payroll':{name:'Xero Payroll',category:'Income',isSubscription:false},
'brightpay':{name:'BrightPay',category:'Income',isSubscription:false},
'moorepay':{name:'Moorepay',category:'Income',isSubscription:false},
'adp payroll':{name:'ADP Payroll',category:'Income',isSubscription:false},
'ceridian':{name:'Ceridian',category:'Income',isSubscription:false},
'iris payroll':{name:'IRIS Payroll',category:'Income',isSubscription:false},
'autopay':{name:'Autopay',category:'Income',isSubscription:false},
'payroll solutions':{name:'Payroll Solutions',category:'Income',isSubscription:false},
'payroll services':{name:'Payroll Services',category:'Income',isSubscription:false},

// REFUNDS â€” credits but not income (excluded from income calculations)
'refund':{name:'Refund',category:'Refund',isSubscription:false},
'reversal':{name:'Reversal',category:'Refund',isSubscription:false},
'cashback':{name:'Cashback',category:'Refund',isSubscription:false}
};

// Essential/non-discretionary categories â€” for behavioral pattern analysis
const ESSENTIAL_CATEGORIES=new Set(['Bills','Groceries','Transport','Health','Education','Debt Payments']);

// ARCHETYPES â€” 10 distinct money personalities
const ARCHETYPES={
subscription_collector:{name:'The Subscription Collector',emoji:'ðŸ“¦',color:'#B272E8',vibe:"Your card gets more monthly exercise than you",description:"You have assembled quite the digital empire â€” streaming services, apps, memberships. Each one seemed essential at signup, but together they are quietly reshaping your bank balance.",
genPlaybook:p=>{const subs=p.subscriptions||[];const total=p.monthly.subscriptions;const names=subs.slice(0,4).map(s=>s.merchant+' \u00a3'+s.averageAmount).join(', ');return{narrative:`${subs.length} subscriptions totalling \u00a3${total}/month (\u00a3${total*12}/year): ${names}${subs.length>4?' and '+(subs.length-4)+' more':''}. ${p.monthly.income>0?'That is '+Math.round((total/p.monthly.income)*100)+'% of your income on auto-pilot.':'A significant outgoing running on autopilot.'}`,strategies:[{title:'Audit and rotate',text:'Cancel the 2 you use least. Trial free alternatives for 30 days before re-subscribing.'},{title:'Bundle where possible',text:'Apple One, YouTube Premium family plans, or shared accounts can cut 30-40% off individual prices.'},{title:'Set quarterly reviews',text:'Put a calendar reminder every 3 months to check which subscriptions you actually opened this quarter.'}]}},triggers:p=>p.metrics.subscriptionCount>=5||p.monthly.subscriptions>70},

convenience_seeker:{name:'The Convenience Seeker',emoji:'ðŸ›µ',color:'#E87272',vibe:"Time is money, so you spend money on time",description:"Deliveroo, Uber, meal kits â€” your phone is basically a personal assistant. You have optimised your life for convenience, but at a premium.",
genPlaybook:p=>{const fd=p.monthly.foodDelivery;const tr=p.monthly.transport||0;const topDel=p.topMerchants?.find(m=>['Deliveroo','Uber Eats','Just Eat'].includes(m.merchant));return{narrative:`\u00a3${fd}/month on food delivery${tr>80?' and \u00a3'+tr+' on transport':''} \u2014 \u00a3${(fd+tr)*12}/year on convenience.${topDel?' Most frequent: '+topDel.merchant+' ('+topDel.count+' orders).':''} You are paying for time, not just food.`,strategies:[{title:'Same convenience, lower cost',text:'Swap '+(Math.ceil(fd*0.3/15))+' delivery orders per month for a meal prep box (Gousto, HelloFresh) \u2014 same zero-effort meals, roughly 40% cheaper per serving.'},{title:'Strategic batch cooking',text:'Cook double on Sundays. Freeze half. That covers 2-3 midweek meals you would otherwise order in. Saves ~\u00a3'+Math.round(fd*0.25)+'/mo.'},{title:'Transport audit',text:tr>80?'A monthly travel card or e-scooter pass may be cheaper than \u00a3'+tr+'/mo in individual rides.':'Keep transport lean \u2014 your main lever is food delivery.'}]}},triggers:p=>(p.monthly.foodDelivery+(p.monthly.transport||0))>120},

lifestyle_investor:{name:'The Lifestyle Investor',emoji:'âœ¨',color:'#E8C872',vibe:"You are not spending, you are curating a life",description:"Shopping, dining, experiences â€” these are not expenses in your mind. They are investments in the version of yourself you are building.",
genPlaybook:p=>{const shop=p.monthly.shopping||0;const ent=p.monthly.entertainment||0;const eat=p.monthly.eatingOut||0;const total=shop+ent+eat;return{narrative:`\u00a3${total}/month (\u00a3${total*12}/year) on lifestyle \u2014 \u00a3${shop} shopping${ent>0?', \u00a3'+ent+' entertainment':''}${eat>0?', \u00a3'+eat+' eating out':''}. ${p.monthly.income>0?Math.round((total/p.monthly.income)*100)+'% of income goes to how you live, not just what you need.':'A significant investment in quality of life.'}`,strategies:[{title:'Curate with a budget',text:'Set a monthly lifestyle budget of \u00a3'+Math.round(total*0.8)+' (\u00a3'+Math.round(total*0.2)+' less). Choose where to spend it rather than cutting everything.'},{title:'Experience over things',text:'Experiences create longer-lasting satisfaction than purchases. Shift \u00a3'+Math.round(shop*0.15)+'/mo from shopping to experiences you will remember.'},{title:'The 30-day list',text:'Before any purchase over \u00a350, add it to a list. If you still want it in 30 days, buy it guilt-free. Most items drop off.'}]}},triggers:p=>((p.monthly.shopping||0)+(p.monthly.entertainment||0)+(p.monthly.eatingOut||0))>200},

quiet_builder:{name:'The Quiet Builder',emoji:'ðŸŒ±',color:'#72E8B0',vibe:"Your future self is already thanking you",description:"While others chase the next dopamine hit, you are quietly building wealth. Your discipline will compound in ways most people do not understand yet.",
genPlaybook:p=>{const sr=p.metrics.savingsRate;const surplus=p.monthly.surplus;return{narrative:`Saving ${sr}% of income \u2014 \u00a3${surplus}/month (\u00a3${surplus*12}/year). Well above the UK average of ${UK_BENCHMARKS.savingsRate}%.${p.metrics.debtAccountCount===0?' Debt-free.':' Managing debt while still saving \u2014 real discipline.'} At this rate, \u00a3${Math.round(surplus*60).toLocaleString()} set aside in 5 years before investment growth.`,strategies:[{title:'Optimise what you save',text:'If your savings sit in a current account earning 0%, move them. An easy-access savings account or S&S ISA puts your discipline to work.'},{title:'Automate the surplus',text:'Set up a standing order on payday for \u00a3'+surplus+' to a savings account. Remove the temptation to spend what is left.'},{title:'Increase by 1%',text:'You are at '+sr+'%. Push to '+(sr+1)+'% \u2014 just \u00a3'+Math.round(p.monthly.income*0.01)+'/month more. You will not feel it, but it compounds.'}]}},triggers:p=>p.metrics.savingsRate>20},

edge_walker:{name:'The Edge Walker',emoji:'ðŸŽ­',color:'#E87272',vibe:"Living life one payday at a time",description:"Your income and spending are in a constant dance, sometimes a little too close for comfort. You make it work, but there is no buffer.",
genPlaybook:p=>{const sr=p.metrics.savingsRate;const surplus=p.monthly.surplus;const topCat=p.categories[0];return{narrative:`Savings rate: ${sr}%.${surplus>0?' Roughly \u00a3'+surplus+'/month left over':' Spending almost everything you earn'}. Biggest outgoing: ${topCat?topCat.name+' (\u00a3'+topCat.total+'/mo)':'hard to pin down'}.${p.monthly.foodDelivery>50?' Food delivery alone: \u00a3'+p.monthly.foodDelivery+'/month.':''} One unexpected bill could tip the balance.`,strategies:[{title:'Build a \u00a3500 buffer first',text:'Before optimising anything else, get \u00a3500 into a separate account. That is your shock absorber. Even \u00a3'+Math.max(20,Math.round(surplus>0?surplus*0.5:30))+'/month gets you there.'},{title:'Find the single biggest leak',text:topCat?'Your top category is '+topCat.name+' at \u00a3'+topCat.total+'/mo. A 20% reduction there frees up \u00a3'+Math.round(topCat.total*0.2)+'/month.':'Identify which category is eating the most and target a 20% reduction.'},{title:'Separate spending money',text:'On payday, move bills + target savings out immediately. What remains is your actual spending money. This stops the slow bleed.'}]}},triggers:p=>p.metrics.savingsRate<5&&p.metrics.savingsRate>=-10},

debt_juggler:{name:'The Debt Juggler',emoji:'ðŸŽª',color:'#E8A872',vibe:"Keeping all the balls in the air",description:"Credit cards, BNPL, maybe a loan â€” you are managing multiple financial obligations with precision. The question is whether you are juggling or drowning.",
genPlaybook:p=>{const dp=p.debtPayments||[];const total=p.monthly.debtPayments;const names=dp.slice(0,3).map(d=>d.merchant).join(', ');const pct=p.monthly.income>0?Math.round((total/p.monthly.income)*100):0;const smallest=dp.sort((a,b)=>a.averageAmount-b.averageAmount)[0];return{narrative:`${dp.length} debt obligation${dp.length>1?'s':''}: ${names}. \u00a3${total}/month (\u00a3${total*12}/year) \u2014 ${pct}% of income.${p.metrics.bnplCount>0?' '+p.metrics.bnplCount+' active BNPL account'+(p.metrics.bnplCount>1?'s':'')+'.':', '}`,strategies:[{title:'Snowball: clear '+((smallest||{}).merchant||'smallest')+' first',text:smallest?'At \u00a3'+smallest.averageAmount+'/month, this clears fastest. Once done, redirect that \u00a3'+smallest.averageAmount+' to the next debt. Momentum builds.':'Clear the smallest debt first for psychological momentum, then redirect payments.'},{title:'Stop the BNPL cycle',text:p.metrics.bnplCount>0?'You have '+p.metrics.bnplCount+' BNPL account'+(p.metrics.bnplCount>1?'s':'')+'. Delete the apps. BNPL makes spending invisible until the bill arrives.':'Avoid adding new debt while paying off existing obligations.'},{title:'Consolidation check',text:pct>20?'At '+pct+'% of income going to debt, a consolidation loan at a lower rate could reduce your monthly outgoing and simplify to one payment.':'Your debt-to-income ratio is manageable. Focus on accelerating the smallest balance.'}]}},triggers:p=>p.metrics.debtAccountCount>=3||(p.monthly.debtPayments>0&&p.monthly.debtPayments>p.monthly.income*0.15)},

impulse_surfer:{name:'The Impulse Surfer',emoji:'âš¡',color:'#E8D572',vibe:"See it. Want it. Tap. Done.",description:"Your spending spikes unpredictably â€” a calm week followed by a burst. Shopping is emotional, spontaneous, and satisfying in the moment.",
genPlaybook:p=>{const shop=p.monthly.shopping||0;const topShop=p.topMerchants?.find(m=>['Amazon','ASOS','Zara','IKEA'].includes(m.merchant));return{narrative:`\u00a3${shop}/month on shopping (\u00a3${shop*12}/year).${topShop?' '+topShop.merchant+' alone: '+topShop.count+' transactions.':''} The pattern is reactive, not planned \u2014 shopping as a response to how you feel.`,strategies:[{title:'Add friction',text:'Remove saved card details from '+(topShop?topShop.merchant:'your top retailer')+'. Having to type your card number adds a 30-second pause that kills most impulse buys.'},{title:'The 24-hour screenshot rule',text:'See something you want? Screenshot it. If you still want it tomorrow, buy it. This eliminates \u00a3'+Math.round(shop*0.2)+'/mo in regret purchases.'},{title:'Redirect the dopamine',text:'Shopping gives a hit. So does moving money to savings. Set up a \u00a3'+Math.min(50,Math.round(shop*0.15))+' auto-transfer on days you typically shop \u2014 get the same satisfaction from building, not spending.'}]}},triggers:p=>{const shop=p.monthly.shopping||0;const topShop=p.topMerchants?.filter(m=>['Amazon','ASOS','Zara','IKEA'].includes(m.merchant))||[];const highFreq=topShop.some(m=>m.count>6);return shop>120&&(highFreq||shop>200)}},

comfort_spender:{name:'The Comfort Spender',emoji:'â˜•',color:'#C8A872',vibe:"A little treat never hurt anyone... right?",description:"Coffee runs, meals out, small luxuries â€” your spending is death by a thousand cuts. Each purchase is tiny, but they add up to a lifestyle.",
genPlaybook:p=>{const eat=p.monthly.eatingOut||0;const fd=p.monthly.foodDelivery||0;const groc=p.monthly.groceries||0;const coffeeMerch=p.topMerchants?.filter(m=>['Starbucks','Costa','Pret','Greggs','Caffe Nero'].includes(m.merchant))||[];const coffeeMonthly=Math.round(coffeeMerch.reduce((s,m)=>s+m.total,0)/Math.max(1,p.monthSpan));return{narrative:`\u00a3${eat}/month eating out${coffeeMonthly>0?' (including ~\u00a3'+coffeeMonthly+' on coffee/quick bites)':''}${fd>30?', plus \u00a3'+fd+'/month on delivery':''}. Food-related total: \u00a3${eat+fd+groc}/month (\u00a3${(eat+fd+groc)*12}/year). Frequent, small transactions that feel harmless but form your biggest category.`,strategies:[{title:'Keep the ritual, cut the cost',text:coffeeMonthly>15?'Make coffee at home 3 days a week. Keep your '+coffeeMerch[0]?.merchant+' habit for the other days. Saves ~\u00a3'+Math.round(coffeeMonthly*0.5)+'/month.':'Bring lunch 2 days a week. Keep eating out for the social days.'},{title:'Set a treats budget',text:'Give yourself \u00a3'+Math.round((eat+fd)*0.7)+'/month for eating out and delivery \u2014 guilt-free. Once it is gone, you cook. This cuts \u00a3'+Math.round((eat+fd)*0.3)+'/month without willpower.'},{title:'Swap, do not stop',text:'Replace 2 Deliveroo orders with a nice home-cooked meal you actually enjoy. The goal is not deprivation \u2014 it is finding comfort that costs less.'}]}},triggers:p=>{const eat=p.monthly.eatingOut||0;const coffeeMerch=p.topMerchants?.filter(m=>['Starbucks','Costa','Pret','Greggs'].includes(m.merchant))||[];return eat>100||coffeeMerch.length>=2}},

side_hustler:{name:'The Side Hustler',emoji:'ðŸ’°',color:'#72E8D5',vibe:"Multiple income streams, one ambitious brain",description:"You have income coming from more than one place. Whether it is freelancing, selling, or investing â€” you understand that one salary is a single point of failure.",
genPlaybook:p=>{const inc=p.monthly.income;const sr=p.metrics.savingsRate;return{narrative:`Monthly income: \u00a3${inc} from multiple sources.${sr>15?' Saving '+sr+'% \u2014 real financial awareness.':' Savings rate: '+sr+'% \u2014 the hustle is funding lifestyle, not reserves.'} ${p.monthly.subscriptions>50?'\u00a3'+p.monthly.subscriptions+'/month in tools and subscriptions \u2014 the cost of doing business.':'Overheads are lean.'}`,strategies:[{title:'Separate business from personal',text:'Open a second account for side income. Pay yourself a fixed amount monthly. Let the rest accumulate for tax, investment, or growth.'},{title:sr<15?'Save the side income':'Scale what works',text:sr<15?'Your main salary covers lifestyle. Redirect 100% of side income to savings for 3 months \u2014 that is \u00a3'+Math.round((inc-p.monthly.spending)*3)+' in reserve.':'Double down on the highest-returning income stream. Invest time where the \u00a3/hour is highest.'},{title:'Tax efficiency',text:'Multiple income streams = tax complexity. Make sure you are using your ISA allowance (\u00a320k/year) and claiming allowable expenses.'}]}},triggers:p=>{const incTxs=p.incomeStreams||0;return incTxs>=2&&p.monthly.income>0}},

balanced_realist:{name:'The Balanced Realist',emoji:'âš–ï¸',color:'#72B0E8',vibe:"Boring is your financial superpower",description:"No extreme patterns here â€” just steady, sensible money management. You will not make the news, but you will make retirement.",
genPlaybook:p=>{const sr=p.metrics.savingsRate;const surplus=p.monthly.surplus;return{narrative:`Saving ${sr}% (\u00a3${surplus}/month). Spending spread across categories without extremes.${p.metrics.debtAccountCount===0?' Debt-free.':' '+p.metrics.debtAccountCount+' debt payment'+(p.metrics.debtAccountCount>1?'s':'')+' but proportionate.'} This is quiet financial confidence. The risk is complacency.`,strategies:[{title:'Push from fine to great',text:'You are stable at '+sr+'%. The next level is '+Math.min(sr+5,30)+'%. That is \u00a3'+Math.round(p.monthly.income*0.05)+'/month more \u2014 invest it, do not save it.'},{title:'Optimise, do not cut',text:'You do not need to spend less. You need your money working harder. Check your savings rate, switch providers, and make sure idle cash is earning interest.'},{title:'Set one ambitious goal',text:'Stability is your base. Now pick one thing: a house deposit, early retirement target, or investment milestone. Give your discipline a destination.'}]}},triggers:p=>true}
};

// TRAITS
const SUB_TRAITS=[
{id:'delivery',emoji:'ðŸ•',text:'Delivery-dependent',check:p=>p.monthly.foodDelivery>80},
{id:'credit',emoji:'ðŸ’³',text:'Credit-active',check:p=>p.metrics.creditCardCount>=2},
{id:'bnpl',emoji:'ðŸ’¸',text:'BNPL user',check:p=>p.metrics.bnplCount>=1},
{id:'commuter',emoji:'ðŸš‚',text:'Commuter',check:p=>p.monthly.transport>150},
{id:'streaming',emoji:'ðŸ“º',text:'Streaming heavy',check:p=>p.metrics.streamingCount>=3},
{id:'techsub',emoji:'ðŸ’»',text:'Tech subscriber',check:p=>p.subscriptions&&p.subscriptions.some(s=>['ChatGPT','Claude','Midjourney','Cursor','Lovable'].includes(s.merchant))},
{id:'coffee',emoji:'â˜•',text:'Coffee regular',check:p=>p.topMerchants&&p.topMerchants.some(m=>['Starbucks','Costa','Pret'].includes(m.merchant)&&m.count>8)},
{id:'impulse',emoji:'âš¡',text:'Impulse buyer',check:p=>(p.monthly.shopping||0)>150},
{id:'foodie',emoji:'ðŸ½ï¸',text:'Foodie',check:p=>((p.monthly.eatingOut||0)+p.monthly.foodDelivery)>150},
{id:'saver',emoji:'ðŸŒ±',text:'Active saver',check:p=>p.metrics.savingsRate>25},
{id:'grocery',emoji:'ðŸ›’',text:'Home cook',check:p=>(p.monthly.groceries||0)>(p.monthly.foodDelivery||0)*2&&(p.monthly.groceries||0)>100}
];

// RULES
const STRENGTH_RULES=[
{text:'Strong savings discipline',check:p=>p.metrics.savingsRate>15},
{text:'Debt-free lifestyle',check:p=>p.metrics.debtAccountCount===0},
{text:'Keeps subscriptions lean',check:p=>p.metrics.subscriptionCount<=4},
{text:'Conscious grocery shopper',check:p=>(p.monthly.groceries||0)>(p.monthly.foodDelivery||0)*1.5},
{text:'Resists delivery temptation',check:p=>(p.monthly.foodDelivery||0)<UK_BENCHMARKS.foodDelivery}
];

const BLINDSPOT_RULES=[
{text:'Subscription creep risk',detail:'Multiple services adding up silently',check:p=>p.metrics.subscriptionCount>=6},
{text:'Delivery dependency',detail:'Convenience premium eating into savings',check:p=>(p.monthly.foodDelivery||0)>100},
{text:'Multiple BNPL accounts',detail:'Buy-now-pay-later spreading thin',check:p=>p.metrics.bnplCount>=2},
{text:'Credit card stacking',detail:'Managing multiple credit lines',check:p=>p.metrics.creditCardCount>=3},
{text:'Savings rate below target',detail:'Under the recommended 20%',check:p=>p.metrics.savingsRate<10&&p.metrics.savingsRate>=0}
];


// PDF TEXT EXTRACTION
const extractPDFText=async(file)=>{
const arrayBuffer=await file.arrayBuffer();
const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
const maxPages=Math.min(pdf.numPages,30);
const lines=[];
for(let i=1;i<=maxPages;i++){
const page=await pdf.getPage(i);
const content=await page.getTextContent();
const lineMap={};
content.items.forEach(item=>{
const y=Math.round(item.transform[5]);
if(!lineMap[y])lineMap[y]=[];
lineMap[y].push({x:item.transform[4],text:item.str});
});
const sortedYs=Object.keys(lineMap).map(Number).sort((a,b)=>b-a);
sortedYs.forEach(y=>{
const items=lineMap[y].sort((a,b)=>a.x-b.x);
const line=items.map(it=>it.text).join('  ');
if(line.trim())lines.push(line);
});
}
return lines.join('\n');
};


// CLAUDE API HELPER â€” calls serverless backend, never exposes API key in browser
const callClaude=async(prompt,maxTokens=2048)=>{
try{
const resp=await fetch(CLAUDE_CONFIG.endpoint,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({prompt,max_tokens:maxTokens})
});
if(!resp.ok)return null;
const data=await resp.json();
return data.text||null;
}catch(e){return null}
};


// ENRICHMENT ENGINE
class EnrichmentEngine{
async enrich(rawTexts,onStatus){
const allTx=[];

// Step 1: Parse all texts
onStatus?.('Parsing your files...');
for(const text of rawTexts){
let txs=this.parseCSV(text);
if(txs.length<3&&text.length>100){
// Likely a PDF or poorly formatted file â€” use Claude to extract structured data
onStatus?.('Extracting transactions...');
const structured=await this.structureWithClaude(text);
if(structured){const parsed=this.parseCSV(structured);if(parsed.length>txs.length)txs=parsed}
}
allTx.push(...txs);
}

allTx.sort((a,b)=>(a.date||0)-(b.date||0));

// Filter to last 4 months for accurate behavioral analysis
const _datedAll=allTx.filter(tx=>tx.date);
if(_datedAll.length>=2){const _latest=new Date(Math.max(..._datedAll.map(tx=>tx.date.getTime())));const _cutoff=new Date(_latest);_cutoff.setMonth(_cutoff.getMonth()-4);const _keep=allTx.filter(tx=>!tx.date||tx.date>=_cutoff);if(_keep.length>=5){allTx.length=0;allTx.push(..._keep)}}

// Step 2: Local merchant identification (first pass)
onStatus?.('Identifying merchants...');
let enriched=allTx.map(tx=>this.enrichTransaction(tx));

// Step 3: Send all transactions to Claude for categorisation
onStatus?.('Categorising data...');
enriched=await this.verifyWithClaude(enriched,onStatus);

// Step 4: Build profile
onStatus?.('Building your profile...');
const recurring=this.detectRecurring(enriched);
const profile=this.buildProfile(enriched,recurring);
const archetype=this.determineArchetype(profile);
const traits=SUB_TRAITS.filter(t=>{try{return t.check(profile)}catch{return false}}).slice(0,4);
const strengths=STRENGTH_RULES.filter(r=>{try{return r.check(profile)}catch{return false}}).slice(0,3).map(r=>r.text);
const blindSpots=BLINDSPOT_RULES.filter(r=>{try{return r.check(profile)}catch{return false}}).slice(0,3);
const peerComparison=this.calcPeerComparison(profile);
const insights=this.genInsights(profile);
const potentialSavings=this.calcSavings(profile);

// Step 5: Decision intelligence
onStatus?.('Analysing your decisions...');
const behavioralPatterns=this.detectBehavioralPatterns(enriched);
const decisionScore=this.calcDecisionScore(profile);
const decisionStack=this.genDecisionStack(profile,recurring,behavioralPatterns);
const compoundCosts=this.calcCompoundCost(profile);
const playbook=archetype.genPlaybook?archetype.genPlaybook(profile):null;

return{profile,archetype,traits,strengths,blindSpots,peerComparison,insights,potentialSavings,decisionScore,decisionStack,behavioralPatterns,compoundCosts,playbook,subscriptions:profile.subscriptions,enrichedTransactions:enriched};
}

// Use Claude to extract CSV from unstructured text (e.g. PDF bank statements)
async structureWithClaude(rawText){
const trimmed=rawText.substring(0,12000);
const prompt=`You are a UK bank statement parser. Extract all transactions from this bank statement text and return them as CSV.\n\nRules:\n- Headers must be: Date,Description,Amount\n- Date format: DD/MM/YYYY\n- Amount: negative for debits/spending, positive for credits/income\n- Only return the CSV data, no explanation or markdown\n- Include every transaction you can identify\n\nBank statement text:\n${trimmed}`;
const result=await callClaude(prompt,4096);
return result;
}

// Send all spending transactions to Claude in parallel batches for categorisation
async verifyWithClaude(enrichedTxs,onStatus){
const toVerify=enrichedTxs.filter(tx=>!tx.isIncome&&!tx.isTransfer&&!tx.isRefund&&Math.abs(tx.amount)>0);
if(toVerify.length===0)return enrichedTxs;

const BATCH_SIZE=50;
const batches=[];
for(let i=0;i<toVerify.length;i+=BATCH_SIZE)batches.push(toVerify.slice(i,i+BATCH_SIZE));
onStatus?.('Categorising '+toVerify.length+' transactions...');

// Map common Claude category variants to our canonical names
const VALID_CATEGORIES=new Set(['Groceries','Food Delivery','Eating Out','Subscriptions','Debt Payments','Bills','Transport','Shopping','Entertainment','Health','Travel','Charity','Education','Savings','Refund','Other']);
const CATEGORY_ALIASES={'Dining':'Eating Out','Dining Out':'Eating Out','Restaurants':'Eating Out','Restaurant':'Eating Out','Cafes':'Eating Out','Cafe':'Eating Out','Grocery':'Groceries','Supermarket':'Groceries','Supermarkets':'Groceries','Delivery':'Food Delivery','Takeaway':'Food Delivery','Takeaways':'Food Delivery','Subscription':'Subscriptions','Debt':'Debt Payments','Debt Payment':'Debt Payments','Loan':'Debt Payments','Loans':'Debt Payments','Bill':'Bills','Utilities':'Bills','Utility':'Bills','Telecom':'Bills','Mobile':'Bills','Transportation':'Transport','Taxi':'Transport','Fuel':'Transport','Petrol':'Transport','Retail':'Shopping','Clothing':'Shopping','Clothes':'Shopping','Fashion':'Shopping','Leisure':'Entertainment','Gaming':'Entertainment','Games':'Entertainment','Fitness':'Health','Gym':'Health','Medical':'Health','Healthcare':'Health','Wellness':'Health','Flights':'Travel','Hotels':'Travel','Holiday':'Travel','Holidays':'Travel','Accommodation':'Travel','Donations':'Charity','Donation':'Charity','Investment':'Savings','Investments':'Savings','Transfer':'Transfers','Transfers':'Transfers','Income':'Income'};
const normaliseCategory=c=>{if(!c)return'Other';if(VALID_CATEGORIES.has(c))return c;return CATEGORY_ALIASES[c]||'Other'};
const processBatch=async(batch,retries=2)=>{
const txList=batch.map((tx,i)=>`${i+1}. "${tx.description}" Â£${Math.abs(tx.amount).toFixed(2)}`).join('\n');
const prompt=`Categorise these UK bank transactions. Return JSON array only.
Each object: {"index":N,"merchant":"Name","category":"Cat","isSubscription":false}
Categories: Groceries, Food Delivery, Eating Out, Subscriptions (isSubscription=true), Debt Payments, Bills, Transport, Shopping, Entertainment, Health, Travel, Charity, Education, Savings, Other
Groceries=supermarkets. Food Delivery=Deliveroo/UberEats/JustEat. Eating Out=restaurants/cafes/pubs. Travel=flights/hotels/holidays. Charity=donations/giving. Education=courses/tuition/student loans. Savings=investments/ISAs/trading platforms.
Transactions:
${txList}`;
for(let attempt=0;attempt<=retries;attempt++){
try{
const result=await callClaude(prompt,4000);
if(!result){if(attempt<retries){await new Promise(r=>setTimeout(r,1000*(attempt+1)));continue}return}
const jsonMatch=result.match(/\[[\s\S]*\]/);
if(jsonMatch){
const cats=JSON.parse(jsonMatch[0]);
cats.forEach(cat=>{
const idx=(cat.index||0)-1;
if(idx>=0&&idx<batch.length){
const tx=batch[idx];
const claudeCat=normaliseCategory(cat.category);
tx._claudeVerified=true;
// Always let Claude refine categorisation for better first-load accuracy
if(cat.merchant){const nm=cat.merchant.trim();if(tx.merchant==='Unknown'||tx.confidence!=='high')tx.merchant=nm.split(/\s+/).map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(' ')}
// Use Claude's category if it's not 'Other' or local was also 'Other'
if(claudeCat!=='Other'||tx.category==='Other'){
tx.category=claudeCat;
if(typeof cat.isSubscription==='boolean')tx.isSubscription=cat.isSubscription;
tx.isDebt=claudeCat==='Debt Payments';
tx.isIncome=claudeCat==='Income';
tx.isRefund=claudeCat==='Refund';
tx.isSavings=claudeCat==='Savings';
tx.isTransfer=claudeCat==='Transfers'||claudeCat==='Savings';
}
// Preserve subcategory for debt if Claude identified it
if(tx.category==='Debt Payments'&&!tx.subcategory){
const desc=tx.descNorm||'';
if(['klarna','clearpay','afterpay','zilch','laybuy'].some(b=>desc.includes(b)))tx.subcategory='BNPL';
else if(['amex','american express','barclaycard','capital one','capitalone','mbna','aqua','vanquis'].some(b=>desc.includes(b)))tx.subcategory='Credit Card';
}
}
});
return;
}
}catch(e){if(attempt<retries){await new Promise(r=>setTimeout(r,1000*(attempt+1)));continue}}
}
};

// Process in groups of 3 with retry to avoid rate limits
const CONCURRENCY=3;
for(let g=0;g<batches.length;g+=CONCURRENCY){
const group=batches.slice(g,g+CONCURRENCY);
await Promise.all(group.map(async b=>{
await processBatch(b);
}));
onStatus?.('Categorised '+(Math.min(g+CONCURRENCY,batches.length)*BATCH_SIZE)+' of '+toVerify.length+'...');
}
// Second pass: retry transactions Claude missed or left as 'Other'
const unverified=toVerify.filter(tx=>!tx._claudeVerified||tx.category==='Other');
if(unverified.length>0&&unverified.length<=100){
onStatus?.('Verifying '+unverified.length+' remaining transactions...');
const retryBatches=[];for(let i=0;i<unverified.length;i+=BATCH_SIZE)retryBatches.push(unverified.slice(i,i+BATCH_SIZE));
for(const batch of retryBatches){await processBatch(batch,1)}
}
return enrichedTxs;
}

parseCSV(raw){
const lines=raw.trim().split('\n'),txs=[];
let headers=[],start=0;
for(let i=0;i<Math.min(10,lines.length);i++){
const l=lines[i].toLowerCase();
if(['date','description','amount','debit','credit'].some(k=>l.includes(k))){
headers=lines[i].split(',').map(h=>h.toLowerCase().replace(/"/g,'').trim());
start=i+1;break;
}}
const di=headers.findIndex(h=>h.includes('date'));
const desc=headers.findIndex(h=>['description','transaction','details','narrative','merchant','name'].some(k=>h.includes(k)));
const ai=headers.findIndex(h=>h.includes('amount'));
const deb=headers.findIndex(h=>['debit','out','money out'].some(k=>h.includes(k)));
const cred=headers.findIndex(h=>['credit','in','money in'].some(k=>h.includes(k)));

for(let i=start;i<lines.length;i++){
if(!lines[i].trim())continue;
const cols=this.parseLine(lines[i]);
if(cols.length<2)continue;
let amt=0;
if(ai>=0&&cols[ai])amt=parseFloat(cols[ai].replace(/[^0-9.-]/g,''))||0;
else{
const db=deb>=0?parseFloat((cols[deb]||'').replace(/[^0-9.-]/g,''))||0:0;
const cr=cred>=0?parseFloat((cols[cred]||'').replace(/[^0-9.-]/g,''))||0:0;
amt=cr-db;if(db>0&&cr===0)amt=-db;
}
const d=cols[di>=0?di:0]||'';
const tx={date:this.parseDate(d),description:cols[desc>=0?desc:1]||'',descNorm:this.norm(cols[desc>=0?desc:1]||''),amount:amt};
if(tx.description.length>1)txs.push(tx);
}
return txs;
}

parseLine(line){const cols=[];let cur='',inQ=false;for(const c of line){if(c==='"')inQ=!inQ;else if(c===','&&!inQ){cols.push(cur.trim());cur=''}else cur+=c}cols.push(cur.trim());return cols.map(c=>c.replace(/^"|"$/g,''))}
parseDate(s){if(!s)return null;
// DD/MM/YYYY or DD-MM-YYYY
let m=s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);if(m)return new Date(m[3],m[2]-1,m[1]);
// YYYY-MM-DD or YYYY/MM/DD
m=s.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);if(m)return new Date(m[1],m[2]-1,m[3]);
// DD Mon YYYY (e.g. "15 Jan 2025")
m=s.match(/(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\w*\s+(\d{4})/i);if(m){const months={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};return new Date(m[3],months[m[2].toLowerCase().slice(0,3)],m[1])}
const d=new Date(s);return isNaN(d)?null:d}
norm(d){return d.toLowerCase().replace(/[^\w\s]/g,' ').replace(/\d{4,}/g,'').replace(/\s+/g,' ').trim()}

// Detect likely person-to-person transfers (names like "JOHN SMITH", "J SMITH") that aren't merchants
_isLikelyPersonName(merchant){
if(!merchant||merchant.length<3)return false;
const m=merchant.toLowerCase();
// Skip known merchant names
if(this._sortedPatterns&&this._sortedPatterns.some(([,data])=>data.name.toLowerCase()===m))return false;
// Common transfer indicators
if(m.includes('transfer')||m.includes('faster payment')||m.includes('standing order'))return true;
// Pattern: 1-2 short words, all letters, no known brand indicators
const words=m.split(/\s+/).filter(w=>w.length>0);
if(words.length>=1&&words.length<=3&&words.every(w=>/^[a-z'-]+$/.test(w))&&!words.some(w=>w.length>12)){
// Likely a person name if it's short alphabetic words with no numbers or special chars
const brandIndicators=['ltd','inc','plc','limited','corp','llp','store','shop','market','cafe','restaurant','gym','club','online','digital','mobile','energy','water','insurance','finance','payroll','services','solutions','group','holdings','accounts','consulting','associates','partners','recruitment','staffing','agency','council','government','bacs','pension'];
if(!words.some(w=>brandIndicators.includes(w)))return true;
}
return false;
}

enrichTransaction(tx){
const n=tx.descNorm;
let lookup=null;let confidence='low';
// Sort patterns by length descending so "uber eats" matches before "uber", "amazon prime video" before "amazon"
if(!this._sortedPatterns)this._sortedPatterns=Object.entries(MERCHANT_DB).sort((a,b)=>b[0].length-a[0].length);
for(const[pattern,data]of this._sortedPatterns){if(data._wordBound){const p=pattern.trim();const idx=n.indexOf(p);if(idx>=0&&(idx===0||n[idx-1]===' ')&&(idx+p.length>=n.length||n[idx+p.length]===' ')){lookup=data;confidence='high';break}}else if(n.includes(pattern)){lookup=data;confidence='high';break}}
if(!lookup){
const companyPattern=/\b(ltd|plc|limited|inc|corp|llp|group|holdings)\b/;
const isCompany=companyPattern.test(n);
const words=isCompany?n.split(' ').filter(w=>w.length>0):n.split(' ').filter(w=>w.length>2);
lookup={name:words.slice(0,4).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ')||'Unknown',category:'Other',isSubscription:false};
}
const isIncomeCategory=lookup.category==='Income';
const isRefund=lookup.category==='Refund';
const isSavings=lookup.category==='Savings';
const isLargeCredit=tx.amount>1000&&lookup.category==='Other';
const isCompanyCredit=tx.amount>0&&lookup.category==='Other'&&/\b(ltd|plc|limited|inc|corp|llp|group|holdings)\b/.test(n);
return{...tx,merchant:lookup.name,category:(isLargeCredit||isCompanyCredit)?'Income':lookup.category,subcategory:lookup.subcategory||'',isSubscription:lookup.isSubscription,isIncome:isIncomeCategory||isLargeCredit||isCompanyCredit,isRefund,isSavings,isTransfer:lookup.category==='Transfers'||isSavings,isDebt:lookup.category==='Debt Payments',confidence};
}

detectRecurring(txs){
const byM={};
txs.forEach(tx=>{if(!tx.merchant||tx.isIncome||tx.isTransfer||tx.isRefund)return;if(this._isLikelyPersonName(tx.merchant))return;if(!byM[tx.merchant])byM[tx.merchant]=[];byM[tx.merchant].push(tx)});
const recurring=[];
for(const[merchant,list]of Object.entries(byM)){
if(list.length<2)continue;
list.sort((a,b)=>(a.date||0)-(b.date||0));
const intervals=[];
for(let i=1;i<list.length;i++){if(list[i].date&&list[i-1].date){const days=Math.round((list[i].date-list[i-1].date)/(1000*60*60*24));if(days>0)intervals.push(days)}}
if(!intervals.length)continue;
const avg=intervals.reduce((a,b)=>a+b,0)/intervals.length;
const variance=intervals.reduce((s,i)=>s+Math.pow(i-avg,2),0)/intervals.length;
if(Math.sqrt(variance)<avg*0.4&&avg>5){
const freq=avg<10?'weekly':avg<45?'monthly':'annual';
const amounts=list.map(t=>Math.abs(t.amount));
const avgAmt=amounts.reduce((a,b)=>a+b,0)/amounts.length;
recurring.push({merchant,frequency:freq,averageAmount:Math.round(avgAmt*100)/100,category:list[0].category,subcategory:list[0].subcategory,isSubscription:list[0].isSubscription,isDebt:list[0].isDebt});
list.forEach(tx=>tx.isRecurring=true);
}}
return recurring.sort((a,b)=>b.averageAmount-a.averageAmount);
}

buildProfile(txs,recurring){
const income=txs.filter(tx=>tx.isIncome&&!tx.isRefund&&tx.amount>0);
const spending=txs.filter(tx=>tx.amount<0&&!tx.isTransfer&&!tx.isRefund);
const byCat={};
spending.forEach(tx=>{const k=tx.category||'Other';if(!byCat[k])byCat[k]={total:0,count:0};byCat[k].total+=Math.abs(tx.amount);byCat[k].count++});
const totalIncome=income.reduce((s,tx)=>s+tx.amount,0);
const totalSpending=spending.reduce((s,tx)=>s+Math.abs(tx.amount),0);
const surplus=totalIncome-totalSpending;

// Calculate month span from transaction dates for accurate monthly averages
const dated=txs.filter(tx=>tx.date);
let months=1;
if(dated.length>=2){const dates=dated.map(tx=>tx.date.getTime());const earliest=Math.min(...dates);const latest=Math.max(...dates);months=Math.max(1,(latest-earliest)/(1000*60*60*24*30.44))||1}
const mo=m=>Math.round(m/months);

const subs=recurring.filter(r=>r.isSubscription);
const subTotal=subs.reduce((s,r)=>s+r.averageAmount,0);
const debtPay=recurring.filter(r=>r.isDebt);
const debtTotal=debtPay.reduce((s,r)=>s+r.averageAmount,0);
const creditCards=debtPay.filter(r=>r.subcategory==='Credit Card');
const bnpl=debtPay.filter(r=>r.subcategory==='BNPL');
const streaming=subs.filter(r=>['Netflix','Spotify','Disney+','Prime Video','Apple TV+','NOW TV','YouTube Premium'].includes(r.merchant));

const categories=Object.entries(byCat).map(([name,data])=>({name,total:mo(data.total),count:data.count})).sort((a,b)=>b.total-a.total);
const byMerch={};
spending.forEach(tx=>{if(!tx.merchant)return;if(this._isLikelyPersonName(tx.merchant))return;if(!byMerch[tx.merchant])byMerch[tx.merchant]={total:0,count:0};byMerch[tx.merchant].total+=Math.abs(tx.amount);byMerch[tx.merchant].count++});
const topMerchants=Object.entries(byMerch).map(([merchant,d])=>({merchant,total:Math.round(d.total),count:d.count})).sort((a,b)=>b.total-a.total).slice(0,10);

// Income analysis â€” find primary income source carefully
const incomeBySource={};
const salaryKeywords=['salary','wages','payroll','pay from','monthly pay','net pay','direct deposit'];
income.forEach(tx=>{const n=tx.descNorm||'';if(this._isLikelyPersonName(tx.merchant))return;
const isSalary=salaryKeywords.some(p=>n.includes(p));
const key=isSalary?'_salary_':n.split(' ').filter(w=>w.length>2).slice(0,2).join(' ')||'unknown';
if(!incomeBySource[key])incomeBySource[key]={total:0,count:0,amounts:[],dates:[],merchant:isSalary?'Salary/Wages':(tx.merchant||key),isSalary};
incomeBySource[key].total+=tx.amount;incomeBySource[key].count++;incomeBySource[key].amounts.push(tx.amount);if(tx.date)incomeBySource[key].dates.push(tx.date)});
// Also detect large regular credits (>Â£500, appearing 2+ times monthly) as missed income
const largeCreds=txs.filter(tx=>tx.amount>500&&!tx.isIncome&&!tx.isRefund&&!tx.isTransfer&&tx.date);
const credByKey={};
largeCreds.forEach(tx=>{const key=tx.descNorm?.split(' ').filter(w=>w.length>2).slice(0,2).join(' ')||'unknown';if(!credByKey[key])credByKey[key]={total:0,count:0,dates:[],merchant:tx.merchant||key};credByKey[key].total+=tx.amount;credByKey[key].count++;credByKey[key].dates.push(tx.date)});
for(const[key,src] of Object.entries(credByKey)){
if(src.count>=2&&!incomeBySource[key]){src.dates.sort((a,b)=>a-b);const ints=[];for(let i=1;i<src.dates.length;i++){const d=Math.round((src.dates[i]-src.dates[i-1])/(1000*60*60*24));if(d>0)ints.push(d)}
if(ints.length>0){const avg=ints.reduce((a,b)=>a+b,0)/ints.length;if(avg>20&&avg<45){incomeBySource[key]={...src,amounts:largeCreds.filter(tx=>(tx.descNorm?.split(' ').filter(w=>w.length>2).slice(0,2).join(' ')||'unknown')===key).map(tx=>tx.amount),isSalary:false}}}}}
const _calcFreq=(dates)=>{if(dates.length<2)return'irregular';dates.sort((a,b)=>a-b);const ints=[];for(let i=1;i<dates.length;i++){const d=Math.round((dates[i]-dates[i-1])/(1000*60*60*24));if(d>0)ints.push(d)};if(!ints.length)return'irregular';const avg=ints.reduce((a,b)=>a+b,0)/ints.length;return avg<10?'weekly':avg<18?'fortnightly':avg<45?'monthly':'irregular'};
const incomeSources=Object.values(incomeBySource).map(src=>{
const frequency=_calcFreq(src.dates);
const avgAmount=Math.round(src.total/src.count);
return{source:src.merchant,frequency,avgAmount,total:Math.round(src.total),count:src.count,monthly:mo(src.total),isPrimary:false,isSalary:src.isSalary||false}
}).sort((a,b)=>b.total-a.total);
// Mark primary income source â€” salary first, then largest regular source
if(incomeSources.length>0){const primary=incomeSources.find(s=>s.isSalary)||incomeSources.find(s=>s.frequency==='monthly'&&s.monthly>500)||incomeSources[0];if(primary){primary.isPrimary=true;primary.source=primary.isSalary?'Primary Income (Salary)':primary.source+' (Primary)'}}
const incomeStreams=incomeSources.length;

// Non-discretionary vs discretionary split
const nonDiscretionaryCats=['Bills','Groceries','Transport','Debt Payments','Education','Health'];
const nonDiscretionary={total:0,items:[]};
const discretionary={total:0,items:[]};
for(const[cat,data]of Object.entries(byCat)){
const monthly=mo(data.total);
if(nonDiscretionaryCats.includes(cat)||(cat==='Subscriptions')){nonDiscretionary.total+=monthly;nonDiscretionary.items.push({category:cat,monthly})}
else if(cat!=='Other'&&cat!=='Transfers'&&cat!=='Savings'&&cat!=='Refund'){discretionary.total+=monthly;discretionary.items.push({category:cat,monthly})}
}
// Add subscription + debt from recurring (more accurate than category totals)
const subMo=Math.round(subTotal);const debtMo=Math.round(debtTotal);
nonDiscretionary.items.sort((a,b)=>b.monthly-a.monthly);
discretionary.items.sort((a,b)=>b.monthly-a.monthly);
const leftToDecide=mo(totalIncome)-nonDiscretionary.total;

// Financial advisor suggestions for people in debt distress
const totalMonthlyNeeds=nonDiscretionary.total+discretionary.total;
const monthlyInc=mo(totalIncome);
const financialAdvisorTips=[];
if(debtPay.length>0&&monthlyInc>0&&monthlyInc<totalMonthlyNeeds){
const shortfall=totalMonthlyNeeds-monthlyInc;
financialAdvisorTips.push({type:'shortfall',title:'Your expenses exceed your income',text:'You are spending Â£'+shortfall+' more per month than you earn. This is unsustainable and will deepen debt over time.'});
if(discretionary.total>100)financialAdvisorTips.push({type:'cut',title:'Reduce lifestyle spending first',text:'Your lifestyle spending is Â£'+discretionary.total+'/mo. Cutting this by 50% frees up Â£'+Math.round(discretionary.total*0.5)+'/mo toward essentials and debt.'});
if(debtPay.length>=2)financialAdvisorTips.push({type:'consolidate',title:'Consider debt consolidation',text:'You have '+debtPay.length+' debt payments totalling Â£'+Math.round(debtTotal)+'/mo. A consolidation loan at a lower rate could reduce monthly payments and simplify repayment.'});
financialAdvisorTips.push({type:'help',title:'Speak to a free debt advisor',text:'StepChange (0800 138 1111) and Citizens Advice offer free, confidential debt advice. They can negotiate with creditors and set up manageable repayment plans.'});
if(monthlyInc<nonDiscretionary.total)financialAdvisorTips.push({type:'crisis',title:'Priority bills first',text:'Your income doesn\'t cover non-negotiable costs. Focus on rent/mortgage, council tax, and energy first â€” these have the most serious consequences if missed. Contact creditors proactively.'});
}

return{
transactionCount:txs.length,monthSpan:months,
monthly:{income:mo(totalIncome),spending:mo(totalSpending),surplus:mo(surplus),subscriptions:Math.round(subTotal),debtPayments:Math.round(debtTotal),foodDelivery:mo(byCat['Food Delivery']?.total||0),shopping:mo(byCat['Shopping']?.total||0),entertainment:mo(byCat['Entertainment']?.total||0),groceries:mo(byCat['Groceries']?.total||0),transport:mo(byCat['Transport']?.total||0),eatingOut:mo(byCat['Eating Out']?.total||0),health:mo(byCat['Health']?.total||0),travel:mo(byCat['Travel']?.total||0),charity:mo(byCat['Charity']?.total||0),education:mo(byCat['Education']?.total||0)},
metrics:{savingsRate:totalIncome>0?Math.round((surplus/totalIncome)*100):(totalSpending>0?-100:0),subscriptionCount:subs.length,debtAccountCount:debtPay.length,creditCardCount:creditCards.length,bnplCount:bnpl.length,streamingCount:streaming.length},
// Spending trend: compare last 30 days vs overall monthly average
spendingTrend:this.calcSpendingTrend(spending,months),
// Income analysis
incomeSources,
// Non-discretionary vs discretionary
budgetReality:{nonDiscretionary,discretionary,leftToDecide},
financialAdvisorTips,
categories,topMerchants,recurring,subscriptions:subs,debtPayments:debtPay,incomeStreams
};
}

determineArchetype(p){
const order=['debt_juggler','quiet_builder','edge_walker','subscription_collector','impulse_surfer','convenience_seeker','comfort_spender','lifestyle_investor','side_hustler','balanced_realist'];
for(const k of order){try{if(ARCHETYPES[k].triggers(p))return{key:k,...ARCHETYPES[k]}}catch{}}
return{key:'balanced_realist',...ARCHETYPES.balanced_realist};
}

calcPeerComparison(p){
const m=p.monthly,mt=p.metrics,comps=[];
if(mt.subscriptionCount>0){const d=Math.round(((mt.subscriptionCount-UK_BENCHMARKS.subscriptions.count)/UK_BENCHMARKS.subscriptions.count)*100);comps.push({label:'Subscriptions',value:mt.subscriptionCount,unit:'',diff:d,isHigher:d>0})}
if(m.foodDelivery>0){const d=Math.round(((m.foodDelivery-UK_BENCHMARKS.foodDelivery)/UK_BENCHMARKS.foodDelivery)*100);comps.push({label:'Food Delivery',value:m.foodDelivery,unit:'Â£/mo',diff:d,isHigher:d>0})}
comps.push({label:'Savings Rate',value:mt.savingsRate,unit:'%',diff:mt.savingsRate-UK_BENCHMARKS.savingsRate,isHigher:mt.savingsRate>UK_BENCHMARKS.savingsRate,higherIsGood:true});
return comps.slice(0,4);
}

genInsights(p){
const ins=[],m=p.monthly;
if(p.subscriptions.length>0){ins.push({type:'subscriptions',text:'You have '+p.subscriptions.length+' active subscriptions totalling Â£'+m.subscriptions+'/mo (Â£'+(m.subscriptions*12)+'/yr): '+p.subscriptions.slice(0,4).map(s=>s.merchant+' Â£'+s.averageAmount).join(', ')+(p.subscriptions.length>4?' and '+(p.subscriptions.length-4)+' more':'')+'.'});}
if(p.debtPayments.length>0){ins.push({type:'debt',text:'You have '+p.debtPayments.length+' debt payment'+(p.debtPayments.length>1?'s':'')+' totalling Â£'+m.debtPayments+'/mo (Â£'+(m.debtPayments*12)+'/yr): '+p.debtPayments.slice(0,3).map(d=>d.merchant).join(', ')+'.'+(m.income>0?' That is '+Math.round((m.debtPayments/m.income)*100)+'% of your income.':'')});}
if(m.foodDelivery>50){ins.push({type:'delivery',text:'Food delivery is costing you Â£'+m.foodDelivery+'/month (Â£'+(m.foodDelivery*12)+'/yr). Cooking at home for just 2-3 of those orders per week would save roughly Â£'+Math.round(m.foodDelivery*0.4*12)+'/year.'});}
if((m.eatingOut||0)>80){ins.push({type:'eatingout',text:'You are spending Â£'+(m.eatingOut||0)+'/month eating out and on coffee (Â£'+((m.eatingOut||0)*12)+'/yr). Small daily purchases add up faster than most people realise.'});}
if((m.groceries||0)>0&&m.foodDelivery>0){const ratio=m.foodDelivery/(m.groceries||1);if(ratio>0.5){ins.push({type:'food',text:'Your food delivery spend (Â£'+m.foodDelivery+'/mo) is '+Math.round(ratio*100)+'% of your grocery spend (Â£'+(m.groceries||0)+'/mo). A healthier ratio would be under 25%.'})}}
if((m.shopping||0)>100){ins.push({type:'shopping',text:'Shopping accounts for Â£'+(m.shopping||0)+'/month (Â£'+((m.shopping||0)*12)+'/yr). '+(p.topMerchants?.find(m=>['Amazon','ASOS','Zara','IKEA','H&M','Primark','Shein','Boohoo'].includes(m.merchant))?'Your top retailer is '+p.topMerchants.find(m=>['Amazon','ASOS','Zara','IKEA','H&M','Primark','Shein','Boohoo'].includes(m.merchant)).merchant+'.':'')});}
if(p.spendingTrend){const t=p.spendingTrend;if(t.direction==='up'){ins.push({type:'trend',text:'Your spending in the last 30 days (Â£'+t.recentMonthTotal+') is '+t.pctChange+'% higher than your monthly average (Â£'+t.averageMonthly+'). Top categories this month: '+t.topRecentCategories.map(c=>c.name+' Â£'+c.total).join(', ')+'.'});}else if(t.direction==='down'){ins.push({type:'trend',text:'Good news â€” your spending in the last 30 days (Â£'+t.recentMonthTotal+') is '+Math.abs(t.pctChange)+'% lower than your monthly average (Â£'+t.averageMonthly+'). You are trending in the right direction.'});}}
return ins;
}

calcSpendingTrend(spending,months){
if(months<2||spending.length<10)return null;
// Anchor on the latest transaction date, not wall-clock time
const datedSpending=spending.filter(tx=>tx.date);
if(datedSpending.length<10)return null;
const latestDate=new Date(Math.max(...datedSpending.map(tx=>tx.date.getTime())));
const thirtyDaysAgo=new Date(latestDate.getTime()-30*24*60*60*1000);
const recent=datedSpending.filter(tx=>tx.date>=thirtyDaysAgo);
const recentTotal=recent.reduce((s,tx)=>s+Math.abs(tx.amount),0);
// Exclude the recent period from the baseline to get a true comparison
const olderTotal=datedSpending.filter(tx=>tx.date<thirtyDaysAgo).reduce((s,tx)=>s+Math.abs(tx.amount),0);
const olderMonths=Math.max(1,months-1);
const overallMonthly=olderTotal>0?olderTotal/olderMonths:spending.reduce((s,tx)=>s+Math.abs(tx.amount),0)/months;
if(overallMonthly===0)return null;
const pctChange=Math.round(((recentTotal-overallMonthly)/overallMonthly)*100);
// Categorise recent spending
const recentByCat={};
recent.forEach(tx=>{const k=tx.category||'Other';if(!recentByCat[k])recentByCat[k]=0;recentByCat[k]+=Math.abs(tx.amount)});
const topRecent=Object.entries(recentByCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([name,total])=>({name,total:Math.round(total)}));
return{recentMonthTotal:Math.round(recentTotal),averageMonthly:Math.round(overallMonthly),pctChange,direction:pctChange>10?'up':pctChange<-10?'down':'stable',topRecentCategories:topRecent};
}

calcSavings(p){
const m=p.monthly;const items=[];
const add=(cat,monthly,pct,tip)=>{const yearly=monthly*12;const saving=Math.round(yearly*pct);if(saving>0)items.push({category:cat,monthlySpend:monthly,yearlySpend:yearly,savingAmount:saving,savingPct:Math.round(pct*100),tip})};
add('Subscriptions',m.subscriptions,0.3,'cancel unused, downgrade plans');
add('Food Delivery',m.foodDelivery,0.4,'cook 2-3 more meals per week');
add('Debt Payments',m.debtPayments,0.15,'consolidate or accelerate repayment');
add('Eating Out',m.eatingOut||0,0.25,'1-2 fewer meals out per week');
add('Shopping',m.shopping||0,0.2,'try the 30-day rule');
const total=items.reduce((s,i)=>s+i.savingAmount,0);
return{total:Math.max(total,0),items};
}

// BEHAVIORAL PATTERNS â€” temporal intelligence from transaction timing
detectBehavioralPatterns(txs){
const patterns=[];
const spending=txs.filter(tx=>tx.amount<0&&!tx.isTransfer&&!tx.isRefund&&tx.date);
const income=txs.filter(tx=>tx.isIncome&&tx.amount>0&&tx.date);
if(spending.length<10)return patterns;

// 1. Payday splurge â€” spending spike in first 3 days after income
if(income.length>=2){
const payDays=income.map(tx=>tx.date.getDate());
const payDayMode=payDays.sort((a,b)=>payDays.filter(v=>v===a).length-payDays.filter(v=>v===b).length).pop();
const postPayday=spending.filter(tx=>{const d=tx.date.getDate();const diff=d>=payDayMode?d-payDayMode:d+(30-payDayMode);return diff>=0&&diff<=3});
const restDays=spending.filter(tx=>{const d=tx.date.getDate();const diff=d>=payDayMode?d-payDayMode:d+(30-payDayMode);return diff>3});
if(postPayday.length>0&&restDays.length>0){
const postAvgDaily=postPayday.reduce((s,tx)=>s+Math.abs(tx.amount),0)/Math.max(1,3);
const restAvgDaily=restDays.reduce((s,tx)=>s+Math.abs(tx.amount),0)/Math.max(1,27);
const ratio=Math.round((postAvgDaily/restAvgDaily)*10)/10;
if(ratio>1.5){const premium=Math.round((postAvgDaily-restAvgDaily)*3);patterns.push({pattern:'payday_splurge',text:'You spend '+ratio+'x more in the 3 days after payday',detail:'That is roughly \u00a3'+premium+' above your daily average each pay cycle',severity:ratio>2?'high':'medium'})}
}}

// 2. Weekend premium â€” Sat+Sun daily spend vs Mon-Fri
const weekend=spending.filter(tx=>{const d=tx.date.getDay();return d===0||d===6});
const weekday=spending.filter(tx=>{const d=tx.date.getDay();return d>=1&&d<=5});
if(weekend.length>3&&weekday.length>5){
const wkndTotal=weekend.reduce((s,tx)=>s+Math.abs(tx.amount),0);
const wkdyTotal=weekday.reduce((s,tx)=>s+Math.abs(tx.amount),0);
const wkndDaily=wkndTotal/Math.max(1,new Set(weekend.map(tx=>tx.date.toDateString())).size);
const wkdyDaily=wkdyTotal/Math.max(1,new Set(weekday.map(tx=>tx.date.toDateString())).size);
const ratio=Math.round((wkndDaily/wkdyDaily)*10)/10;
if(ratio>1.3){patterns.push({pattern:'weekend_premium',text:'Your weekend spending is '+ratio+'x your weekday average',detail:'\u00a3'+Math.round(wkndDaily)+'/day on weekends vs \u00a3'+Math.round(wkdyDaily)+'/day on weekdays',severity:ratio>1.8?'high':'medium'})}
}

// 3. Hidden subscriptions â€” merchants appearing 8+ times, excluding person-to-person transfers
const byMerch={};
spending.forEach(tx=>{if(!tx.merchant||tx.isSubscription||tx.category==='Transfers'||tx.category==='Debt Payments')return;if(this._isLikelyPersonName(tx.merchant))return;if(!byMerch[tx.merchant])byMerch[tx.merchant]={count:0,total:0,category:tx.category};byMerch[tx.merchant].count++;byMerch[tx.merchant].total+=Math.abs(tx.amount)});
const months=Math.max(1,txs.filter(tx=>tx.date).length>=2?((Math.max(...txs.filter(tx=>tx.date).map(tx=>tx.date.getTime()))-Math.min(...txs.filter(tx=>tx.date).map(tx=>tx.date.getTime())))/(1000*60*60*24*30.44)):1);
for(const[merchant,data]of Object.entries(byMerch)){
if(data.count>=8){const monthly=Math.round(data.total/months);
const isEssential=ESSENTIAL_CATEGORIES.has(data.category);
if(isEssential){
// Essential spending (transport, groceries, bills) â€” suggest review only if very high, lower severity
if(monthly>100){patterns.push({pattern:'essential_review',text:merchant+': Â£'+monthly+'/mo on '+data.category.toLowerCase()+' (essential)',detail:'This is a necessary expense but worth reviewing if the amount seems high. Consider if there are more cost-effective alternatives.',severity:'low',merchant,monthlyAmount:monthly,isEssential:true})}
}else{
patterns.push({pattern:'hidden_subscription',text:merchant+' appears '+data.count+' times \u2014 a hidden \u00a3'+monthly+'/mo habit',detail:'That is \u00a3'+(monthly*12)+'/yr on what is effectively a regular commitment',severity:monthly>50?'high':'medium',merchant,monthlyAmount:monthly,isEssential:false})}
}}

// 4. Late-month squeeze â€” spending drops in last 5 days before typical payday
if(income.length>=2){
const payDays=income.map(tx=>tx.date.getDate());
const payDayMode=payDays.sort((a,b)=>payDays.filter(v=>v===a).length-payDays.filter(v=>v===b).length).pop();
const lateMonth=spending.filter(tx=>{const d=tx.date.getDate();const daysBeforePay=payDayMode>=d?payDayMode-d:(30-d)+payDayMode;return daysBeforePay>=1&&daysBeforePay<=5});
const midMonth=spending.filter(tx=>{const d=tx.date.getDate();const daysAfterPay=d>=payDayMode?d-payDayMode:d+(30-payDayMode);return daysAfterPay>3&&daysAfterPay<25});
if(lateMonth.length>2&&midMonth.length>5){
const lateDaily=lateMonth.reduce((s,tx)=>s+Math.abs(tx.amount),0)/Math.max(1,5);
const midDaily=midMonth.reduce((s,tx)=>s+Math.abs(tx.amount),0)/Math.max(1,21);
const dropPct=Math.round((1-lateDaily/midDaily)*100);
if(dropPct>30){patterns.push({pattern:'late_month_squeeze',text:'Your spending drops '+dropPct+'% in the last 5 days before payday',detail:'This suggests cash flow pressure at end of month',severity:dropPct>50?'high':'medium'})}
}}

// 5. Impulse clusters â€” 3+ shopping transactions within same day
const byDay={};
spending.filter(tx=>tx.category==='Shopping').forEach(tx=>{const key=tx.date.toDateString();if(!byDay[key])byDay[key]=[];byDay[key].push(tx)});
const clusters=Object.values(byDay).filter(d=>d.length>=3);
if(clusters.length>=2){const avgCluster=Math.round(clusters.reduce((s,c)=>s+c.reduce((t,tx)=>t+Math.abs(tx.amount),0),0)/clusters.length);patterns.push({pattern:'impulse_cluster',text:clusters.length+' shopping spree days detected',detail:'You average \u00a3'+avgCluster+' on days with 3+ shopping transactions',severity:avgCluster>100?'high':'medium'})}

// Sort: non-essentials first by severity, essentials last (suggest review last)
return patterns.sort((a,b)=>{if(a.isEssential&&!b.isEssential)return 1;if(!a.isEssential&&b.isEssential)return -1;const sev={high:3,medium:2,low:1};return(sev[b.severity]||0)-(sev[a.severity]||0)}).slice(0,5);
}

// DECISION QUALITY SCORE â€” 0-100 composite measure
calcDecisionScore(profile){
const m=profile.monthly;const mt=profile.metrics;
const scores={};

// Intentionality (25%) â€” how much spending is habitual vs intentional
const recurringSpend=(m.subscriptions||0)+(m.debtPayments||0);
const totalSpend=m.spending||1;
const recurringPct=Math.min(100,Math.round((recurringSpend/totalSpend)*100));
scores.intentionality={score:Math.max(0,Math.min(100,100-recurringPct*1.5)),weight:25,label:'Intentionality',detail:recurringPct+'% of spending is recurring commitments'};

// Debt efficiency (20%) â€” debt payments as % of income (use category totals as primary, recurring as fallback)
const debtFromCat=profile.categories.find(c=>c.name==='Debt Payments');
const debtMonthly=debtFromCat?debtFromCat.total:m.debtPayments;
const debtPct=m.income>0?Math.round((debtMonthly/m.income)*100):0;
scores.debtEfficiency={score:debtPct===0?100:Math.max(0,100-debtPct*3),weight:20,label:'Debt Efficiency',detail:debtPct>0?debtPct+'% of income goes to debt (\u00a3'+debtMonthly+'/mo)':'No debt payments detected'};

// Savings capacity (25%) â€” savings rate vs 20% target
const sr=mt.savingsRate||0;
scores.savingsCapacity={score:Math.min(100,Math.max(0,Math.round((sr/20)*100))),weight:25,label:'Savings Capacity',detail:sr+'% savings rate'+(sr>=20?' (on target)':' (target: 20%)')};

// Subscription utilisation (15%) â€” account for count + refund signals
const subCount=mt.subscriptionCount||0;
// Count subscription-related refunds as a signal of forgotten/unused subs
const subRefunds=profile.categories.find(c=>c.name==='Refund');
const hasSubRefunds=subRefunds&&subRefunds.count>0;
let subScore=subCount===0?100:subCount<=3?85:subCount<=5?65:subCount<=8?45:25;
if(hasSubRefunds)subScore=Math.max(0,subScore-15);// Refunds suggest forgotten subs
scores.subscriptionHealth={score:subScore,weight:15,label:'Subscription Health',detail:subCount+' active subscription'+(subCount!==1?'s':'')+(hasSubRefunds?' (refunds suggest forgotten services)':'')};

// Convenience premium (15%) â€” delivery + eating out as % of total
const convenienceSpend=(m.foodDelivery||0)+(m.eatingOut||0);
const convPct=totalSpend>0?Math.round((convenienceSpend/totalSpend)*100):0;
scores.conveniencePremium={score:Math.max(0,100-convPct*2.5),weight:15,label:'Convenience Premium',detail:convPct>0?convPct+'% of spending on convenience':'No convenience premium'};

const totalScore=Math.round(Object.values(scores).reduce((s,d)=>s+d.score*(d.weight/100),0));
const breakdown=Object.values(scores);

// Generate verdict
let verdict='';
if(totalScore>=80)verdict='Strong financial discipline \u2014 you are making your money work for you';
else if(totalScore>=65)verdict='Solid foundation with clear opportunities to optimise';
else if(totalScore>=50){const weakest=breakdown.sort((a,b)=>a.score-b.score)[0];verdict='Room to improve \u2014 your biggest lever is '+weakest.label.toLowerCase()}
else{const leaked=Math.round(totalSpend*0.2);verdict='\u00a3'+leaked+'/mo is going to habits you may not be actively choosing'}

return{score:totalScore,verdict,breakdown:breakdown.sort((a,b)=>a.score-b.score)};
}

// DECISION STACK â€” ranked specific actions with quantified impact
genDecisionStack(profile,recurring,behavioralPatterns){
const moves=[];
const m=profile.monthly;

// 1. Dormant/low-value subscriptions â€” identify subs with lowest avg amount (likely forgotten)
const subs=profile.subscriptions||[];
if(subs.length>3){const cheapest=subs.filter(s=>s.averageAmount<15).slice(0,3);if(cheapest.length>0){const total=Math.round(cheapest.reduce((s,r)=>s+r.averageAmount,0));moves.push({action:'Review '+cheapest.length+' low-cost subscriptions: '+cheapest.map(s=>s.merchant+' (\u00a3'+s.averageAmount+')').join(', '),annualImpact:total*12,effort:'low',unlocks:'Quick wins \u2014 often forgotten services that add up',type:'subscription'})}}

// 2. Food delivery reduction â€” specific based on actual order value
if(m.foodDelivery>40){const avgOrder=m.foodDelivery/(profile.topMerchants?.filter(tm=>['Deliveroo','Uber Eats','Just Eat'].includes(tm.merchant)).reduce((s,tm)=>s+tm.count,0)/Math.max(1,profile.monthSpan)||4);const cutOrders=Math.ceil(m.foodDelivery*0.3/avgOrder);moves.push({action:'Swap '+cutOrders+' delivery orders per month for home cooking',annualImpact:Math.round(m.foodDelivery*0.3*12),effort:'medium',unlocks:m.groceries>0?'Your grocery spend shows you already cook \u2014 just shift the balance':'Redirects \u00a3'+Math.round(m.foodDelivery*0.3)+'/mo to other goals',type:'convenience'})}

// 3. Debt acceleration â€” smallest debt first
const debts=profile.debtPayments||[];
if(debts.length>=2){const smallest=debts.sort((a,b)=>a.averageAmount-b.averageAmount)[0];moves.push({action:'Focus on clearing '+smallest.merchant+' first (\u00a3'+smallest.averageAmount+'/mo)',annualImpact:Math.round(smallest.averageAmount*12),effort:'medium',unlocks:'Once cleared, redirect \u00a3'+smallest.averageAmount+'/mo to the next debt or savings',type:'debt'})}

// 4. Hidden subscriptions from behavioral patterns
const hidden=behavioralPatterns.filter(p=>p.pattern==='hidden_subscription');
if(hidden.length>0){const top=hidden[0];moves.push({action:'Your '+top.merchant+' habit is a hidden \u00a3'+top.monthlyAmount+'/mo subscription',annualImpact:Math.round(top.monthlyAmount*0.3*12),effort:'medium',unlocks:'Reducing by 30% saves \u00a3'+Math.round(top.monthlyAmount*0.3)+'/mo without eliminating it',type:'behavioral'})}

// 5. Payday splurge mitigation
const splurge=behavioralPatterns.find(p=>p.pattern==='payday_splurge');
if(splurge){const premium=parseInt(splurge.detail.match(/\d+/)?.[0]||'0');if(premium>30){moves.push({action:'Delay non-essential purchases 48 hours after payday',annualImpact:Math.round(premium*0.5*12),effort:'low',unlocks:'Your post-payday spike adds \u00a3'+premium+'/mo \u2014 a short delay cuts impulse buys in half',type:'behavioral'})}}

// 6. Eating out reduction
if((m.eatingOut||0)>80){const coffeeShops=profile.topMerchants?.filter(tm=>['Starbucks','Costa','Pret','Greggs','Caffe Nero'].includes(tm.merchant))||[];const coffeeMonthly=coffeeShops.reduce((s,tm)=>s+Math.round(tm.total/profile.monthSpan),0);if(coffeeMonthly>20){moves.push({action:'Your coffee habit: \u00a3'+coffeeMonthly+'/mo across '+coffeeShops.length+' shop'+(coffeeShops.length>1?'s':''),annualImpact:Math.round(coffeeMonthly*0.5*12),effort:'low',unlocks:'Making coffee 3x/week instead saves \u00a3'+Math.round(coffeeMonthly*0.5)+'/mo',type:'convenience'})}
}

// 7. Shopping impulse control
if((m.shopping||0)>120){const impulsePattern=behavioralPatterns.find(p=>p.pattern==='impulse_cluster');moves.push({action:'Apply a 24-hour rule to purchases over \u00a330',annualImpact:Math.round((m.shopping||0)*0.2*12),effort:'low',unlocks:impulsePattern?impulsePattern.detail:'Reduces impulse purchases by roughly 20%',type:'behavioral'})}

// Rank by impact/effort ratio and return top 3
const effortMultiplier={low:1,medium:2,high:3};
return moves.sort((a,b)=>(b.annualImpact/(effortMultiplier[b.effort]||2))-(a.annualImpact/(effortMultiplier[a.effort]||2))).slice(0,3);
}

// COMPOUND COST â€” opportunity cost of top discretionary categories at 7% returns
calcCompoundCost(profile){
const m=profile.monthly;
const discretionary=[
{category:'Food Delivery',monthly:m.foodDelivery||0},
{category:'Eating Out',monthly:m.eatingOut||0},
{category:'Shopping',monthly:m.shopping||0},
{category:'Subscriptions',monthly:m.subscriptions||0},
{category:'Entertainment',monthly:m.entertainment||0}
].filter(c=>c.monthly>20).sort((a,b)=>b.monthly-a.monthly).slice(0,3);

const r=0.07/12;// monthly rate
return discretionary.map(c=>{
const pmt=c.monthly;
const fv=(n)=>Math.round(pmt*((Math.pow(1+r,n)-1)/r));
return{category:c.category,monthly:Math.round(pmt),annual:Math.round(pmt*12),fiveYear:fv(60),tenYear:fv(120)};
});
}
}


// BACKGROUND
const initBg=()=>{const c=document.getElementById('ascii-bg'),ctx=c.getContext('2d');const chars=['Â·','â€¢','â—‹','â—','+','âœ¦'];const particles=[];const resize=()=>{c.width=innerWidth;c.height=innerHeight};for(let i=0;i<70;i++)particles.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,char:chars[Math.floor(Math.random()*chars.length)],size:Math.random()*8+5,opacity:Math.random()*0.1+0.02,vx:(Math.random()-0.5)*0.06,vy:(Math.random()-0.5)*0.06,pulse:Math.random()*Math.PI*2,ps:Math.random()*0.01+0.003});const draw=()=>{ctx.clearRect(0,0,c.width,c.height);particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.pulse+=p.ps;if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;ctx.fillStyle='rgba(232,200,114,'+(p.opacity*(0.6+Math.sin(p.pulse)*0.4))+')';ctx.font=p.size+'px "Space Mono"';ctx.textAlign='center';ctx.fillText(p.char,p.x,p.y)});requestAnimationFrame(draw)};resize();addEventListener('resize',resize);draw()};

// NAV
const Nav=()=>(<nav style={{position:'fixed',top:0,left:0,right:0,zIndex:100,padding:'1rem 1.5rem',background:'rgba(10,10,10,0.95)',backdropFilter:'blur(20px)',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center'}}><a href={CONFIG.landingPage} className="mono" style={{fontSize:'1.1rem',fontWeight:700,color:'#fff',textDecoration:'none'}}>BOCY</a><span className="mono" style={{fontSize:'0.6rem',color:'var(--accent)'}}>âœ¦ MONEY PERSONALITY</span></nav>);

// LANDING
const Landing=({onStart})=>(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',padding:'6rem 1.5rem 4rem',position:'relative',zIndex:1,textAlign:'center'}}><div className="fade-in" style={{maxWidth:'380px',width:'100%'}}>

<pre className="mono" style={{fontSize:'0.5rem',lineHeight:1.4,color:'var(--accent)',marginBottom:'2.5rem',opacity:0.7}}>{`      Â·  â€¢  Â·     Â·  â€¢  Â·
    â€¢  âœ¦  â€¢  Â·  â€¢  âœ¦  â€¢
  Â·  â€¢  â—‰  âœ¦  â—‰  â€¢  Â·
    âœ¦  â€¢  â—‰  â—‰  â€¢  âœ¦`}</pre>

<h1 style={{fontSize:'clamp(1.5rem,5.5vw,1.9rem)',fontWeight:600,lineHeight:1.35,marginBottom:'1.25rem',letterSpacing:'-0.01em'}}>Discover your<br/><span style={{color:'var(--accent)'}}>Money Personality</span></h1>

<p style={{color:'var(--dim)',fontSize:'0.95rem',lineHeight:1.8,marginBottom:'1.5rem'}}>Connect your bank or upload a statement.<br/>Personalised insights in seconds.</p>

<p style={{color:'var(--muted)',fontSize:'0.78rem',lineHeight:1.8,marginBottom:'3rem',maxWidth:'320px'}}>Your data never leaves your browser. No login required, no database, no data stored. Everything is analysed in real-time and discarded when you close the page.</p>

<button onClick={onStart} className="mono" style={{padding:'1.1rem 3rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'6px',fontSize:'0.8rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.04em'}}>[ GET STARTED ]</button>

<div style={{marginTop:'3.5rem',display:'flex',justifyContent:'center',gap:'1.5rem',flexWrap:'wrap'}}><span style={{fontSize:'0.7rem',color:'var(--muted)',display:'flex',alignItems:'center',gap:'0.35rem'}}><span style={{color:'var(--mint)',fontSize:'0.5rem'}}>â—</span> Runs in your browser</span><span style={{fontSize:'0.7rem',color:'var(--muted)',display:'flex',alignItems:'center',gap:'0.35rem'}}><span style={{color:'var(--mint)',fontSize:'0.5rem'}}>â—</span> No data stored</span><span style={{fontSize:'0.7rem',color:'var(--muted)',display:'flex',alignItems:'center',gap:'0.35rem'}}><span style={{color:'var(--mint)',fontSize:'0.5rem'}}>â—</span> No login needed</span></div>

</div></div>);

// UPLOAD
const Upload=({onDone,onBack,tlCode,onTlCodeUsed})=>{const[files,setFiles]=useState([]);const[status,setStatus]=useState('idle');const[statusMsg,setStatusMsg]=useState('');const[err,setErr]=useState('');const ref=useRef();
const[bankCSV,setBankCSV]=useState(null);const[bankName,setBankName]=useState('');
const addFiles=newF=>{const valid=Array.from(newF).filter(f=>{const n=f.name.toLowerCase();return n.endsWith('.csv')||n.endsWith('.pdf')});if(!valid.length){setErr('Please upload CSV or PDF files');return}setFiles(p=>[...p,...valid]);setErr('')};
const removeFile=i=>setFiles(p=>p.filter((_,idx)=>idx!==i));
const getFileIcon=name=>name.toLowerCase().endsWith('.pdf')?'â—‰':'â—‹';
const connectBank=()=>{const redirectUri=encodeURIComponent(TRUELAYER_CONFIG.redirectUri);const scope=encodeURIComponent(TRUELAYER_CONFIG.scope);const providers=encodeURIComponent(TRUELAYER_CONFIG.providers);window.location.href=TRUELAYER_CONFIG.authBaseUrl+'/?response_type=code&client_id='+TRUELAYER_CONFIG.clientId+'&scope='+scope+'&redirect_uri='+redirectUri+'&providers='+providers};
const handleTrueLayerCode=async(code)=>{setStatus('parsing');setStatusMsg('Connecting to your bank...');setErr('');try{
const redirectUri=TRUELAYER_CONFIG.redirectUri;
const resp=await fetch('/api/truelayer/callback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,redirect_uri:redirectUri})});
if(!resp.ok){const d=await resp.json().catch(()=>({}));throw new Error(d.error||'Connection failed')}
const data=await resp.json();
if(!data.csv||data.transactionCount<1){setErr('No transactions found. Try uploading a statement instead.');setStatus('idle');return}
setBankCSV(data.csv);setBankName(data.transactionCount+' transactions loaded');
setStatus('idle');setStatusMsg('')}catch(e){console.error(e);setErr('Could not connect to your bank. Please try uploading a statement instead.');setStatus('idle')}};
useEffect(()=>{if(tlCode){handleTrueLayerCode(tlCode);onTlCodeUsed?.()}},[tlCode]);
const analyse=async()=>{const allTexts=bankCSV?[bankCSV]:[];
try{
for(const f of files){
if(f.name.toLowerCase().endsWith('.pdf')){
try{const pdfText=await extractPDFText(f);allTexts.push(pdfText)}catch(e){setErr('Could not read PDF: '+f.name+'. Please ensure it is not password-protected.');setStatus('idle');return}
}else{allTexts.push(await f.text())}
}
if(!allTexts.length){setErr('Please connect a bank or upload at least one file');return}
setStatus('parsing');setStatusMsg('Parsing your files...');setErr('');
const engine=new EnrichmentEngine();
const result=await engine.enrich(allTexts,msg=>setStatusMsg(msg));
if(result.profile.transactionCount<5){setErr('Not enough transactions found. Please check your file format.');setStatus('idle');return}
onDone(result)}catch(e){console.error(e);setErr('Could not process files. Please try again.');setStatus('idle')}};

if(status==='parsing')return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',padding:'2rem',position:'relative',zIndex:1,textAlign:'center'}}>
<pre className="mono" style={{color:'var(--accent)',marginBottom:'2rem',animation:'pulse 1.5s ease-in-out infinite',fontSize:'0.55rem',lineHeight:1.5}}>{`    Â·  â€¢  Â·
   â€¢  â—‰  â€¢
    Â·  â€¢  Â·`}</pre>
<p style={{fontSize:'1rem',color:'var(--text2)',fontWeight:500,marginBottom:'0.6rem'}}>{statusMsg||'Analysing your transactions...'}</p>
<p style={{fontSize:'0.75rem',color:'var(--muted)',marginBottom:'1.5rem'}}>This may take a moment</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.4rem',alignItems:'center'}}>{['Parsing transactions','Identifying merchants','Categorising data','Building profile'].map((step,i)=>{const active=statusMsg?.toLowerCase().includes(step.split(' ')[0].toLowerCase());const done=statusMsg&&['Parsing','Identifying','Categoris','Building'].findIndex(s=>statusMsg.includes(s))>i;return(<div key={i} style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span style={{color:done?'var(--mint)':active?'var(--accent)':'var(--muted)',fontSize:'0.7rem'}}>{done?'âœ“':active?'â—':'â—‹'}</span><span className="mono" style={{fontSize:'0.65rem',color:done?'var(--dim)':active?'var(--text2)':'var(--muted)'}}>{step}</span></div>)})}</div>
</div>);

return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',padding:'5.5rem 1.25rem 3rem',position:'relative',zIndex:1}}><div className="slide-up" style={{maxWidth:'400px',width:'100%'}}>

<div style={{textAlign:'center',marginBottom:'2.5rem'}}>
<pre className="mono" style={{fontSize:'0.4rem',lineHeight:1.4,color:'var(--accent)',marginBottom:'1.5rem',opacity:0.5}}>{`   Â·  â€¢  Â·
  â€¢  â—‰  â€¢
   Â·  â€¢  Â·`}</pre>
<h2 style={{fontSize:'1.35rem',fontWeight:600,marginBottom:'0.75rem'}}>Get your results</h2>
<p style={{color:'var(--dim)',fontSize:'0.85rem',lineHeight:1.7}}>Choose how you'd like to share<br/>your transaction history</p>
</div>

<div style={{padding:'1.75rem',background:'linear-gradient(180deg,rgba(114,232,176,0.05) 0%,rgba(114,176,232,0.03) 100%)',border:'1px solid rgba(114,232,176,0.1)',borderRadius:'14px',marginBottom:'1.25rem'}}>
<p className="mono" style={{fontSize:'0.55rem',letterSpacing:'0.15em',color:'var(--mint)',marginBottom:'1.25rem',textTransform:'uppercase'}}>âœ¦ Recommended</p>
<h3 style={{fontSize:'1.1rem',fontWeight:600,color:'#fff',marginBottom:'0.6rem'}}>Connect your bank</h3>
<p style={{color:'var(--dim)',fontSize:'0.82rem',lineHeight:1.7,marginBottom:'1.25rem'}}>Securely link your account for the most accurate personality profile. Read-only access â€” we never see your login details.</p>

{bankCSV?(<div style={{display:'flex',alignItems:'center',gap:'0.6rem',padding:'0.75rem 1rem',background:'rgba(114,232,176,0.06)',border:'1px solid rgba(114,232,176,0.12)',borderRadius:'10px',marginBottom:'1rem'}}><span style={{color:'var(--mint)',fontSize:'1rem',fontWeight:600}}>âœ“</span><span style={{color:'var(--text2)',fontSize:'0.85rem'}}>{bankName}</span></div>):(<button onClick={connectBank} className="mono" style={{width:'100%',padding:'1rem',background:'var(--mint)',color:'var(--bg)',border:'none',borderRadius:'8px',fontSize:'0.78rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.03em',marginBottom:'1.5rem'}}>[ CONNECT YOUR BANK ]</button>)}

<div style={{display:'flex',justifyContent:'center',gap:'0.6rem',flexWrap:'wrap'}}><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>TrueLayer (FCA regulated)</span><span style={{fontSize:'0.65rem',color:'var(--border)'}}>Â·</span><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>Read-only access</span><span style={{fontSize:'0.65rem',color:'var(--border)'}}>Â·</span><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>No data stored</span></div>
</div>

{err&&<div style={{padding:'0.75rem 1rem',background:'rgba(232,114,114,0.06)',border:'1px solid rgba(232,114,114,0.12)',borderRadius:'8px',marginTop:'1.25rem',textAlign:'center'}}><p style={{color:'var(--coral)',fontSize:'0.8rem'}}>{err}</p></div>}

{bankCSV?(<button onClick={analyse} className="mono" style={{width:'100%',padding:'1rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'8px',fontSize:'0.78rem',fontWeight:700,cursor:'pointer',marginTop:'1.5rem'}}>[ ANALYSE BANK DATA ]</button>):(<>
<div style={{display:'flex',alignItems:'center',gap:'1rem',margin:'1.75rem 0'}}><div style={{flex:1,height:'1px',background:'var(--border)'}}/><span className="mono" style={{fontSize:'0.6rem',color:'var(--muted)',letterSpacing:'0.1em'}}>OR</span><div style={{flex:1,height:'1px',background:'var(--border)'}}/></div>

<div style={{marginBottom:'1.5rem'}}>
<h3 style={{fontSize:'1rem',fontWeight:500,color:'var(--text2)',marginBottom:'0.5rem',textAlign:'center'}}>Upload a statement</h3>
<p style={{color:'var(--muted)',fontSize:'0.78rem',textAlign:'center',marginBottom:'1.5rem'}}>CSV or PDF from your banking app</p>

<div onClick={()=>ref.current?.click()} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();addFiles(e.dataTransfer.files)}} style={{padding:'2rem 1.5rem',border:'1px dashed rgba(255,255,255,0.08)',borderRadius:'12px',cursor:'pointer',textAlign:'center',marginBottom:'1rem'}}><input ref={ref} type="file" accept=".csv,.pdf" multiple onChange={e=>addFiles(e.target.files)} style={{display:'none'}}/>
<pre className="mono" style={{color:'var(--muted)',fontSize:'0.45rem',lineHeight:1.4,marginBottom:'1rem'}}>{`   Â·  Â·  Â·
  Â·  âœ¦  Â·
   Â·  Â·  Â·`}</pre>
<p style={{color:'var(--text2)',fontSize:'0.88rem',marginBottom:'0.3rem'}}>Drop files here</p>
<p style={{color:'var(--muted)',fontSize:'0.72rem'}}>or tap to browse</p>
</div>

{files.length>0&&(<div style={{marginBottom:'1.25rem'}}><p className="mono" style={{fontSize:'0.65rem',color:'var(--dim)',marginBottom:'0.5rem'}}>{files.length} file{files.length>1?'s':''} selected</p><div style={{display:'flex',flexWrap:'wrap',gap:'0.3rem'}}>{files.map((f,i)=>(<span key={i} className="file-chip">{getFileIcon(f.name)} {f.name.length>25?f.name.substring(0,22)+'...':f.name}<button onClick={()=>removeFile(i)}>Ã—</button></span>))}</div></div>)}

<button onClick={analyse} disabled={!files.length} className="mono" style={{width:'100%',padding:'1rem',background:files.length?'var(--accent)':'transparent',color:files.length?'var(--bg)':'var(--muted)',border:files.length?'none':'1px solid var(--border)',borderRadius:'8px',fontSize:'0.78rem',fontWeight:700,cursor:files.length?'pointer':'not-allowed'}}>[ ANALYSE {files.length?files.length+' FILE'+(files.length>1?'S':''):''} ]</button>
</div></>)}

<button onClick={onBack} style={{display:'block',width:'100%',background:'none',border:'none',color:'var(--muted)',fontSize:'0.8rem',cursor:'pointer',padding:'1rem 0',marginTop:'0.5rem'}}>â† back</button>

</div></div>)};


// CARD
const ResultCard=React.forwardRef(({result},ref)=>{const{archetype,profile,traits,potentialSavings}=result;const savingsTotal=potentialSavings.total;const ascii=ARCHETYPE_ASCII[archetype.key]||ARCHETYPE_ASCII.balanced_realist;const topCat=profile.categories[0]?.name||'Lifestyle';return(<div ref={ref} style={{width:'320px',background:'#050505',borderRadius:'12px',padding:'24px',position:'relative',overflow:'hidden',border:'1px solid '+archetype.color+'30'}}><div style={{position:'absolute',inset:0,background:'radial-gradient(circle at 50% 20%,'+archetype.color+'10 0%,transparent 50%)',pointerEvents:'none'}}/><div style={{position:'relative',zIndex:1}}><pre className="mono" style={{fontSize:'10px',lineHeight:'12px',color:archetype.color,textAlign:'center',marginBottom:'16px',whiteSpace:'pre'}}>{ascii.split('\\n').join('\n')}</pre><div style={{textAlign:'center',marginBottom:'16px'}}><span style={{fontSize:'2rem',display:'block',marginBottom:'4px'}}>{archetype.emoji}</span><h2 className="mono" style={{fontSize:'0.85rem',fontWeight:700,color:'#fff',marginBottom:'4px'}}>{archetype.name}</h2><p style={{fontSize:'0.65rem',color:archetype.color,fontStyle:'italic'}}>"{archetype.vibe}"</p></div>{traits.length>0&&(<div style={{display:'flex',flexWrap:'wrap',justifyContent:'center',gap:'4px',marginBottom:'16px'}}>{traits.slice(0,3).map((t,i)=>(<span key={i} style={{fontSize:'0.6rem',padding:'2px 8px',background:'rgba(255,255,255,0.05)',borderRadius:'10px',color:'var(--dim)'}}>{t.emoji} {t.text}</span>))}</div>)}<div style={{background:'rgba(255,255,255,0.02)',border:'1px solid rgba(255,255,255,0.04)',borderRadius:'8px',padding:'14px',marginBottom:'14px'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}><span className="mono" style={{fontSize:'0.6rem',color:'var(--dim)'}}>Subscriptions</span><span className="mono" style={{fontSize:'0.6rem',color:'#fff'}}>{profile.metrics.subscriptionCount} (Â£{profile.monthly.subscriptions}/mo)</span></div>{profile.metrics.debtAccountCount>0&&(<div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}><span className="mono" style={{fontSize:'0.6rem',color:'var(--dim)'}}>Debt Payments</span><span className="mono" style={{fontSize:'0.6rem',color:'var(--coral)'}}>{profile.metrics.debtAccountCount} (Â£{profile.monthly.debtPayments}/mo)</span></div>)}<div style={{display:'flex',justifyContent:'space-between'}}><span className="mono" style={{fontSize:'0.6rem',color:'var(--dim)'}}>Top Category</span><span className="mono" style={{fontSize:'0.6rem',color:'#fff'}}>{topCat}</span></div><div style={{textAlign:'center',paddingTop:'12px',marginTop:'12px',borderTop:'1px solid rgba(255,255,255,0.04)'}}><p className="mono" style={{fontSize:'0.5rem',color:'#444',marginBottom:'4px'}}>POTENTIAL SAVINGS</p><p className="mono" style={{fontSize:'1.6rem',fontWeight:700,color:archetype.color}}>Â£{savingsTotal.toLocaleString()}</p><p className="mono" style={{fontSize:'0.45rem',color:'#333'}}>per year</p></div></div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',borderTop:'1px solid rgba(255,255,255,0.04)',paddingTop:'12px'}}><span className="mono" style={{fontSize:'0.8rem',fontWeight:700,color:'#fff'}}>BOCY</span><span className="mono" style={{fontSize:'0.45rem',color:'#444'}}>bocy.io/personality</span></div></div></div>)});

// DECISION SCORE COMPONENT â€” clearer explanation of what each dimension means
const DecisionScoreCard=({decisionScore,color})=>{const{score,verdict,breakdown}=decisionScore;
const scoreColor=score>=75?'var(--mint)':score>=50?'var(--accent)':'var(--coral)';
const scoreLabel=score>=80?'Excellent':score>=65?'Good':score>=50?'Fair':score>=35?'Needs Work':'Critical';
return(<div className="card-box slide-up" style={{border:'1px solid '+scoreColor+'25'}}><div className="section-title">How Well You Manage Money</div>
<p style={{color:'var(--dim)',fontSize:'0.78rem',marginBottom:'1.25rem'}}>This score measures how intentionally you spend, save, and manage debt â€” not how much you earn.</p>
<div style={{textAlign:'center',marginBottom:'1.25rem'}}><div style={{position:'relative',width:'110px',height:'110px',margin:'0 auto 0.75rem'}}><svg viewBox="0 0 100 100" style={{transform:'rotate(-90deg)'}}><circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.04)" strokeWidth="6"/><circle cx="50" cy="50" r="42" fill="none" stroke={scoreColor} strokeWidth="6" strokeLinecap="round" strokeDasharray={Math.round(264*(score/100))+' 264'}/></svg><div style={{position:'absolute',inset:0,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'}}><span className="mono" style={{fontSize:'1.8rem',fontWeight:700,color:scoreColor}}>{score}</span><span className="mono" style={{fontSize:'0.6rem',color:scoreColor,marginTop:'-2px'}}>{scoreLabel}</span></div></div>
<p style={{color:'var(--text2)',fontSize:'0.85rem',lineHeight:1.6,maxWidth:'320px',margin:'0 auto'}}>{verdict}</p></div>
<div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>{breakdown.map((d,i)=>{const dimColor=d.score>=70?'var(--mint)':d.score>=40?'var(--accent)':'var(--coral)';return(<div key={i} style={{padding:'0.6rem',background:'rgba(255,255,255,0.02)',borderRadius:'6px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.3rem'}}><span style={{color:'#fff',fontSize:'0.85rem',fontWeight:500}}>{d.label}</span><span className="mono" style={{fontSize:'0.8rem',fontWeight:700,color:dimColor}}>{d.score}<span style={{fontSize:'0.6rem',color:'var(--muted)'}}>/100</span></span></div><div style={{height:'5px',background:'rgba(255,255,255,0.04)',borderRadius:'3px',overflow:'hidden',marginBottom:'0.3rem'}}><div style={{height:'100%',width:d.score+'%',background:dimColor,borderRadius:'3px',transition:'width 0.5s'}}/></div><p style={{color:'var(--dim)',fontSize:'0.75rem',lineHeight:1.5}}>{d.detail}</p></div>)})}</div></div>)};

// MONEY MOVES COMPONENT
const MoneyMovesCard=({moves})=>{if(!moves||moves.length===0)return null;
const effortColor={low:'var(--mint)',medium:'var(--accent)',high:'var(--coral)'};
return(<div className="card-box slide-up" style={{border:'1px solid rgba(232,200,114,0.2)'}}><div className="section-title" style={{color:'var(--accent)'}}>Your Top Money Moves</div><p style={{color:'var(--dim)',fontSize:'0.78rem',marginBottom:'1rem'}}>Ranked by impact. Start with #1.</p>
<div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>{moves.map((m,i)=>(<div key={i} style={{padding:'0.9rem',background:'rgba(255,255,255,0.02)',border:'1px solid var(--border)',borderRadius:'8px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'0.5rem'}}><div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span className="mono" style={{fontSize:'0.7rem',color:'var(--accent)',background:'rgba(232,200,114,0.1)',padding:'0.15rem 0.4rem',borderRadius:'4px'}}>#{i+1}</span><span style={{fontSize:'0.75rem',color:effortColor[m.effort]}}>{m.effort} effort</span></div><span className="mono" style={{fontSize:'0.85rem',fontWeight:700,color:'var(--mint)'}}>+Â£{m.annualImpact.toLocaleString()}/yr</span></div>
<p style={{color:'#fff',fontSize:'0.88rem',fontWeight:500,marginBottom:'0.35rem',lineHeight:1.5}}>{m.action}</p>
<p style={{color:'var(--dim)',fontSize:'0.78rem',lineHeight:1.5}}>{m.unlocks}</p></div>))}</div></div>)};

// PLAYBOOK COMPONENT
const PlaybookCard=({archetype,playbook})=>{if(!playbook)return null;
return(<div className="card-box slide-up"><div className="section-title">Your Playbook</div>
<div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.75rem'}}><span style={{fontSize:'1.5rem'}}>{archetype.emoji}</span><h3 style={{fontSize:'1rem',fontWeight:600,color:archetype.color}}>{archetype.name}</h3></div>
<p style={{color:'var(--text2)',fontSize:'0.88rem',lineHeight:1.7,marginBottom:'1.25rem'}}>{playbook.narrative}</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>{playbook.strategies.map((s,i)=>(<div key={i} style={{padding:'0.75rem',background:'rgba(255,255,255,0.02)',borderRadius:'6px',borderLeft:'3px solid '+archetype.color}}><p style={{color:'#fff',fontSize:'0.85rem',fontWeight:600,marginBottom:'0.25rem'}}>{s.title}</p><p style={{color:'var(--dim)',fontSize:'0.82rem',lineHeight:1.6}}>{s.text}</p></div>))}</div></div>)};

// FINANCIAL ADVISOR COMPONENT â€” for users in debt distress
const FinancialAdvisorCard=({tips})=>{if(!tips||tips.length===0)return null;
const typeIcon={shortfall:'âš ï¸',cut:'âœ‚ï¸',consolidate:'ðŸ”—',help:'ðŸ“ž',crisis:'ðŸš¨'};
return(<div className="card-box slide-up" style={{border:'1px solid rgba(232,114,114,0.2)',background:'linear-gradient(180deg,rgba(232,114,114,0.04) 0%,var(--surface) 100%)'}}><div className="section-title" style={{color:'var(--coral)'}}>Financial Health Check</div><p style={{color:'var(--dim)',fontSize:'0.78rem',marginBottom:'1rem'}}>Based on your income vs expenses, here are some steps to consider</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>{tips.map((t,i)=>(<div key={i} style={{padding:'0.75rem',background:'rgba(255,255,255,0.02)',borderRadius:'6px',borderLeft:'3px solid '+(t.type==='crisis'?'var(--coral)':t.type==='help'?'var(--mint)':'var(--accent)')}}><div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.3rem'}}><span style={{fontSize:'1rem'}}>{typeIcon[t.type]||'ðŸ’¡'}</span><p style={{color:'#fff',fontSize:'0.88rem',fontWeight:600}}>{t.title}</p></div><p style={{color:'var(--dim)',fontSize:'0.82rem',lineHeight:1.6,marginLeft:'1.5rem'}}>{t.text}</p></div>))}</div></div>)};

// BEHAVIORAL PATTERNS COMPONENT â€” essentials flagged differently
const BehavioralPatternsCard=({patterns})=>{if(!patterns||patterns.length===0)return null;
const sevColor={high:'var(--coral)',medium:'var(--accent)',low:'var(--dim)'};
const patternIcon={payday_splurge:'ðŸ“…',weekend_premium:'ðŸ“†',hidden_subscription:'ðŸ”„',late_month_squeeze:'ðŸ“‰',impulse_cluster:'âš¡',essential_review:'ðŸ·ï¸'};
return(<div className="card-box slide-up" style={{border:'1px solid rgba(178,114,232,0.15)'}}><div className="section-title" style={{color:'var(--lavender)'}}>Behavioral Patterns</div><p style={{color:'var(--dim)',fontSize:'0.78rem',marginBottom:'1rem'}}>What your transaction timing reveals</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>{patterns.map((p,i)=>(<div key={i} style={{display:'flex',gap:'0.75rem',alignItems:'flex-start'}}><span style={{fontSize:'1.1rem',marginTop:'0.1rem'}}>{patternIcon[p.pattern]||'ðŸ“Š'}</span><div style={{flex:1}}><p style={{color:'#fff',fontSize:'0.88rem',fontWeight:500,marginBottom:'0.2rem'}}>{p.text}</p><p style={{color:'var(--dim)',fontSize:'0.78rem',lineHeight:1.5}}>{p.detail}</p></div>{p.isEssential?(<span className="mono" style={{fontSize:'0.6rem',color:'var(--mint)',padding:'0.15rem 0.4rem',background:'rgba(114,232,176,0.1)',borderRadius:'4px',whiteSpace:'nowrap'}}>essential</span>):(<span className="mono" style={{fontSize:'0.6rem',color:sevColor[p.severity],padding:'0.15rem 0.4rem',background:p.severity==='high'?'rgba(232,114,114,0.1)':'rgba(232,200,114,0.08)',borderRadius:'4px',whiteSpace:'nowrap'}}>{p.severity}</span>)}</div>))}</div></div>)};

// INCOME ANALYSIS COMPONENT
const IncomeAnalysisCard=({incomeSources,monthlyIncome})=>{if(!incomeSources||incomeSources.length===0)return null;
const freqLabel={weekly:'Weekly',fortnightly:'Fortnightly',monthly:'Monthly',irregular:'Irregular'};
const freqColor={weekly:'var(--sky)',fortnightly:'var(--lavender)',monthly:'var(--mint)',irregular:'var(--dim)'};
return(<div className="card-box slide-up" style={{border:'1px solid rgba(114,232,176,0.15)'}}><div className="section-title" style={{color:'var(--mint)'}}>Your Income</div>
<div style={{textAlign:'center',marginBottom:'1.25rem',paddingBottom:'1rem',borderBottom:'1px solid var(--border)'}}><p className="mono" style={{fontSize:'2rem',fontWeight:700,color:'var(--mint)'}}>Â£{monthlyIncome.toLocaleString()}</p><p style={{fontSize:'0.8rem',color:'var(--dim)'}}>total monthly income</p></div>
<div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>{incomeSources.map((src,i)=>(<div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.6rem',background:src.isPrimary?'rgba(114,232,176,0.06)':'rgba(255,255,255,0.02)',borderRadius:'6px',border:src.isPrimary?'1px solid rgba(114,232,176,0.15)':'1px solid transparent'}}><div><p style={{color:'#fff',fontSize:'0.88rem',fontWeight:src.isPrimary?600:500}}>{src.source}</p><div style={{display:'flex',gap:'0.4rem',alignItems:'center',marginTop:'0.15rem'}}><span className="mono" style={{fontSize:'0.65rem',color:freqColor[src.frequency],background:freqColor[src.frequency]+'15',padding:'0.1rem 0.4rem',borderRadius:'3px'}}>{freqLabel[src.frequency]||src.frequency}</span>{src.isPrimary&&<span className="mono" style={{fontSize:'0.55rem',color:'var(--mint)',background:'rgba(114,232,176,0.12)',padding:'0.1rem 0.4rem',borderRadius:'3px'}}>PRIMARY</span>}</div></div><div style={{textAlign:'right'}}><p className="mono" style={{color:'var(--mint)',fontSize:'0.9rem',fontWeight:600}}>Â£{src.avgAmount.toLocaleString()}</p><p style={{color:'var(--muted)',fontSize:'0.7rem'}}>{src.frequency==='weekly'?'per week':src.frequency==='fortnightly'?'every 2 weeks':'per month'}</p></div></div>))}</div></div>)};

// BUDGET REALITY COMPONENT â€” non-discretionary vs what's left
const BudgetRealityCard=({budgetReality,monthlyIncome})=>{if(!budgetReality)return null;
const{nonDiscretionary,discretionary,leftToDecide}=budgetReality;
const ndPct=monthlyIncome>0?Math.round((nonDiscretionary.total/monthlyIncome)*100):0;
const discPct=monthlyIncome>0?Math.round((discretionary.total/monthlyIncome)*100):0;
const leftPct=monthlyIncome>0?Math.round((leftToDecide/monthlyIncome)*100):0;
return(<div className="card-box slide-up" style={{border:'1px solid rgba(232,200,114,0.15)'}}><div className="section-title" style={{color:'var(--accent)'}}>Your Budget Reality</div>

<div style={{display:'flex',height:'8px',borderRadius:'4px',overflow:'hidden',marginBottom:'1.25rem',background:'rgba(255,255,255,0.04)'}}>
<div style={{width:ndPct+'%',background:'var(--coral)',transition:'width 0.5s'}}/>
<div style={{width:discPct+'%',background:'var(--accent)',transition:'width 0.5s'}}/>
<div style={{width:Math.max(0,leftPct)+'%',background:'var(--mint)',transition:'width 0.5s'}}/>
</div>

<div style={{display:'flex',justifyContent:'space-between',marginBottom:'1.5rem',gap:'0.5rem'}}>
<div style={{textAlign:'center',flex:1}}><p className="mono" style={{fontSize:'1.1rem',fontWeight:700,color:'var(--coral)'}}>Â£{nonDiscretionary.total}</p><p style={{fontSize:'0.7rem',color:'var(--dim)'}}>Non-negotiable</p><p style={{fontSize:'0.65rem',color:'var(--muted)'}}>{ndPct}%</p></div>
<div style={{textAlign:'center',flex:1}}><p className="mono" style={{fontSize:'1.1rem',fontWeight:700,color:'var(--accent)'}}>Â£{discretionary.total}</p><p style={{fontSize:'0.7rem',color:'var(--dim)'}}>Lifestyle</p><p style={{fontSize:'0.65rem',color:'var(--muted)'}}>{discPct}%</p></div>
<div style={{textAlign:'center',flex:1}}><p className="mono" style={{fontSize:'1.1rem',fontWeight:700,color:leftToDecide>0?'var(--mint)':'var(--coral)'}}>Â£{Math.abs(leftToDecide)}</p><p style={{fontSize:'0.7rem',color:'var(--dim)'}}>{leftToDecide>=0?'Left to decide':'Overspend'}</p><p style={{fontSize:'0.65rem',color:'var(--muted)'}}>{Math.abs(leftPct)}%</p></div>
</div>

<div style={{marginBottom:'1rem'}}><p style={{color:'var(--muted)',fontSize:'0.7rem',marginBottom:'0.5rem',textTransform:'uppercase',letterSpacing:'0.1em'}}>Non-negotiable breakdown</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.4rem'}}>{nonDiscretionary.items.filter(i=>i.monthly>0).map((item,i)=>(<div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{color:'var(--text2)',fontSize:'0.82rem'}}>{item.category}</span><span className="mono" style={{color:'var(--coral)',fontSize:'0.82rem'}}>Â£{item.monthly}</span></div>))}</div></div>

{discretionary.items.length>0&&(<div><p style={{color:'var(--muted)',fontSize:'0.7rem',marginBottom:'0.5rem',textTransform:'uppercase',letterSpacing:'0.1em'}}>Lifestyle spending</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.4rem'}}>{discretionary.items.filter(i=>i.monthly>0).map((item,i)=>(<div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{color:'var(--text2)',fontSize:'0.82rem'}}>{item.category}</span><span className="mono" style={{color:'var(--accent)',fontSize:'0.82rem'}}>Â£{item.monthly}</span></div>))}</div></div>)}
</div>)};

// COMPOUND COST COMPONENT
const CompoundCostCard=({costs})=>{if(!costs||costs.length===0)return null;
const maxTen=Math.max(...costs.map(c=>c.tenYear),1);
return(<div className="card-box slide-up" style={{border:'1px solid rgba(114,176,232,0.15)'}}><div className="section-title" style={{color:'var(--sky)'}}>The Compound Cost of Your Habits</div><p style={{color:'var(--dim)',fontSize:'0.78rem',marginBottom:'1.25rem'}}>What your spending costs over time if invested at 7% returns instead</p>
<div style={{display:'flex',flexDirection:'column',gap:'1.1rem'}}>{costs.map((c,i)=>(<div key={i}><div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline',marginBottom:'0.4rem'}}><span style={{color:'#fff',fontSize:'0.9rem',fontWeight:500}}>{c.category}</span><span className="mono" style={{color:'var(--text2)',fontSize:'0.82rem'}}>Â£{c.monthly}/mo</span></div>
<div style={{display:'flex',gap:'0.5rem',alignItems:'flex-end',height:'32px',marginBottom:'0.35rem'}}>
<div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:'0.15rem'}}><div style={{width:'100%',background:'rgba(114,176,232,0.15)',borderRadius:'3px',height:Math.max(4,Math.round((c.annual/maxTen)*28))+'px'}}/><span className="mono" style={{fontSize:'0.55rem',color:'var(--muted)'}}>1yr</span></div>
<div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:'0.15rem'}}><div style={{width:'100%',background:'rgba(114,176,232,0.25)',borderRadius:'3px',height:Math.max(4,Math.round((c.fiveYear/maxTen)*28))+'px'}}/><span className="mono" style={{fontSize:'0.55rem',color:'var(--muted)'}}>5yr</span></div>
<div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:'0.15rem'}}><div style={{width:'100%',background:'rgba(114,176,232,0.4)',borderRadius:'3px',height:Math.max(4,Math.round((c.tenYear/maxTen)*28))+'px'}}/><span className="mono" style={{fontSize:'0.55rem',color:'var(--muted)'}}>10yr</span></div>
</div>
<div style={{display:'flex',justifyContent:'space-between'}}><span className="mono" style={{fontSize:'0.72rem',color:'var(--dim)'}}>Â£{c.annual.toLocaleString()}</span><span className="mono" style={{fontSize:'0.72rem',color:'var(--sky)'}}>Â£{c.fiveYear.toLocaleString()}</span><span className="mono" style={{fontSize:'0.72rem',color:'var(--sky)',fontWeight:600}}>Â£{c.tenYear.toLocaleString()}</span></div>
</div>))}</div></div>)};

// RESULT â€” Layout: visible cards > full-screen email gate > blurred premium cards (compound cost, strengths, blind spots, decision score)
const Result=({result})=>{const cardRef=useRef();const[downloading,setDownloading]=useState(false);const[email,setEmail]=useState('');const[emailStatus,setEmailStatus]=useState('idle');const[unlocked,setUnlocked]=useState(false);const[showEmailGate,setShowEmailGate]=useState(false);const{archetype,profile,traits,strengths,blindSpots,insights,potentialSavings,decisionScore,decisionStack,playbook,behavioralPatterns,compoundCosts}=result;
const downloadCard=async()=>{if(!cardRef.current)return;setDownloading(true);try{const canvas=await html2canvas(cardRef.current,{backgroundColor:'#050505',scale:3});const link=document.createElement('a');link.download='my-money-personality.png';link.href=canvas.toDataURL('image/png');link.click()}catch(e){console.error(e)}setDownloading(false)};
const shareTwitter=()=>{const t='I am "'+archetype.name+'" '+archetype.emoji+'\n\n"'+archetype.vibe+'"\n\nMy decision score: '+decisionScore.score+'/100\n\nFind yours:';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(t)+'&url='+encodeURIComponent('https://bocy.io/personality'),'_blank')};
const submitEmail=async e=>{e.preventDefault();if(!email||emailStatus==='sending')return;setEmailStatus('sending');try{await fetch(CONFIG.googleScript,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,archetype:archetype.name,decisionScore:decisionScore.score,potentialSavings:potentialSavings.total,savingsRate:profile.metrics.savingsRate,subscriptionCount:profile.metrics.subscriptionCount,debtAccountCount:profile.metrics.debtAccountCount,traits:traits.map(t=>t.text).join(', '),timestamp:new Date().toISOString()})});setEmailStatus('done');setUnlocked(true);setShowEmailGate(false)}catch{setEmailStatus('done');setUnlocked(true);setShowEmailGate(false)}};

// Auto-show email gate when user scrolls past behavioral patterns
useEffect(()=>{if(unlocked)return;const timer=setTimeout(()=>setShowEmailGate(true),8000);return()=>clearTimeout(timer)},[unlocked]);

return(<div style={{minHeight:'100vh',padding:'5rem 1rem 3rem',position:'relative',zIndex:1}}><div style={{maxWidth:'500px',margin:'0 auto'}}>
<div className="fade-in" style={{display:'flex',justifyContent:'center',marginBottom:'1.5rem'}}><ResultCard ref={cardRef} result={result}/></div>
<div className="slide-up" style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem'}}><button onClick={downloadCard} disabled={downloading} className="mono" style={{flex:1,padding:'0.7rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'6px',fontSize:'0.65rem',fontWeight:700,cursor:'pointer'}}>{downloading?'...':'[ SAVE CARD ]'}</button><button onClick={shareTwitter} className="mono" style={{flex:1,padding:'0.7rem',background:'transparent',color:'#fff',border:'1px solid var(--border)',borderRadius:'6px',fontSize:'0.65rem',fontWeight:700,cursor:'pointer'}}>[ SHARE ]</button></div>

{profile.incomeSources&&profile.incomeSources.length>0&&<IncomeAnalysisCard incomeSources={profile.incomeSources} monthlyIncome={profile.monthly.income}/>}

{profile.budgetReality&&<BudgetRealityCard budgetReality={profile.budgetReality} monthlyIncome={profile.monthly.income}/>}

{profile.financialAdvisorTips&&profile.financialAdvisorTips.length>0&&<FinancialAdvisorCard tips={profile.financialAdvisorTips}/>}

{decisionStack&&decisionStack.length>0&&<MoneyMovesCard moves={decisionStack}/>}

<PlaybookCard archetype={archetype} playbook={playbook}/>

{traits.length>0&&(<div className="card-box slide-up"><div className="section-title">Your Traits</div><div style={{display:'flex',flexWrap:'wrap',gap:'0.4rem'}}>{traits.map((t,i)=>(<span key={i} className="trait-tag">{t.emoji} {t.text}</span>))}</div></div>)}

{behavioralPatterns&&behavioralPatterns.length>0&&<BehavioralPatternsCard patterns={behavioralPatterns}/>}

{/* Full-screen email gate overlay */}
{!unlocked&&showEmailGate&&(<div style={{position:'fixed',inset:0,zIndex:200,background:'rgba(10,10,10,0.92)',backdropFilter:'blur(12px)',display:'flex',alignItems:'center',justifyContent:'center',padding:'1.5rem',animation:'fadeIn .4s ease'}}>
<div style={{maxWidth:'420px',width:'100%',textAlign:'center'}}>
<pre className="mono" style={{fontSize:'0.5rem',lineHeight:1.4,color:'var(--accent)',marginBottom:'2rem',opacity:0.6}}>{`      Â·  â€¢  Â·     Â·  â€¢  Â·
    â€¢  âœ¦  â€¢  Â·  â€¢  âœ¦  â€¢
  Â·  â€¢  â—‰  âœ¦  â—‰  â€¢  Â·
    âœ¦  â€¢  â—‰  â—‰  â€¢  âœ¦`}</pre>
<h2 style={{fontSize:'1.5rem',fontWeight:600,color:'#fff',marginBottom:'0.75rem',lineHeight:1.3}}>You're halfway there.</h2>
<p style={{color:'var(--text2)',fontSize:'1rem',lineHeight:1.7,marginBottom:'0.5rem'}}>Your money personality is <span style={{color:archetype.color,fontWeight:600}}>{archetype.name}</span></p>
<p style={{color:'var(--dim)',fontSize:'0.88rem',lineHeight:1.7,marginBottom:'2rem'}}>Join the waitlist to unlock your full analysis â€” compound costs, blind spots, strengths, and your decision quality score.</p>
<form onSubmit={submitEmail} style={{marginBottom:'1.5rem'}}>
<input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="your@email.com" required style={{width:'100%',padding:'1rem 1.25rem',background:'rgba(255,255,255,0.05)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'10px',color:'#fff',fontSize:'0.95rem',outline:'none',marginBottom:'0.75rem',textAlign:'center'}}/>
<button type="submit" disabled={emailStatus==='sending'} className="mono" style={{width:'100%',padding:'1rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'10px',fontSize:'0.85rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.03em'}}>{emailStatus==='sending'?'Unlocking...':'[ UNLOCK FULL ANALYSIS ]'}</button>
</form>
<p style={{color:'var(--muted)',fontSize:'0.75rem',marginBottom:'1.5rem'}}>Free forever. No spam. Unsubscribe anytime.</p>
<button onClick={()=>setShowEmailGate(false)} style={{background:'none',border:'none',color:'var(--muted)',fontSize:'0.8rem',cursor:'pointer',textDecoration:'underline',padding:'0.5rem'}}>Skip for now</button>
</div></div>)}

{/* Blurred premium section â€” compound cost downwards */}
{!unlocked&&(<div className="slide-up" style={{position:'relative',marginTop:'0.5rem'}}>
<div style={{filter:'blur(6px)',pointerEvents:'none',userSelect:'none',opacity:0.5}}>
{compoundCosts&&compoundCosts.length>0&&<CompoundCostCard costs={compoundCosts}/>}
<div className="card-box"><div className="section-title">Your Strengths</div><div style={{display:'flex',flexDirection:'column',gap:'0.6rem'}}>{strengths.length>0?strengths.slice(0,2).map((s,i)=>(<div key={i} style={{display:'flex',alignItems:'center',gap:'0.6rem'}}><span style={{color:'var(--mint)',fontSize:'0.9rem'}}>âœ¦</span><span style={{color:'var(--text2)',fontSize:'0.9rem'}}>{s}</span></div>)):<p style={{color:'var(--dim)'}}>Analysis locked</p>}</div></div>
<div className="card-box"><div className="section-title">Your Blind Spots</div><div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>{blindSpots.length>0?blindSpots.slice(0,2).map((b,i)=>(<div key={i}><div style={{display:'flex',alignItems:'center',gap:'0.6rem',marginBottom:'0.2rem'}}><span style={{color:'var(--coral)',fontSize:'0.9rem'}}>âš </span><span style={{color:'#fff',fontSize:'0.9rem',fontWeight:500}}>{b.text}</span></div></div>)):<p style={{color:'var(--dim)'}}>Analysis locked</p>}</div></div>
{decisionScore&&<div className="card-box"><div className="section-title">How Well You Manage Money</div><div style={{textAlign:'center'}}><span className="mono" style={{fontSize:'2rem',fontWeight:700,color:'var(--accent)'}}>{decisionScore.score}/100</span></div></div>}
</div>
<div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',zIndex:2}}>
<button onClick={()=>setShowEmailGate(true)} className="mono" style={{padding:'1rem 2.5rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'10px',fontSize:'0.85rem',fontWeight:700,cursor:'pointer',boxShadow:'0 4px 24px rgba(232,200,114,0.3)'}}>[ UNLOCK FULL ANALYSIS ]</button>
</div></div>)}

{unlocked&&(<>
{compoundCosts&&compoundCosts.length>0&&<CompoundCostCard costs={compoundCosts}/>}

<div className="card-box slide-up"><div className="section-title">Your Strengths</div><div style={{display:'flex',flexDirection:'column',gap:'0.6rem'}}>{strengths.length>0?strengths.map((s,i)=>(<div key={i} style={{display:'flex',alignItems:'center',gap:'0.6rem'}}><span style={{color:'var(--mint)',fontSize:'0.9rem'}}>âœ¦</span><span style={{color:'var(--text2)',fontSize:'0.9rem'}}>{s}</span></div>)):<p style={{color:'var(--dim)',fontSize:'0.85rem'}}>Upload more transactions for detailed analysis</p>}</div></div>

<div className="card-box slide-up"><div className="section-title">Your Blind Spots</div><div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>{blindSpots.length>0?blindSpots.map((b,i)=>(<div key={i}><div style={{display:'flex',alignItems:'center',gap:'0.6rem',marginBottom:'0.2rem'}}><span style={{color:'var(--coral)',fontSize:'0.9rem'}}>âš </span><span style={{color:'#fff',fontSize:'0.9rem',fontWeight:500}}>{b.text}</span></div><p style={{color:'var(--dim)',fontSize:'0.8rem',marginLeft:'1.5rem'}}>{b.detail}</p></div>)):<p style={{color:'var(--dim)',fontSize:'0.85rem'}}>No major blind spots detected</p>}</div></div>

{decisionScore&&<DecisionScoreCard decisionScore={decisionScore} color={archetype.color}/>}

<div className="slide-up" style={{background:'rgba(114,232,176,0.08)',border:'1px solid rgba(114,232,176,0.2)',borderRadius:'10px',padding:'1.5rem',marginTop:'0.5rem',textAlign:'center'}}><p style={{color:'var(--mint)',fontSize:'1rem',fontWeight:600,marginBottom:'0.5rem'}}>You're on the list!</p><p style={{color:'var(--dim)',fontSize:'0.85rem',marginBottom:'1rem'}}>We'll notify you when BOCY launches.</p><a href={CONFIG.landingPage} className="mono" style={{display:'inline-block',padding:'0.8rem 1.5rem',background:'var(--accent)',color:'var(--bg)',borderRadius:'6px',fontSize:'0.75rem',fontWeight:700,textDecoration:'none'}}>[ LEARN MORE ABOUT BOCY ]</a></div>
</>)}

<div style={{textAlign:'center',marginTop:'2rem',paddingTop:'1.5rem',borderTop:'1px solid var(--border)'}}><a href={CONFIG.landingPage} style={{color:'var(--accent)',fontSize:'0.85rem',textDecoration:'none'}}>Learn more on bocy.io</a></div>
</div></div>)};

// APP
const App=()=>{const[screen,setScreen]=useState('landing');const[result,setResult]=useState(null);const[tlCode,setTlCode]=useState(null);
useEffect(()=>{initBg();const params=new URLSearchParams(window.location.search);const code=params.get('code');if(code){window.history.replaceState({},'',window.location.pathname);setTlCode(code);setScreen('upload')}},[]);
const handleData=r=>{setResult(r);setScreen('result')};return(<><Nav/>{screen==='landing'&&<Landing onStart={()=>setScreen('upload')}/>}{screen==='upload'&&<Upload onDone={handleData} onBack={()=>setScreen('landing')} tlCode={tlCode} onTlCodeUsed={()=>setTlCode(null)}/>}{screen==='result'&&<Result result={result}/>}</>)};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
