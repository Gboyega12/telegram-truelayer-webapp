<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOCY â€” Money Personality</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root{--bg:#0a0a0a;--surface:#111;--border:rgba(255,255,255,0.06);--text:#fff;--text2:#ccc;--dim:#888;--muted:#555;--accent:#E8C872;--coral:#E87272;--mint:#72E8B0;--lavender:#B272E8;--sky:#72B0E8}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;line-height:1.6}
        #root{min-height:100vh}
        #ascii-bg{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:0.4}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .fade-in{animation:fadeIn .6s ease forwards}
        .slide-up{animation:slideUp .5s ease forwards}
        .mono{font-family:'Space Mono',monospace}
        input::placeholder{color:var(--muted)}
        .section-title{font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:0.15em;color:var(--accent);margin-bottom:0.75rem;text-transform:uppercase}
        .card-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1.25rem;margin-bottom:1rem}
        .trust-badge{display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.75rem;background:rgba(114,232,176,0.06);border:1px solid rgba(114,232,176,0.15);border-radius:20px;font-size:0.7rem;color:var(--mint)}
        .file-chip{display:inline-flex;align-items:center;gap:0.4rem;padding:0.3rem 0.6rem;background:var(--surface);border:1px solid var(--border);border-radius:4px;font-size:0.7rem;color:var(--text2);margin:0.25rem}
        .file-chip button{background:none;border:none;color:var(--coral);cursor:pointer;padding:0;margin-left:0.3rem;font-size:0.8rem}
        .trait-tag{display:inline-flex;align-items:center;gap:0.3rem;padding:0.25rem 0.6rem;background:rgba(232,200,114,0.08);border:1px solid rgba(232,200,114,0.15);border-radius:12px;font-size:0.75rem;color:var(--accent);margin:0.2rem}
    </style>
</head>
<body>
<canvas id="ascii-bg"></canvas>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef}=React;
const CONFIG={googleScript:'https://script.google.com/macros/s/AKfycbxwOJ7DwZo4z3jiW25aH6nu5cC3qkIQs-GIizz0-xyeaoxe5Hdxg1TK3jxl_K1yJpIFRg/exec',landingPage:'https://www.bocy.io'};
const CLAUDE_CONFIG={endpoint:'/api/claude/enrich'};
const TRUELAYER_CONFIG={clientId:'bocymoneypersonality-a01ae4',authBaseUrl:'https://auth.truelayer.com',scope:'info accounts balance transactions cards',providers:'uk-ob-all uk-oauth-all',redirectUri:window.location.origin};
const UK_BENCHMARKS={subscriptions:{count:5,monthly:52},foodDelivery:68,savingsRate:11};

// PDF.js worker setup
if(typeof pdfjsLib!=='undefined'){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'}

const ARCHETYPE_ASCII={
subscription_collector:"   [=] [=] [=]\\n   [=] [=] [=]\\n   [=] [=] [=]",
convenience_seeker:"     ~[FAST]~\\n    /        \\\\\\n   [  O  O  ]",
lifestyle_investor:"    *  .  *\\n   . \\\\__/ .\\n    *  .  *",
quiet_builder:"       /\\\\\\n      /  \\\\\\n     / $$ \\\\\\n    /______\\\\",
edge_walker:"   ~~~~~~~~~\\n   | O  O |\\n   ~~~~~~~~~",
debt_juggler:"    O   O   O\\n     \\\\ | /\\n      \\\\|/\\n       *",
balanced_realist:"   +-------+\\n   |  ===  |\\n   +-------+",
impulse_surfer:"    ~ ~ ~ ~\\n   ~  $$$  ~\\n    ~ ~ ~ ~",
comfort_spender:"    .  *  .\\n   * (~~) *\\n    .  *  .",
side_hustler:"   $$  >>  $$\\n   ||  >>  ||\\n   $$  >>  $$"
};


// MERCHANT DATABASE - Strict isSubscription flags
const MERCHANT_DB={
// SUBSCRIPTIONS (isSubscription: true)
'netflix':{name:'Netflix',category:'Subscriptions',isSubscription:true},
'spotify':{name:'Spotify',category:'Subscriptions',isSubscription:true},
'disney+':{name:'Disney+',category:'Subscriptions',isSubscription:true},
'disney plus':{name:'Disney+',category:'Subscriptions',isSubscription:true},
'amazon prime video':{name:'Prime Video',category:'Subscriptions',isSubscription:true},
'prime video':{name:'Prime Video',category:'Subscriptions',isSubscription:true},
'apple tv':{name:'Apple TV+',category:'Subscriptions',isSubscription:true},
'apple music':{name:'Apple Music',category:'Subscriptions',isSubscription:true},
'youtube premium':{name:'YouTube Premium',category:'Subscriptions',isSubscription:true},
'youtube music':{name:'YouTube Music',category:'Subscriptions',isSubscription:true},
'now tv':{name:'NOW TV',category:'Subscriptions',isSubscription:true},
'audible':{name:'Audible',category:'Subscriptions',isSubscription:true},
'openai':{name:'ChatGPT',category:'Subscriptions',isSubscription:true},
'chatgpt':{name:'ChatGPT',category:'Subscriptions',isSubscription:true},
'anthropic':{name:'Claude',category:'Subscriptions',isSubscription:true},
'claude':{name:'Claude',category:'Subscriptions',isSubscription:true},
'midjourney':{name:'Midjourney',category:'Subscriptions',isSubscription:true},
'adobe':{name:'Adobe',category:'Subscriptions',isSubscription:true},
'canva':{name:'Canva',category:'Subscriptions',isSubscription:true},
'figma':{name:'Figma',category:'Subscriptions',isSubscription:true},
'notion':{name:'Notion',category:'Subscriptions',isSubscription:true},
'microsoft 365':{name:'Microsoft 365',category:'Subscriptions',isSubscription:true},
'office 365':{name:'Microsoft 365',category:'Subscriptions',isSubscription:true},
'google one':{name:'Google One',category:'Subscriptions',isSubscription:true},
'dropbox':{name:'Dropbox',category:'Subscriptions',isSubscription:true},
'nordvpn':{name:'NordVPN',category:'Subscriptions',isSubscription:true},
'expressvpn':{name:'ExpressVPN',category:'Subscriptions',isSubscription:true},
'lovable':{name:'Lovable',category:'Subscriptions',isSubscription:true},
'cursor':{name:'Cursor',category:'Subscriptions',isSubscription:true},
'headspace':{name:'Headspace',category:'Subscriptions',isSubscription:true},
'calm':{name:'Calm',category:'Subscriptions',isSubscription:true},
'strava':{name:'Strava',category:'Subscriptions',isSubscription:true},
'peloton':{name:'Peloton',category:'Subscriptions',isSubscription:true},
'pure gym':{name:'PureGym',category:'Subscriptions',isSubscription:true},
'puregym':{name:'PureGym',category:'Subscriptions',isSubscription:true},
'the gym':{name:'The Gym',category:'Subscriptions',isSubscription:true},
'david lloyd':{name:'David Lloyd',category:'Subscriptions',isSubscription:true},
'skillshare':{name:'Skillshare',category:'Subscriptions',isSubscription:true},
'masterclass':{name:'MasterClass',category:'Subscriptions',isSubscription:true},
'duolingo':{name:'Duolingo',category:'Subscriptions',isSubscription:true},

// DEBT PAYMENTS (isSubscription: false)
'american express':{name:'American Express',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'amex':{name:'American Express',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'capital one':{name:'Capital One',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'capitalone':{name:'Capital One',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'barclaycard':{name:'Barclaycard',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'mbna':{name:'MBNA',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'aqua':{name:'Aqua',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'vanquis':{name:'Vanquis',category:'Debt Payments',subcategory:'Credit Card',isSubscription:false},
'klarna':{name:'Klarna',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'clearpay':{name:'Clearpay',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'afterpay':{name:'Afterpay',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'zilch':{name:'Zilch',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},
'laybuy':{name:'Laybuy',category:'Debt Payments',subcategory:'BNPL',isSubscription:false},

// TRANSFERS (isSubscription: false)
'transfer to':{name:'Transfer',category:'Transfers',isSubscription:false},
'transfer from':{name:'Transfer',category:'Transfers',isSubscription:false},
'standing order':{name:'Standing Order',category:'Transfers',isSubscription:false},
'faster payment':{name:'Faster Payment',category:'Transfers',isSubscription:false},
'pot transfer':{name:'Pot Transfer',category:'Transfers',isSubscription:false},

// TRANSPORT (isSubscription: false)
'tfl':{name:'TfL',category:'Transport',isSubscription:false},
'oyster':{name:'Oyster',category:'Transport',isSubscription:false},
'trainline':{name:'Trainline',category:'Transport',isSubscription:false},
'uber':{name:'Uber',category:'Transport',isSubscription:false},
'bolt':{name:'Bolt',category:'Transport',isSubscription:false},
'addison lee':{name:'Addison Lee',category:'Transport',isSubscription:false},

// FOOD DELIVERY (isSubscription: false) â€” delivery apps ONLY, NOT grocery shops
'deliveroo':{name:'Deliveroo',category:'Food Delivery',isSubscription:false},
'uber eats':{name:'Uber Eats',category:'Food Delivery',isSubscription:false},
'ubereats':{name:'Uber Eats',category:'Food Delivery',isSubscription:false},
'just eat':{name:'Just Eat',category:'Food Delivery',isSubscription:false},
'justeat':{name:'Just Eat',category:'Food Delivery',isSubscription:false},
'gousto':{name:'Gousto',category:'Food Delivery',isSubscription:false},
'hello fresh':{name:'HelloFresh',category:'Food Delivery',isSubscription:false},
'hellofresh':{name:'HelloFresh',category:'Food Delivery',isSubscription:false},

// GROCERIES â€” supermarkets and grocery shops, NOT food delivery
'tesco':{name:'Tesco',category:'Groceries',isSubscription:false},
'sainsbury':{name:'Sainsburys',category:'Groceries',isSubscription:false},
'asda':{name:'ASDA',category:'Groceries',isSubscription:false},
'morrisons':{name:'Morrisons',category:'Groceries',isSubscription:false},
'aldi':{name:'Aldi',category:'Groceries',isSubscription:false},
'lidl':{name:'Lidl',category:'Groceries',isSubscription:false},
'waitrose':{name:'Waitrose',category:'Groceries',isSubscription:false},
'ocado':{name:'Ocado',category:'Groceries',isSubscription:false},
'iceland':{name:'Iceland',category:'Groceries',isSubscription:false},
'marks spencer':{name:'M&S Food',category:'Groceries',isSubscription:false},
'm&s':{name:'M&S Food',category:'Groceries',isSubscription:false},
'co-op':{name:'Co-op',category:'Groceries',isSubscription:false},
'coop':{name:'Co-op',category:'Groceries',isSubscription:false},
'whole foods':{name:'Whole Foods',category:'Groceries',isSubscription:false},
'getir':{name:'Getir',category:'Groceries',isSubscription:false},
'gorillas':{name:'Gorillas',category:'Groceries',isSubscription:false},

// EATING OUT
'starbucks':{name:'Starbucks',category:'Eating Out',isSubscription:false},
'costa':{name:'Costa',category:'Eating Out',isSubscription:false},
'pret':{name:'Pret',category:'Eating Out',isSubscription:false},
'greggs':{name:'Greggs',category:'Eating Out',isSubscription:false},
'mcdonalds':{name:'McDonalds',category:'Eating Out',isSubscription:false},
'mcdonald':{name:'McDonalds',category:'Eating Out',isSubscription:false},
'nandos':{name:'Nandos',category:'Eating Out',isSubscription:false},
'nando':{name:'Nandos',category:'Eating Out',isSubscription:false},
'wagamama':{name:'Wagamama',category:'Eating Out',isSubscription:false},
'kfc':{name:'KFC',category:'Eating Out',isSubscription:false},
'burger king':{name:'Burger King',category:'Eating Out',isSubscription:false},
'five guys':{name:'Five Guys',category:'Eating Out',isSubscription:false},
'subway':{name:'Subway',category:'Eating Out',isSubscription:false},
'pizza express':{name:'Pizza Express',category:'Eating Out',isSubscription:false},
'pizza hut':{name:'Pizza Hut',category:'Eating Out',isSubscription:false},
'dominos':{name:'Dominos',category:'Eating Out',isSubscription:false},
'wetherspoon':{name:'Wetherspoons',category:'Eating Out',isSubscription:false},
'itsu':{name:'Itsu',category:'Eating Out',isSubscription:false},
'leon':{name:'Leon',category:'Eating Out',isSubscription:false},
'tortilla':{name:'Tortilla',category:'Eating Out',isSubscription:false},
'gail':{name:'Gails',category:'Eating Out',isSubscription:false},
'caffe nero':{name:'Caffe Nero',category:'Eating Out',isSubscription:false},
'nero':{name:'Caffe Nero',category:'Eating Out',isSubscription:false},
'eat':{name:'EAT.',category:'Eating Out',isSubscription:false},
'franco manca':{name:'Franco Manca',category:'Eating Out',isSubscription:false},
'dishoom':{name:'Dishoom',category:'Eating Out',isSubscription:false},
'yo sushi':{name:'Yo! Sushi',category:'Eating Out',isSubscription:false},

// SHOPPING
'amazon':{name:'Amazon',category:'Shopping',isSubscription:false},
'amzn':{name:'Amazon',category:'Shopping',isSubscription:false},
'asos':{name:'ASOS',category:'Shopping',isSubscription:false},
'zara':{name:'Zara',category:'Shopping',isSubscription:false},
'ikea':{name:'IKEA',category:'Shopping',isSubscription:false},
'h&m':{name:'H&M',category:'Shopping',isSubscription:false},
'primark':{name:'Primark',category:'Shopping',isSubscription:false},
'uniqlo':{name:'Uniqlo',category:'Shopping',isSubscription:false},
'john lewis':{name:'John Lewis',category:'Shopping',isSubscription:false},
'next':{name:'Next',category:'Shopping',isSubscription:false},
'tk maxx':{name:'TK Maxx',category:'Shopping',isSubscription:false},
'tkmaxx':{name:'TK Maxx',category:'Shopping',isSubscription:false},
'ebay':{name:'eBay',category:'Shopping',isSubscription:false},
'shein':{name:'Shein',category:'Shopping',isSubscription:false},
'boohoo':{name:'Boohoo',category:'Shopping',isSubscription:false},
'currys':{name:'Currys',category:'Shopping',isSubscription:false},
'argos':{name:'Argos',category:'Shopping',isSubscription:false},
'apple store':{name:'Apple Store',category:'Shopping',isSubscription:false},
'nike':{name:'Nike',category:'Shopping',isSubscription:false},
'adidas':{name:'Adidas',category:'Shopping',isSubscription:false},
'gymshark':{name:'Gymshark',category:'Shopping',isSubscription:false},
'decathlon':{name:'Decathlon',category:'Shopping',isSubscription:false},
'waterstones':{name:'Waterstones',category:'Shopping',isSubscription:false},
'boots':{name:'Boots',category:'Health',isSubscription:false},
'superdrug':{name:'Superdrug',category:'Health',isSubscription:false},

// ENTERTAINMENT
'odeon':{name:'Odeon',category:'Entertainment',isSubscription:false},
'cineworld':{name:'Cineworld',category:'Entertainment',isSubscription:false},
'vue cinema':{name:'Vue',category:'Entertainment',isSubscription:false},
'curzon':{name:'Curzon',category:'Entertainment',isSubscription:false},
'steam':{name:'Steam',category:'Entertainment',isSubscription:false},
'playstation':{name:'PlayStation',category:'Entertainment',isSubscription:false},
'xbox':{name:'Xbox',category:'Entertainment',isSubscription:false},
'nintendo':{name:'Nintendo',category:'Entertainment',isSubscription:false},
'ticketmaster':{name:'Ticketmaster',category:'Entertainment',isSubscription:false},
'dice':{name:'DICE',category:'Entertainment',isSubscription:false},
'eventbrite':{name:'Eventbrite',category:'Entertainment',isSubscription:false},

// BILLS
'british gas':{name:'British Gas',category:'Bills',isSubscription:false},
'octopus energy':{name:'Octopus Energy',category:'Bills',isSubscription:false},
'octopus':{name:'Octopus Energy',category:'Bills',isSubscription:false},
'bulb':{name:'Bulb',category:'Bills',isSubscription:false},
'ovo energy':{name:'OVO Energy',category:'Bills',isSubscription:false},
'edf':{name:'EDF',category:'Bills',isSubscription:false},
'scottish power':{name:'Scottish Power',category:'Bills',isSubscription:false},
'council tax':{name:'Council Tax',category:'Bills',isSubscription:false},
'rent':{name:'Rent',category:'Bills',isSubscription:false},
'mortgage':{name:'Mortgage',category:'Bills',isSubscription:false},
'thames water':{name:'Thames Water',category:'Bills',isSubscription:false},
'water':{name:'Water',category:'Bills',isSubscription:false},
'bt ':{name:'BT',category:'Bills',isSubscription:false},
'sky ':{name:'Sky',category:'Bills',isSubscription:false},
'virgin media':{name:'Virgin Media',category:'Bills',isSubscription:false},
'ee ':{name:'EE',category:'Bills',isSubscription:false},
'vodafone':{name:'Vodafone',category:'Bills',isSubscription:false},
'o2 ':{name:'O2',category:'Bills',isSubscription:false},
'three ':{name:'Three',category:'Bills',isSubscription:false},
'giffgaff':{name:'Giffgaff',category:'Bills',isSubscription:false},
'tv licence':{name:'TV Licence',category:'Bills',isSubscription:false},
'insurance':{name:'Insurance',category:'Bills',isSubscription:false},

// HEALTH
'bupa':{name:'Bupa',category:'Health',isSubscription:false},
'dentist':{name:'Dentist',category:'Health',isSubscription:false},
'pharmacy':{name:'Pharmacy',category:'Health',isSubscription:false},
'optician':{name:'Optician',category:'Health',isSubscription:false},
'specsavers':{name:'Specsavers',category:'Health',isSubscription:false},

// INCOME
'salary':{name:'Salary',category:'Income',isSubscription:false},
'wages':{name:'Wages',category:'Income',isSubscription:false},
'bacs':{name:'BACS',category:'Income',isSubscription:false},
'refund':{name:'Refund',category:'Income',isSubscription:false},
'interest':{name:'Interest',category:'Income',isSubscription:false},
'dividend':{name:'Dividend',category:'Income',isSubscription:false},
'hmrc':{name:'HMRC',category:'Income',isSubscription:false},
'tax refund':{name:'Tax Refund',category:'Income',isSubscription:false}
};


// ARCHETYPES â€” 10 distinct money personalities
const ARCHETYPES={
subscription_collector:{name:'The Subscription Collector',emoji:'ðŸ“¦',color:'#B272E8',vibe:"Your card gets more monthly exercise than you",description:"You have assembled quite the digital empire â€” streaming services, apps, memberships. Each one seemed essential at signup, but together they are quietly reshaping your bank balance.",genMoneyStory:p=>{const subs=p.subscriptions||[];const total=p.monthly.subscriptions;const names=subs.slice(0,4).map(s=>s.merchant).join(', ');return`You are paying for ${subs.length} subscriptions totalling Â£${total}/month (Â£${total*12}/year). That includes ${names}${subs.length>4?' and '+(subs.length-4)+' more':''}. Each one felt worth it at the time. Together, they represent ${p.monthly.income>0?Math.round((total/p.monthly.income)*100)+'% of your income':'a significant outgoing'}. The question is not whether you can afford them â€” it is whether you actually use them all.`},triggers:p=>p.metrics.subscriptionCount>=5||p.monthly.subscriptions>70},
convenience_seeker:{name:'The Convenience Seeker',emoji:'ðŸ›µ',color:'#E87272',vibe:"Time is money, so you spend money on time",description:"Deliveroo, Uber, meal kits â€” your phone is basically a personal assistant. You have optimised your life for convenience, but at a premium.",genMoneyStory:p=>{const fd=p.monthly.foodDelivery;const tr=p.monthly.transport||0;const topDel=p.topMerchants?.find(m=>['Deliveroo','Uber Eats','Just Eat'].includes(m.merchant));return`You are spending Â£${fd}/month on food delivery${tr>80?' and Â£'+tr+'/month on transport':''} â€” that is Â£${(fd+tr)*12}/year on convenience alone.${topDel?' Your most frequent is '+topDel.merchant+' ('+topDel.count+' orders).':''} Cooking at home would save you roughly Â£${Math.round(fd*0.4*12)}/year, but you are paying for time, not just food.`},triggers:p=>(p.monthly.foodDelivery+(p.monthly.transport||0))>120},
lifestyle_investor:{name:'The Lifestyle Investor',emoji:'âœ¨',color:'#E8C872',vibe:"You are not spending, you are curating a life",description:"Shopping, dining, experiences â€” these are not expenses in your mind. They are investments in the version of yourself you are building.",genMoneyStory:p=>{const shop=p.monthly.shopping||0;const ent=p.monthly.entertainment||0;const eat=p.monthly.eatingOut||0;const total=shop+ent+eat;return`You are putting Â£${total}/month (Â£${total*12}/year) into lifestyle spending â€” Â£${shop} on shopping${ent>0?', Â£'+ent+' on entertainment':''}${eat>0?', Â£'+eat+' eating out':''}. ${p.monthly.income>0?'That is '+Math.round((total/p.monthly.income)*100)+'% of your income going to how you live, not just what you need.':'That is a significant investment in your quality of life.'} You know what you like and you are willing to pay for it.`},triggers:p=>((p.monthly.shopping||0)+(p.monthly.entertainment||0)+(p.monthly.eatingOut||0))>200},
quiet_builder:{name:'The Quiet Builder',emoji:'ðŸŒ±',color:'#72E8B0',vibe:"Your future self is already thanking you",description:"While others chase the next dopamine hit, you are quietly building wealth. Your discipline will compound in ways most people do not understand yet.",genMoneyStory:p=>{const sr=p.metrics.savingsRate;const surplus=p.monthly.surplus;return`You are saving ${sr}% of your income â€” Â£${surplus}/month, or roughly Â£${surplus*12}/year. That puts you well above the UK average savings rate of ${UK_BENCHMARKS.savingsRate}%.${p.metrics.subscriptionCount<=3?' You keep subscriptions lean (just '+p.metrics.subscriptionCount+').':''} ${p.metrics.debtAccountCount===0?'You carry no debt.':'You are managing debt while still saving â€” that takes discipline.'} At this rate, in 5 years you will have set aside around Â£${Math.round(surplus*60).toLocaleString()} before any investment growth.`},triggers:p=>p.metrics.savingsRate>20},
edge_walker:{name:'The Edge Walker',emoji:'ðŸŽ­',color:'#E87272',vibe:"Living life one payday at a time",description:"Your income and spending are in a constant dance, sometimes a little too close for comfort. You make it work, but there is no buffer.",genMoneyStory:p=>{const sr=p.metrics.savingsRate;const surplus=p.monthly.surplus;const topCat=p.categories[0];return`Your savings rate is ${sr}%${surplus>0?' â€” roughly Â£'+surplus+'/month left over':' â€” you are spending almost everything you earn'}. Your biggest outgoing is ${topCat?topCat.name+' (Â£'+topCat.total+')':'hard to pin down'}. ${p.monthly.foodDelivery>50?'Food delivery alone is costing you Â£'+p.monthly.foodDelivery+'/month. ':''}This is not about being irresponsible â€” it is about the gap between cost of living and what you earn. One unexpected bill could tip the balance.`},triggers:p=>p.metrics.savingsRate<5&&p.metrics.savingsRate>=-10},
debt_juggler:{name:'The Debt Juggler',emoji:'ðŸŽª',color:'#E8A872',vibe:"Keeping all the balls in the air",description:"Credit cards, BNPL, maybe a loan â€” you are managing multiple financial obligations with precision. The question is whether you are juggling or drowning.",genMoneyStory:p=>{const dp=p.debtPayments||[];const total=p.monthly.debtPayments;const names=dp.slice(0,3).map(d=>d.merchant).join(', ');const pct=p.monthly.income>0?Math.round((total/p.monthly.income)*100):0;return`You have ${dp.length} debt obligation${dp.length>1?'s':''}: ${names}. That is Â£${total}/month (Â£${total*12}/year) â€” ${pct}% of your income going to servicing debt.${p.metrics.bnplCount>0?' You have '+p.metrics.bnplCount+' active BNPL account'+(p.metrics.bnplCount>1?'s':'')+'.':''} ${pct>25?'That is a heavy debt load. Consolidation or faster repayment could save you significantly in interest.':'You are keeping it manageable, but clearing these would free up real monthly cashflow.'}`},triggers:p=>p.metrics.debtAccountCount>=3||(p.monthly.debtPayments>0&&p.monthly.debtPayments>p.monthly.income*0.15)},
impulse_surfer:{name:'The Impulse Surfer',emoji:'âš¡',color:'#E8D572',vibe:"See it. Want it. Tap. Done.",description:"Your spending spikes unpredictably â€” a calm week followed by a burst. Shopping is emotional, spontaneous, and satisfying in the moment.",genMoneyStory:p=>{const shop=p.monthly.shopping||0;const topShop=p.topMerchants?.find(m=>['Amazon','ASOS','Zara','IKEA'].includes(m.merchant));return`You are spending Â£${shop}/month on shopping (Â£${shop*12}/year).${topShop?' '+topShop.merchant+' alone accounts for '+topShop.count+' transactions.':''} Your spending pattern suggests impulse â€” not planned purchases, but reactive ones. The average transaction size and frequency point to someone who shops as a response to how they feel, not what they need. That is not a moral failing â€” but it is expensive.`},triggers:p=>{const shop=p.monthly.shopping||0;const topShop=p.topMerchants?.filter(m=>['Amazon','ASOS','Zara','IKEA'].includes(m.merchant))||[];const highFreq=topShop.some(m=>m.count>6);return shop>120&&(highFreq||shop>200)}},
comfort_spender:{name:'The Comfort Spender',emoji:'â˜•',color:'#C8A872',vibe:"A little treat never hurt anyone... right?",description:"Coffee runs, meals out, small luxuries â€” your spending is death by a thousand cuts. Each purchase is tiny, but they add up to a lifestyle.",genMoneyStory:p=>{const eat=p.monthly.eatingOut||0;const fd=p.monthly.foodDelivery||0;const groc=p.monthly.groceries||0;const coffeeMerch=p.topMerchants?.filter(m=>['Starbucks','Costa','Pret','Greggs'].includes(m.merchant))||[];const coffeeTotal=coffeeMerch.reduce((s,m)=>s+m.total,0);return`You are spending Â£${eat}/month eating out${coffeeTotal>0?' (including an estimated Â£'+Math.round(coffeeTotal)+' on coffee and quick bites)':''}${fd>30?', plus Â£'+fd+'/month on delivery':''}.${groc>0?' Groceries add another Â£'+groc+'.':''} Your food-related spending totals roughly Â£${eat+fd+groc}/month (Â£${(eat+fd+groc)*12}/year). You are a grazer â€” frequent, small transactions that feel harmless individually but form your biggest spending category.`},triggers:p=>{const eat=p.monthly.eatingOut||0;const coffeeMerch=p.topMerchants?.filter(m=>['Starbucks','Costa','Pret','Greggs'].includes(m.merchant))||[];return eat>100||coffeeMerch.length>=2}},
side_hustler:{name:'The Side Hustler',emoji:'ðŸ’°',color:'#72E8D5',vibe:"Multiple income streams, one ambitious brain",description:"You have income coming from more than one place. Whether it is freelancing, selling, or investing â€” you understand that one salary is a single point of failure.",genMoneyStory:p=>{const inc=p.monthly.income;const sr=p.metrics.savingsRate;return`Your monthly income of Â£${inc} includes multiple sources â€” you are not relying on a single paycheck.${sr>15?' You are saving '+sr+'% of your total income, which shows real financial awareness.':' Despite the extra income, your savings rate is '+sr+'% â€” the hustle is funding lifestyle, not reserves.'} ${p.monthly.subscriptions>50?'You invest Â£'+p.monthly.subscriptions+'/month in tools and subscriptions â€” the cost of doing business.':'You keep your overheads lean.'} The question is whether the side income is growing or if you are running to stand still.`},triggers:p=>{const incTxs=p.incomeStreams||0;return incTxs>=2&&p.monthly.income>0}},
balanced_realist:{name:'The Balanced Realist',emoji:'âš–ï¸',color:'#72B0E8',vibe:"Boring is your financial superpower",description:"No extreme patterns here â€” just steady, sensible money management. You will not make the news, but you will make retirement.",genMoneyStory:p=>{const sr=p.metrics.savingsRate;const surplus=p.monthly.surplus;return`You are saving ${sr}% of your income (Â£${surplus}/month). Your spending is spread across categories without any single area dominating.${p.metrics.subscriptionCount>0?' You have '+p.metrics.subscriptionCount+' subscription'+(p.metrics.subscriptionCount>1?'s':'')+' (Â£'+p.monthly.subscriptions+'/mo).':''} ${p.metrics.debtAccountCount===0?'You carry no debt obligations.':'You have '+p.metrics.debtAccountCount+' debt payment'+(p.metrics.debtAccountCount>1?'s':'')+' but they are proportionate.'} This is what quiet financial confidence looks like. The risk is complacency â€” being "fine" can mean missing opportunities to be great.`},triggers:p=>true}
};

// TRAITS
const SUB_TRAITS=[
{id:'delivery',emoji:'ðŸ•',text:'Delivery-dependent',check:p=>p.monthly.foodDelivery>80},
{id:'credit',emoji:'ðŸ’³',text:'Credit-active',check:p=>p.metrics.creditCardCount>=2},
{id:'bnpl',emoji:'ðŸ’¸',text:'BNPL user',check:p=>p.metrics.bnplCount>=1},
{id:'commuter',emoji:'ðŸš‚',text:'Commuter',check:p=>p.monthly.transport>150},
{id:'streaming',emoji:'ðŸ“º',text:'Streaming heavy',check:p=>p.metrics.streamingCount>=3},
{id:'techsub',emoji:'ðŸ’»',text:'Tech subscriber',check:p=>p.subscriptions&&p.subscriptions.some(s=>['ChatGPT','Claude','Midjourney','Cursor','Lovable'].includes(s.merchant))},
{id:'coffee',emoji:'â˜•',text:'Coffee regular',check:p=>p.topMerchants&&p.topMerchants.some(m=>['Starbucks','Costa','Pret'].includes(m.merchant)&&m.count>8)},
{id:'impulse',emoji:'âš¡',text:'Impulse buyer',check:p=>(p.monthly.shopping||0)>150},
{id:'foodie',emoji:'ðŸ½ï¸',text:'Foodie',check:p=>((p.monthly.eatingOut||0)+p.monthly.foodDelivery)>150},
{id:'saver',emoji:'ðŸŒ±',text:'Active saver',check:p=>p.metrics.savingsRate>25},
{id:'grocery',emoji:'ðŸ›’',text:'Home cook',check:p=>(p.monthly.groceries||0)>(p.monthly.foodDelivery||0)*2&&(p.monthly.groceries||0)>100}
];

// RULES
const STRENGTH_RULES=[
{text:'Strong savings discipline',check:p=>p.metrics.savingsRate>15},
{text:'Debt-free lifestyle',check:p=>p.metrics.debtAccountCount===0},
{text:'Keeps subscriptions lean',check:p=>p.metrics.subscriptionCount<=4},
{text:'Conscious grocery shopper',check:p=>(p.monthly.groceries||0)>(p.monthly.foodDelivery||0)*1.5},
{text:'Resists delivery temptation',check:p=>(p.monthly.foodDelivery||0)<UK_BENCHMARKS.foodDelivery}
];

const BLINDSPOT_RULES=[
{text:'Subscription creep risk',detail:'Multiple services adding up silently',check:p=>p.metrics.subscriptionCount>=6},
{text:'Delivery dependency',detail:'Convenience premium eating into savings',check:p=>(p.monthly.foodDelivery||0)>100},
{text:'Multiple BNPL accounts',detail:'Buy-now-pay-later spreading thin',check:p=>p.metrics.bnplCount>=2},
{text:'Credit card stacking',detail:'Managing multiple credit lines',check:p=>p.metrics.creditCardCount>=3},
{text:'Savings rate below target',detail:'Under the recommended 20%',check:p=>p.metrics.savingsRate<10&&p.metrics.savingsRate>=0}
];


// PDF TEXT EXTRACTION
const extractPDFText=async(file)=>{
const arrayBuffer=await file.arrayBuffer();
const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
const maxPages=Math.min(pdf.numPages,30);
const lines=[];
for(let i=1;i<=maxPages;i++){
const page=await pdf.getPage(i);
const content=await page.getTextContent();
const lineMap={};
content.items.forEach(item=>{
const y=Math.round(item.transform[5]);
if(!lineMap[y])lineMap[y]=[];
lineMap[y].push({x:item.transform[4],text:item.str});
});
const sortedYs=Object.keys(lineMap).map(Number).sort((a,b)=>b-a);
sortedYs.forEach(y=>{
const items=lineMap[y].sort((a,b)=>a.x-b.x);
const line=items.map(it=>it.text).join('  ');
if(line.trim())lines.push(line);
});
}
return lines.join('\n');
};


// CLAUDE API HELPER â€” calls serverless backend, never exposes API key in browser
const callClaude=async(prompt,maxTokens=2048)=>{
try{
const resp=await fetch(CLAUDE_CONFIG.endpoint,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({prompt,max_tokens:maxTokens})
});
if(!resp.ok)return null;
const data=await resp.json();
return data.text||null;
}catch(e){return null}
};


// ENRICHMENT ENGINE
class EnrichmentEngine{
async enrich(rawTexts,onStatus){
const allTx=[];

// Step 1: Parse all texts
onStatus?.('Parsing your files...');
for(const text of rawTexts){
let txs=this.parseCSV(text);
if(txs.length<3&&text.length>100){
// Likely a PDF or poorly formatted file â€” use Claude to extract structured data
onStatus?.('Extracting transactions...');
const structured=await this.structureWithClaude(text);
if(structured){const parsed=this.parseCSV(structured);if(parsed.length>txs.length)txs=parsed}
}
allTx.push(...txs);
}

allTx.sort((a,b)=>(a.date||0)-(b.date||0));

// Step 2: Local merchant identification (first pass)
onStatus?.('Identifying merchants...');
let enriched=allTx.map(tx=>this.enrichTransaction(tx));

// Step 3: Categorise uncertain transactions with Claude
const uncertain=enriched.filter(tx=>tx.confidence==='low'&&!tx.isIncome&&!tx.isTransfer);
if(uncertain.length>0){onStatus?.('Categorising data...');enriched=await this.verifyWithClaude(enriched,onStatus)}

// Step 4: Build profile
onStatus?.('Building your profile...');
const recurring=this.detectRecurring(enriched);
const profile=this.buildProfile(enriched,recurring);
const archetype=this.determineArchetype(profile);
const traits=SUB_TRAITS.filter(t=>{try{return t.check(profile)}catch{return false}}).slice(0,4);
const strengths=STRENGTH_RULES.filter(r=>{try{return r.check(profile)}catch{return false}}).slice(0,3).map(r=>r.text);
const blindSpots=BLINDSPOT_RULES.filter(r=>{try{return r.check(profile)}catch{return false}}).slice(0,3);
const peerComparison=this.calcPeerComparison(profile);
const insights=this.genInsights(profile);
const potentialSavings=this.calcSavings(profile);
return{profile,archetype,traits,strengths,blindSpots,peerComparison,insights,potentialSavings,subscriptions:profile.subscriptions,enrichedTransactions:enriched};
}

// Use Claude to extract CSV from unstructured text (e.g. PDF bank statements)
async structureWithClaude(rawText){
const trimmed=rawText.substring(0,12000);
const prompt=`You are a UK bank statement parser. Extract all transactions from this bank statement text and return them as CSV.\n\nRules:\n- Headers must be: Date,Description,Amount\n- Date format: DD/MM/YYYY\n- Amount: negative for debits/spending, positive for credits/income\n- Only return the CSV data, no explanation or markdown\n- Include every transaction you can identify\n\nBank statement text:\n${trimmed}`;
const result=await callClaude(prompt,4096);
return result;
}

// Send low-confidence transactions to Claude for categorisation (parallel batches)
async verifyWithClaude(enrichedTxs,onStatus){
const toVerify=enrichedTxs.filter(tx=>tx.confidence==='low'&&!tx.isIncome&&!tx.isTransfer&&Math.abs(tx.amount)>0);
if(toVerify.length===0)return enrichedTxs;

const BATCH_SIZE=40;
const batches=[];
for(let i=0;i<toVerify.length;i+=BATCH_SIZE)batches.push(toVerify.slice(i,i+BATCH_SIZE));

onStatus?.('Categorising '+toVerify.length+' transactions...');

const processBatch=async(batch)=>{
const txList=batch.map((tx,i)=>`${i+1}. "${tx.description}" Â£${Math.abs(tx.amount).toFixed(2)}`).join('\n');
const prompt=`You are a UK bank transaction categoriser. Categorise these transactions from their raw bank descriptions.

CATEGORIES:
- Groceries: supermarkets (Tesco, Sainsburys, ASDA, Aldi, Lidl, Morrisons, Waitrose, Ocado, M&S, Co-op)
- Food Delivery: delivery apps (Deliveroo, Uber Eats, Just Eat) and meal kits (Gousto, HelloFresh)
- Eating Out: restaurants, cafes, coffee shops, pubs, fast food
- Subscriptions: recurring digital services (Netflix, Spotify, gym, software). isSubscription=true
- Debt Payments: credit cards (Amex, Barclaycard), BNPL (Klarna, Clearpay)
- Bills: utilities, rent, mortgage, phone, broadband, council tax, insurance
- Transport: TfL, Uber rides, Bolt, trains
- Shopping: retail (Amazon, ASOS, Zara, IKEA, H&M, eBay)
- Entertainment: cinema, gaming, events, tickets
- Health: pharmacy, dentist, optician
- Other: if none fit

Return a JSON array. Each object: {"index":N,"merchant":"Clean Name","category":"Category","isSubscription":false}
Return ONLY the JSON array.

Transactions:
${txList}`;
try{
const result=await callClaude(prompt,4000);
if(!result)return;
const jsonMatch=result.match(/\[[\s\S]*\]/);
if(jsonMatch){
const cats=JSON.parse(jsonMatch[0]);
cats.forEach(cat=>{
const idx=(cat.index||0)-1;
if(idx>=0&&idx<batch.length){
if(cat.merchant)batch[idx].merchant=cat.merchant;
if(cat.category)batch[idx].category=cat.category;
if(typeof cat.isSubscription==='boolean')batch[idx].isSubscription=cat.isSubscription;
batch[idx].isDebt=cat.category==='Debt Payments';
batch[idx].isIncome=cat.category==='Income';
batch[idx].isTransfer=cat.category==='Transfers';
batch[idx].confidence='high';
}
});
}
}catch(e){/* Fall back to local results for this batch */}
};

// Run all batches in parallel
await Promise.all(batches.map(b=>processBatch(b)));
return enrichedTxs;
}

parseCSV(raw){
const lines=raw.trim().split('\n'),txs=[];
let headers=[],start=0;
for(let i=0;i<Math.min(10,lines.length);i++){
const l=lines[i].toLowerCase();
if(['date','description','amount','debit','credit'].some(k=>l.includes(k))){
headers=lines[i].split(',').map(h=>h.toLowerCase().replace(/"/g,'').trim());
start=i+1;break;
}}
const di=headers.findIndex(h=>h.includes('date'));
const desc=headers.findIndex(h=>['description','transaction','details','narrative','merchant','name'].some(k=>h.includes(k)));
const ai=headers.findIndex(h=>h.includes('amount'));
const deb=headers.findIndex(h=>['debit','out','money out'].some(k=>h.includes(k)));
const cred=headers.findIndex(h=>['credit','in','money in'].some(k=>h.includes(k)));

for(let i=start;i<lines.length;i++){
if(!lines[i].trim())continue;
const cols=this.parseLine(lines[i]);
if(cols.length<2)continue;
let amt=0;
if(ai>=0&&cols[ai])amt=parseFloat(cols[ai].replace(/[^0-9.-]/g,''))||0;
else{
const db=deb>=0?parseFloat((cols[deb]||'').replace(/[^0-9.-]/g,''))||0:0;
const cr=cred>=0?parseFloat((cols[cred]||'').replace(/[^0-9.-]/g,''))||0:0;
amt=cr-db;if(db>0&&cr===0)amt=-db;
}
const d=cols[di>=0?di:0]||'';
const tx={date:this.parseDate(d),description:cols[desc>=0?desc:1]||'',descNorm:this.norm(cols[desc>=0?desc:1]||''),amount:amt};
if(tx.description.length>1)txs.push(tx);
}
return txs;
}

parseLine(line){const cols=[];let cur='',inQ=false;for(const c of line){if(c==='"')inQ=!inQ;else if(c===','&&!inQ){cols.push(cur.trim());cur=''}else cur+=c}cols.push(cur.trim());return cols.map(c=>c.replace(/^"|"$/g,''))}
parseDate(s){if(!s)return null;
// DD/MM/YYYY or DD-MM-YYYY
let m=s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);if(m)return new Date(m[3],m[2]-1,m[1]);
// YYYY-MM-DD or YYYY/MM/DD
m=s.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);if(m)return new Date(m[1],m[2]-1,m[3]);
// DD Mon YYYY (e.g. "15 Jan 2025")
m=s.match(/(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\w*\s+(\d{4})/i);if(m){const months={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};return new Date(m[3],months[m[2].toLowerCase().slice(0,3)],m[1])}
const d=new Date(s);return isNaN(d)?null:d}
norm(d){return d.toLowerCase().replace(/[^\w\s]/g,' ').replace(/\d{4,}/g,'').replace(/\s+/g,' ').trim()}

enrichTransaction(tx){
const n=tx.descNorm;
let lookup=null;let confidence='low';
// Sort patterns by length descending so "uber eats" matches before "uber", "amazon prime video" before "amazon"
if(!this._sortedPatterns)this._sortedPatterns=Object.entries(MERCHANT_DB).sort((a,b)=>b[0].length-a[0].length);
for(const[pattern,data]of this._sortedPatterns){if(n.includes(pattern)){lookup=data;confidence='high';break}}
if(!lookup){
const words=n.split(' ').filter(w=>w.length>2);
lookup={name:words.slice(0,2).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ')||'Unknown',category:'Other',isSubscription:false};
}
const isIncomeCategory=lookup.category==='Income';
const isLargeCredit=tx.amount>1000&&lookup.category==='Other';
return{...tx,merchant:lookup.name,category:isLargeCredit?'Income':lookup.category,subcategory:lookup.subcategory||'',isSubscription:lookup.isSubscription,isIncome:isIncomeCategory||isLargeCredit,isTransfer:lookup.category==='Transfers',isDebt:lookup.category==='Debt Payments',confidence};
}

detectRecurring(txs){
const byM={};
txs.forEach(tx=>{if(!tx.merchant||tx.category==='Income'||tx.category==='Transfers')return;if(!byM[tx.merchant])byM[tx.merchant]=[];byM[tx.merchant].push(tx)});
const recurring=[];
for(const[merchant,list]of Object.entries(byM)){
if(list.length<2)continue;
list.sort((a,b)=>(a.date||0)-(b.date||0));
const intervals=[];
for(let i=1;i<list.length;i++){if(list[i].date&&list[i-1].date){const days=Math.round((list[i].date-list[i-1].date)/(1000*60*60*24));if(days>0)intervals.push(days)}}
if(!intervals.length)continue;
const avg=intervals.reduce((a,b)=>a+b,0)/intervals.length;
const variance=intervals.reduce((s,i)=>s+Math.pow(i-avg,2),0)/intervals.length;
if(Math.sqrt(variance)<avg*0.4&&avg>5){
const freq=avg<10?'weekly':avg<45?'monthly':'annual';
const amounts=list.map(t=>Math.abs(t.amount));
const avgAmt=amounts.reduce((a,b)=>a+b,0)/amounts.length;
recurring.push({merchant,frequency:freq,averageAmount:Math.round(avgAmt*100)/100,category:list[0].category,subcategory:list[0].subcategory,isSubscription:list[0].isSubscription,isDebt:list[0].isDebt});
list.forEach(tx=>tx.isRecurring=true);
}}
return recurring.sort((a,b)=>b.averageAmount-a.averageAmount);
}

buildProfile(txs,recurring){
const income=txs.filter(tx=>tx.isIncome&&tx.amount>0);
const spending=txs.filter(tx=>tx.amount<0&&!tx.isTransfer);
const byCat={};
spending.forEach(tx=>{const k=tx.category||'Other';if(!byCat[k])byCat[k]={total:0,count:0};byCat[k].total+=Math.abs(tx.amount);byCat[k].count++});
const totalIncome=income.reduce((s,tx)=>s+tx.amount,0);
const totalSpending=spending.reduce((s,tx)=>s+Math.abs(tx.amount),0);
const surplus=totalIncome-totalSpending;

// Calculate month span from transaction dates for accurate monthly averages
const dated=txs.filter(tx=>tx.date);
let months=1;
if(dated.length>=2){const dates=dated.map(tx=>tx.date.getTime());const earliest=Math.min(...dates);const latest=Math.max(...dates);months=Math.max(1,Math.round((latest-earliest)/(1000*60*60*24*30.44)))||1}
const mo=m=>Math.round(m/months);

const subs=recurring.filter(r=>r.isSubscription);
const subTotal=subs.reduce((s,r)=>s+r.averageAmount,0);
const debtPay=recurring.filter(r=>r.isDebt);
const debtTotal=debtPay.reduce((s,r)=>s+r.averageAmount,0);
const creditCards=debtPay.filter(r=>r.subcategory==='Credit Card');
const bnpl=debtPay.filter(r=>r.subcategory==='BNPL');
const streaming=subs.filter(r=>['Netflix','Spotify','Disney+','Prime Video','Apple TV+','NOW TV','YouTube Premium'].includes(r.merchant));

const categories=Object.entries(byCat).map(([name,data])=>({name,total:mo(data.total),count:data.count})).sort((a,b)=>b.total-a.total);
const byMerch={};
spending.forEach(tx=>{if(!tx.merchant)return;if(!byMerch[tx.merchant])byMerch[tx.merchant]={total:0,count:0};byMerch[tx.merchant].total+=Math.abs(tx.amount);byMerch[tx.merchant].count++});
const topMerchants=Object.entries(byMerch).map(([merchant,d])=>({merchant,total:Math.round(d.total),count:d.count})).sort((a,b)=>b.total-a.total).slice(0,10);

// Count distinct income sources
const incomeDescs=new Set();
income.forEach(tx=>{const n=tx.descNorm||'';const key=n.split(' ').slice(0,2).join(' ');if(key)incomeDescs.add(key)});
const incomeStreams=incomeDescs.size;

return{
transactionCount:txs.length,monthSpan:months,
monthly:{income:mo(totalIncome),spending:mo(totalSpending),surplus:mo(surplus),subscriptions:Math.round(subTotal),debtPayments:Math.round(debtTotal),foodDelivery:mo(byCat['Food Delivery']?.total||0),shopping:mo(byCat['Shopping']?.total||0),entertainment:mo(byCat['Entertainment']?.total||0),groceries:mo(byCat['Groceries']?.total||0),transport:mo(byCat['Transport']?.total||0),eatingOut:mo(byCat['Eating Out']?.total||0),health:mo(byCat['Health']?.total||0)},
metrics:{savingsRate:totalIncome>0?Math.round((surplus/totalIncome)*100):0,subscriptionCount:subs.length,debtAccountCount:debtPay.length,creditCardCount:creditCards.length,bnplCount:bnpl.length,streamingCount:streaming.length},
// Spending trend: compare last 30 days vs overall monthly average
spendingTrend:this.calcSpendingTrend(spending,months),
categories,topMerchants,recurring,subscriptions:subs,debtPayments:debtPay,incomeStreams
};
}

determineArchetype(p){
const order=['debt_juggler','quiet_builder','edge_walker','subscription_collector','impulse_surfer','convenience_seeker','comfort_spender','lifestyle_investor','side_hustler','balanced_realist'];
for(const k of order){try{if(ARCHETYPES[k].triggers(p))return{key:k,...ARCHETYPES[k]}}catch{}}
return{key:'balanced_realist',...ARCHETYPES.balanced_realist};
}

calcPeerComparison(p){
const m=p.monthly,mt=p.metrics,comps=[];
if(mt.subscriptionCount>0){const d=Math.round(((mt.subscriptionCount-UK_BENCHMARKS.subscriptions.count)/UK_BENCHMARKS.subscriptions.count)*100);comps.push({label:'Subscriptions',value:mt.subscriptionCount,unit:'',diff:d,isHigher:d>0})}
if(m.foodDelivery>0){const d=Math.round(((m.foodDelivery-UK_BENCHMARKS.foodDelivery)/UK_BENCHMARKS.foodDelivery)*100);comps.push({label:'Food Delivery',value:m.foodDelivery,unit:'Â£/mo',diff:d,isHigher:d>0})}
comps.push({label:'Savings Rate',value:mt.savingsRate,unit:'%',diff:mt.savingsRate-UK_BENCHMARKS.savingsRate,isHigher:mt.savingsRate>UK_BENCHMARKS.savingsRate,higherIsGood:true});
return comps.slice(0,4);
}

genInsights(p){
const ins=[],m=p.monthly;
if(p.subscriptions.length>0){ins.push({type:'subscriptions',text:'You have '+p.subscriptions.length+' active subscriptions totalling Â£'+m.subscriptions+'/mo (Â£'+(m.subscriptions*12)+'/yr): '+p.subscriptions.slice(0,4).map(s=>s.merchant+' Â£'+s.averageAmount).join(', ')+(p.subscriptions.length>4?' and '+(p.subscriptions.length-4)+' more':'')+'.'});}
if(p.debtPayments.length>0){ins.push({type:'debt',text:'You have '+p.debtPayments.length+' debt payment'+(p.debtPayments.length>1?'s':'')+' totalling Â£'+m.debtPayments+'/mo (Â£'+(m.debtPayments*12)+'/yr): '+p.debtPayments.slice(0,3).map(d=>d.merchant).join(', ')+'.'+(m.income>0?' That is '+Math.round((m.debtPayments/m.income)*100)+'% of your income.':'')});}
if(m.foodDelivery>50){ins.push({type:'delivery',text:'Food delivery is costing you Â£'+m.foodDelivery+'/month (Â£'+(m.foodDelivery*12)+'/yr). Cooking at home for just 2-3 of those orders per week would save roughly Â£'+Math.round(m.foodDelivery*0.4*12)+'/year.'});}
if((m.eatingOut||0)>80){ins.push({type:'eatingout',text:'You are spending Â£'+(m.eatingOut||0)+'/month eating out and on coffee (Â£'+((m.eatingOut||0)*12)+'/yr). Small daily purchases add up faster than most people realise.'});}
if((m.groceries||0)>0&&m.foodDelivery>0){const ratio=m.foodDelivery/(m.groceries||1);if(ratio>0.5){ins.push({type:'food',text:'Your food delivery spend (Â£'+m.foodDelivery+'/mo) is '+Math.round(ratio*100)+'% of your grocery spend (Â£'+(m.groceries||0)+'/mo). A healthier ratio would be under 25%.'})}}
if((m.shopping||0)>100){ins.push({type:'shopping',text:'Shopping accounts for Â£'+(m.shopping||0)+'/month (Â£'+((m.shopping||0)*12)+'/yr). '+(p.topMerchants?.find(m=>['Amazon','ASOS','Zara','IKEA','H&M','Primark','Shein','Boohoo'].includes(m.merchant))?'Your top retailer is '+p.topMerchants.find(m=>['Amazon','ASOS','Zara','IKEA','H&M','Primark','Shein','Boohoo'].includes(m.merchant)).merchant+'.':'')});}
if(p.spendingTrend){const t=p.spendingTrend;if(t.direction==='up'){ins.push({type:'trend',text:'Your spending in the last 30 days (Â£'+t.recentMonthTotal+') is '+t.pctChange+'% higher than your monthly average (Â£'+t.averageMonthly+'). Top categories this month: '+t.topRecentCategories.map(c=>c.name+' Â£'+c.total).join(', ')+'.'});}else if(t.direction==='down'){ins.push({type:'trend',text:'Good news â€” your spending in the last 30 days (Â£'+t.recentMonthTotal+') is '+Math.abs(t.pctChange)+'% lower than your monthly average (Â£'+t.averageMonthly+'). You are trending in the right direction.'});}}
return ins;
}

calcSpendingTrend(spending,months){
if(months<2||spending.length<10)return null;
const now=new Date();const thirtyDaysAgo=new Date(now.getTime()-30*24*60*60*1000);
const recent=spending.filter(tx=>tx.date&&tx.date>=thirtyDaysAgo);
const recentTotal=recent.reduce((s,tx)=>s+Math.abs(tx.amount),0);
const overallMonthly=spending.reduce((s,tx)=>s+Math.abs(tx.amount),0)/months;
if(overallMonthly===0)return null;
const pctChange=Math.round(((recentTotal-overallMonthly)/overallMonthly)*100);
// Categorise recent spending
const recentByCat={};
recent.forEach(tx=>{const k=tx.category||'Other';if(!recentByCat[k])recentByCat[k]=0;recentByCat[k]+=Math.abs(tx.amount)});
const topRecent=Object.entries(recentByCat).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([name,total])=>({name,total:Math.round(total)}));
return{recentMonthTotal:Math.round(recentTotal),averageMonthly:Math.round(overallMonthly),pctChange,direction:pctChange>10?'up':pctChange<-10?'down':'stable',topRecentCategories:topRecent};
}

calcSavings(p){
const m=p.monthly;const items=[];
const add=(cat,monthly,pct,tip)=>{const yearly=monthly*12;const saving=Math.round(yearly*pct);if(saving>0)items.push({category:cat,monthlySpend:monthly,yearlySpend:yearly,savingAmount:saving,savingPct:Math.round(pct*100),tip})};
add('Subscriptions',m.subscriptions,0.3,'cancel unused, downgrade plans');
add('Food Delivery',m.foodDelivery,0.4,'cook 2-3 more meals per week');
add('Debt Payments',m.debtPayments,0.15,'consolidate or accelerate repayment');
add('Eating Out',m.eatingOut||0,0.25,'1-2 fewer meals out per week');
add('Shopping',m.shopping||0,0.2,'try the 30-day rule');
const total=items.reduce((s,i)=>s+i.savingAmount,0);
return{total:Math.max(total,0),items};
}
}


// BACKGROUND
const initBg=()=>{const c=document.getElementById('ascii-bg'),ctx=c.getContext('2d');const chars=['Â·','â€¢','â—‹','â—','+','âœ¦'];const particles=[];const resize=()=>{c.width=innerWidth;c.height=innerHeight};for(let i=0;i<70;i++)particles.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,char:chars[Math.floor(Math.random()*chars.length)],size:Math.random()*8+5,opacity:Math.random()*0.1+0.02,vx:(Math.random()-0.5)*0.06,vy:(Math.random()-0.5)*0.06,pulse:Math.random()*Math.PI*2,ps:Math.random()*0.01+0.003});const draw=()=>{ctx.clearRect(0,0,c.width,c.height);particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.pulse+=p.ps;if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;ctx.fillStyle='rgba(232,200,114,'+(p.opacity*(0.6+Math.sin(p.pulse)*0.4))+')';ctx.font=p.size+'px "Space Mono"';ctx.textAlign='center';ctx.fillText(p.char,p.x,p.y)});requestAnimationFrame(draw)};resize();addEventListener('resize',resize);draw()};

// NAV
const Nav=()=>(<nav style={{position:'fixed',top:0,left:0,right:0,zIndex:100,padding:'1rem 1.5rem',background:'rgba(10,10,10,0.95)',backdropFilter:'blur(20px)',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center'}}><a href={CONFIG.landingPage} className="mono" style={{fontSize:'1.1rem',fontWeight:700,color:'#fff',textDecoration:'none'}}>BOCY</a><span className="mono" style={{fontSize:'0.6rem',color:'var(--accent)'}}>âœ¦ MONEY PERSONALITY</span></nav>);

// LANDING
const Landing=({onStart})=>(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',padding:'6rem 1.5rem 4rem',position:'relative',zIndex:1,textAlign:'center'}}><div className="fade-in" style={{maxWidth:'380px',width:'100%'}}>

<pre className="mono" style={{fontSize:'0.5rem',lineHeight:1.4,color:'var(--accent)',marginBottom:'2.5rem',opacity:0.7}}>{`      Â·  â€¢  Â·     Â·  â€¢  Â·
    â€¢  âœ¦  â€¢  Â·  â€¢  âœ¦  â€¢
  Â·  â€¢  â—‰  âœ¦  â—‰  â€¢  Â·
    âœ¦  â€¢  â—‰  â—‰  â€¢  âœ¦`}</pre>

<h1 style={{fontSize:'clamp(1.5rem,5.5vw,1.9rem)',fontWeight:600,lineHeight:1.35,marginBottom:'1.25rem',letterSpacing:'-0.01em'}}>Discover your<br/><span style={{color:'var(--accent)'}}>Money Personality</span></h1>

<p style={{color:'var(--dim)',fontSize:'0.95rem',lineHeight:1.8,marginBottom:'1.5rem'}}>Connect your bank or upload a statement.<br/>Personalised insights in seconds.</p>

<p style={{color:'var(--muted)',fontSize:'0.78rem',lineHeight:1.8,marginBottom:'3rem',maxWidth:'320px'}}>Your data never leaves your browser. No login required, no database, no data stored. Everything is analysed in real-time and discarded when you close the page.</p>

<button onClick={onStart} className="mono" style={{padding:'1.1rem 3rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'6px',fontSize:'0.8rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.04em'}}>[ GET STARTED ]</button>

<div style={{marginTop:'3.5rem',display:'flex',justifyContent:'center',gap:'1.5rem',flexWrap:'wrap'}}><span style={{fontSize:'0.7rem',color:'var(--muted)',display:'flex',alignItems:'center',gap:'0.35rem'}}><span style={{color:'var(--mint)',fontSize:'0.5rem'}}>â—</span> Runs in your browser</span><span style={{fontSize:'0.7rem',color:'var(--muted)',display:'flex',alignItems:'center',gap:'0.35rem'}}><span style={{color:'var(--mint)',fontSize:'0.5rem'}}>â—</span> No data stored</span><span style={{fontSize:'0.7rem',color:'var(--muted)',display:'flex',alignItems:'center',gap:'0.35rem'}}><span style={{color:'var(--mint)',fontSize:'0.5rem'}}>â—</span> No login needed</span></div>

</div></div>);

// UPLOAD
const Upload=({onDone,onBack,tlCode,onTlCodeUsed,bankCSVs,setBankCSVs,bankNames,setBankNames})=>{const[files,setFiles]=useState([]);const[status,setStatus]=useState('idle');const[statusMsg,setStatusMsg]=useState('');const[err,setErr]=useState('');const ref=useRef();
const addFiles=newF=>{const valid=Array.from(newF).filter(f=>{const n=f.name.toLowerCase();return n.endsWith('.csv')||n.endsWith('.pdf')});if(!valid.length){setErr('Please upload CSV or PDF files');return}setFiles(p=>[...p,...valid]);setErr('')};
const removeFile=i=>setFiles(p=>p.filter((_,idx)=>idx!==i));
const getFileIcon=name=>name.toLowerCase().endsWith('.pdf')?'â—‰':'â—‹';
const connectBank=()=>{
// Always persist current bank data before OAuth redirect
sessionStorage.setItem('bocy_bank_csvs',JSON.stringify(bankCSVs));
sessionStorage.setItem('bocy_bank_names',JSON.stringify(bankNames));
const redirectUri=encodeURIComponent(TRUELAYER_CONFIG.redirectUri);const scope=encodeURIComponent(TRUELAYER_CONFIG.scope);const providers=encodeURIComponent(TRUELAYER_CONFIG.providers);window.location.href=TRUELAYER_CONFIG.authBaseUrl+'/?response_type=code&client_id='+TRUELAYER_CONFIG.clientId+'&scope='+scope+'&redirect_uri='+redirectUri+'&providers='+providers};
const handleTrueLayerCode=async(code)=>{setStatus('parsing');setStatusMsg('Connecting to your bank...');setErr('');try{
const redirectUri=TRUELAYER_CONFIG.redirectUri;
const resp=await fetch('/api/truelayer/callback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,redirect_uri:redirectUri})});
if(!resp.ok){const d=await resp.json().catch(()=>({}));throw new Error(d.error||'Connection failed')}
const data=await resp.json();
if(!data.csv||data.transactionCount<1){setErr('No transactions found from this bank. Try a different one or upload a statement.');setStatus('idle');return}
// Append to existing bank data (state is already restored by App on mount)
const newBankName='Bank '+(bankNames.length+1)+' ('+data.transactionCount+' transactions)';
setBankCSVs(prev=>[...prev,data.csv]);setBankNames(prev=>[...prev,newBankName]);
setStatus('idle');setStatusMsg('')}catch(e){console.error(e);setErr('Could not connect to your bank. Please try uploading a statement instead.');setStatus('idle')}};
useEffect(()=>{if(tlCode){handleTrueLayerCode(tlCode);onTlCodeUsed?.()}},[tlCode]);
const analyse=async()=>{const allTexts=[...bankCSVs];
try{
for(const f of files){
if(f.name.toLowerCase().endsWith('.pdf')){
try{const pdfText=await extractPDFText(f);allTexts.push(pdfText)}catch(e){setErr('Could not read PDF: '+f.name+'. Please ensure it is not password-protected.');setStatus('idle');return}
}else{allTexts.push(await f.text())}
}
if(!allTexts.length){setErr('Please connect a bank or upload at least one file');return}
setStatus('parsing');setStatusMsg('Parsing your files...');setErr('');
const engine=new EnrichmentEngine();
const result=await engine.enrich(allTexts,msg=>setStatusMsg(msg));
if(result.profile.transactionCount<5){setErr('Not enough transactions found. Please check your file format.');setStatus('idle');return}
onDone(result)}catch(e){console.error(e);setErr('Could not process files. Please try again.');setStatus('idle')}};

if(status==='parsing')return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',padding:'2rem',position:'relative',zIndex:1,textAlign:'center'}}>
<pre className="mono" style={{color:'var(--accent)',marginBottom:'2rem',animation:'pulse 1.5s ease-in-out infinite',fontSize:'0.55rem',lineHeight:1.5}}>{`    Â·  â€¢  Â·
   â€¢  â—‰  â€¢
    Â·  â€¢  Â·`}</pre>
<p style={{fontSize:'1rem',color:'var(--text2)',fontWeight:500,marginBottom:'0.6rem'}}>{statusMsg||'Analysing your transactions...'}</p>
<p style={{fontSize:'0.75rem',color:'var(--muted)',marginBottom:'1.5rem'}}>This may take a moment</p>
<div style={{display:'flex',flexDirection:'column',gap:'0.4rem',alignItems:'center'}}>{['Parsing transactions','Identifying merchants','Categorising data','Building profile'].map((step,i)=>{const active=statusMsg?.toLowerCase().includes(step.split(' ')[0].toLowerCase());const done=statusMsg&&['Parsing','Identifying','Categoris','Building'].findIndex(s=>statusMsg.includes(s))>i;return(<div key={i} style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span style={{color:done?'var(--mint)':active?'var(--accent)':'var(--muted)',fontSize:'0.7rem'}}>{done?'âœ“':active?'â—':'â—‹'}</span><span className="mono" style={{fontSize:'0.65rem',color:done?'var(--dim)':active?'var(--text2)':'var(--muted)'}}>{step}</span></div>)})}</div>
</div>);

// Simplified screen when banks are already connected
if(bankCSVs.length>0)return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',padding:'5.5rem 1.25rem 3rem',position:'relative',zIndex:1}}><div className="slide-up" style={{maxWidth:'400px',width:'100%'}}>

<div style={{textAlign:'center',marginBottom:'2.5rem'}}>
<pre className="mono" style={{fontSize:'0.4rem',lineHeight:1.4,color:'var(--mint)',marginBottom:'1.5rem',opacity:0.6}}>{`   Â·  â€¢  Â·
  â€¢  âœ“  â€¢
   Â·  â€¢  Â·`}</pre>
<h2 style={{fontSize:'1.35rem',fontWeight:600,marginBottom:'0.75rem'}}>Your connected banks</h2>
<p style={{color:'var(--dim)',fontSize:'0.85rem',lineHeight:1.7}}>Ready to analyse your transactions</p>
</div>

<div style={{marginBottom:'1.5rem'}}>{bankNames.map((name,i)=>(<div key={i} style={{display:'flex',alignItems:'center',gap:'0.6rem',padding:'0.75rem 1rem',background:'rgba(114,232,176,0.06)',border:'1px solid rgba(114,232,176,0.12)',borderRadius:'10px',marginBottom:'0.5rem'}}><span style={{color:'var(--mint)',fontSize:'1rem',fontWeight:600}}>âœ“</span><span style={{color:'var(--text2)',fontSize:'0.88rem'}}>{name}</span></div>))}</div>

{err&&<div style={{padding:'0.75rem 1rem',background:'rgba(232,114,114,0.06)',border:'1px solid rgba(232,114,114,0.12)',borderRadius:'8px',marginBottom:'1.25rem',textAlign:'center'}}><p style={{color:'var(--coral)',fontSize:'0.8rem'}}>{err}</p></div>}

<button onClick={analyse} className="mono" style={{width:'100%',padding:'1.1rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'8px',fontSize:'0.82rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.03em',marginBottom:'0.75rem'}}>[ ANALYSE {bankCSVs.length} BANK{bankCSVs.length>1?'S':''} ]</button>

<button onClick={connectBank} className="mono" style={{width:'100%',padding:'0.9rem',background:'transparent',color:'var(--mint)',border:'1px solid rgba(114,232,176,0.25)',borderRadius:'8px',fontSize:'0.75rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.03em'}}>[ + ADD ANOTHER BANK ]</button>

<div style={{display:'flex',justifyContent:'center',gap:'0.6rem',flexWrap:'wrap',marginTop:'1.5rem'}}><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>TrueLayer (FCA regulated)</span><span style={{fontSize:'0.65rem',color:'var(--border)'}}>Â·</span><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>No data stored</span></div>

<button onClick={onBack} style={{display:'block',width:'100%',background:'none',border:'none',color:'var(--muted)',fontSize:'0.8rem',cursor:'pointer',padding:'1rem 0',marginTop:'0.5rem'}}>â† back</button>

</div></div>);

// Default screen: no banks connected â€” show both options
return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',padding:'5.5rem 1.25rem 3rem',position:'relative',zIndex:1}}><div className="slide-up" style={{maxWidth:'400px',width:'100%'}}>

<div style={{textAlign:'center',marginBottom:'2.5rem'}}>
<pre className="mono" style={{fontSize:'0.4rem',lineHeight:1.4,color:'var(--accent)',marginBottom:'1.5rem',opacity:0.5}}>{`   Â·  â€¢  Â·
  â€¢  â—‰  â€¢
   Â·  â€¢  Â·`}</pre>
<h2 style={{fontSize:'1.35rem',fontWeight:600,marginBottom:'0.75rem'}}>Get your results</h2>
<p style={{color:'var(--dim)',fontSize:'0.85rem',lineHeight:1.7}}>Choose how you'd like to share<br/>your transaction history</p>
</div>

<div style={{padding:'1.75rem',background:'linear-gradient(180deg,rgba(114,232,176,0.05) 0%,rgba(114,176,232,0.03) 100%)',border:'1px solid rgba(114,232,176,0.1)',borderRadius:'14px',marginBottom:'1.25rem'}}>
<p className="mono" style={{fontSize:'0.55rem',letterSpacing:'0.15em',color:'var(--mint)',marginBottom:'1.25rem',textTransform:'uppercase'}}>âœ¦ Recommended</p>
<h3 style={{fontSize:'1.1rem',fontWeight:600,color:'#fff',marginBottom:'0.6rem'}}>Connect your bank</h3>
<p style={{color:'var(--dim)',fontSize:'0.82rem',lineHeight:1.7,marginBottom:'1.25rem'}}>Securely link your account for the most accurate personality profile. Read-only access â€” we never see your login details.</p>

<button onClick={connectBank} className="mono" style={{width:'100%',padding:'1rem',background:'var(--mint)',color:'var(--bg)',border:'none',borderRadius:'8px',fontSize:'0.78rem',fontWeight:700,cursor:'pointer',letterSpacing:'0.03em',marginBottom:'1.5rem'}}>[ CONNECT YOUR BANK ]</button>

<div style={{display:'flex',justifyContent:'center',gap:'0.6rem',flexWrap:'wrap'}}><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>TrueLayer (FCA regulated)</span><span style={{fontSize:'0.65rem',color:'var(--border)'}}>Â·</span><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>Read-only access</span><span style={{fontSize:'0.65rem',color:'var(--border)'}}>Â·</span><span style={{fontSize:'0.65rem',color:'var(--muted)'}}>No data stored</span></div>
</div>

<div style={{display:'flex',alignItems:'center',gap:'1rem',margin:'1.75rem 0'}}><div style={{flex:1,height:'1px',background:'var(--border)'}}/><span className="mono" style={{fontSize:'0.6rem',color:'var(--muted)',letterSpacing:'0.1em'}}>OR</span><div style={{flex:1,height:'1px',background:'var(--border)'}}/></div>

<div style={{marginBottom:'1.5rem'}}>
<h3 style={{fontSize:'1rem',fontWeight:500,color:'var(--text2)',marginBottom:'0.5rem',textAlign:'center'}}>Upload a statement</h3>
<p style={{color:'var(--muted)',fontSize:'0.78rem',textAlign:'center',marginBottom:'1.5rem'}}>CSV or PDF from your banking app</p>

<div onClick={()=>ref.current?.click()} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();addFiles(e.dataTransfer.files)}} style={{padding:'2rem 1.5rem',border:'1px dashed rgba(255,255,255,0.08)',borderRadius:'12px',cursor:'pointer',textAlign:'center',marginBottom:'1rem'}}><input ref={ref} type="file" accept=".csv,.pdf" multiple onChange={e=>addFiles(e.target.files)} style={{display:'none'}}/>
<pre className="mono" style={{color:'var(--muted)',fontSize:'0.45rem',lineHeight:1.4,marginBottom:'1rem'}}>{`   Â·  Â·  Â·
  Â·  âœ¦  Â·
   Â·  Â·  Â·`}</pre>
<p style={{color:'var(--text2)',fontSize:'0.88rem',marginBottom:'0.3rem'}}>Drop files here</p>
<p style={{color:'var(--muted)',fontSize:'0.72rem'}}>or tap to browse</p>
</div>

{files.length>0&&(<div style={{marginBottom:'1.25rem'}}><p className="mono" style={{fontSize:'0.65rem',color:'var(--dim)',marginBottom:'0.5rem'}}>{files.length} file{files.length>1?'s':''} selected</p><div style={{display:'flex',flexWrap:'wrap',gap:'0.3rem'}}>{files.map((f,i)=>(<span key={i} className="file-chip">{getFileIcon(f.name)} {f.name.length>25?f.name.substring(0,22)+'...':f.name}<button onClick={()=>removeFile(i)}>Ã—</button></span>))}</div></div>)}

{err&&<div style={{padding:'0.75rem 1rem',background:'rgba(232,114,114,0.06)',border:'1px solid rgba(232,114,114,0.12)',borderRadius:'8px',marginBottom:'1.25rem',textAlign:'center'}}><p style={{color:'var(--coral)',fontSize:'0.8rem'}}>{err}</p></div>}

<button onClick={analyse} disabled={!files.length} className="mono" style={{width:'100%',padding:'1rem',background:files.length?'var(--accent)':'transparent',color:files.length?'var(--bg)':'var(--muted)',border:files.length?'none':'1px solid var(--border)',borderRadius:'8px',fontSize:'0.78rem',fontWeight:700,cursor:files.length?'pointer':'not-allowed'}}>[ ANALYSE {files.length?files.length+' FILE'+(files.length>1?'S':''):''} ]</button>
</div>

<button onClick={onBack} style={{display:'block',width:'100%',background:'none',border:'none',color:'var(--muted)',fontSize:'0.8rem',cursor:'pointer',padding:'1rem 0',marginTop:'0.5rem'}}>â† back</button>

</div></div>)};


// CARD
const ResultCard=React.forwardRef(({result},ref)=>{const{archetype,profile,traits,potentialSavings}=result;const savingsTotal=potentialSavings.total;const ascii=ARCHETYPE_ASCII[archetype.key]||ARCHETYPE_ASCII.balanced_realist;const topCat=profile.categories[0]?.name||'Lifestyle';return(<div ref={ref} style={{width:'320px',background:'#050505',borderRadius:'12px',padding:'24px',position:'relative',overflow:'hidden',border:'1px solid '+archetype.color+'30'}}><div style={{position:'absolute',inset:0,background:'radial-gradient(circle at 50% 20%,'+archetype.color+'10 0%,transparent 50%)',pointerEvents:'none'}}/><div style={{position:'relative',zIndex:1}}><pre className="mono" style={{fontSize:'10px',lineHeight:'12px',color:archetype.color,textAlign:'center',marginBottom:'16px',whiteSpace:'pre'}}>{ascii.split('\\n').join('\n')}</pre><div style={{textAlign:'center',marginBottom:'16px'}}><span style={{fontSize:'2rem',display:'block',marginBottom:'4px'}}>{archetype.emoji}</span><h2 className="mono" style={{fontSize:'0.85rem',fontWeight:700,color:'#fff',marginBottom:'4px'}}>{archetype.name}</h2><p style={{fontSize:'0.65rem',color:archetype.color,fontStyle:'italic'}}>"{archetype.vibe}"</p></div>{traits.length>0&&(<div style={{display:'flex',flexWrap:'wrap',justifyContent:'center',gap:'4px',marginBottom:'16px'}}>{traits.slice(0,3).map((t,i)=>(<span key={i} style={{fontSize:'0.6rem',padding:'2px 8px',background:'rgba(255,255,255,0.05)',borderRadius:'10px',color:'var(--dim)'}}>{t.emoji} {t.text}</span>))}</div>)}<div style={{background:'rgba(255,255,255,0.02)',border:'1px solid rgba(255,255,255,0.04)',borderRadius:'8px',padding:'14px',marginBottom:'14px'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}><span className="mono" style={{fontSize:'0.6rem',color:'var(--dim)'}}>Subscriptions</span><span className="mono" style={{fontSize:'0.6rem',color:'#fff'}}>{profile.metrics.subscriptionCount} (Â£{profile.monthly.subscriptions}/mo)</span></div>{profile.metrics.debtAccountCount>0&&(<div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}><span className="mono" style={{fontSize:'0.6rem',color:'var(--dim)'}}>Debt Payments</span><span className="mono" style={{fontSize:'0.6rem',color:'var(--coral)'}}>{profile.metrics.debtAccountCount} (Â£{profile.monthly.debtPayments}/mo)</span></div>)}<div style={{display:'flex',justifyContent:'space-between'}}><span className="mono" style={{fontSize:'0.6rem',color:'var(--dim)'}}>Top Category</span><span className="mono" style={{fontSize:'0.6rem',color:'#fff'}}>{topCat}</span></div><div style={{textAlign:'center',paddingTop:'12px',marginTop:'12px',borderTop:'1px solid rgba(255,255,255,0.04)'}}><p className="mono" style={{fontSize:'0.5rem',color:'#444',marginBottom:'4px'}}>POTENTIAL SAVINGS</p><p className="mono" style={{fontSize:'1.6rem',fontWeight:700,color:archetype.color}}>Â£{savingsTotal.toLocaleString()}</p><p className="mono" style={{fontSize:'0.45rem',color:'#333'}}>per year</p></div></div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',borderTop:'1px solid rgba(255,255,255,0.04)',paddingTop:'12px'}}><span className="mono" style={{fontSize:'0.8rem',fontWeight:700,color:'#fff'}}>BOCY</span><span className="mono" style={{fontSize:'0.45rem',color:'#444'}}>bocy.io/personality</span></div></div></div>)});

// WHERE YOUR MONEY GOES â€” clean spend vs savings breakdown
const SavingsBreakdown=({potentialSavings})=>{
const maxSpend=Math.max(...potentialSavings.items.map(i=>i.yearlySpend),1);
return(<div className="card-box slide-up" style={{border:'1px solid rgba(114,232,176,0.15)'}}><div className="section-title" style={{color:'var(--mint)'}}>Where Your Money Goes</div><div style={{textAlign:'center',marginBottom:'1.5rem',paddingBottom:'1.25rem',borderBottom:'1px solid var(--border)'}}><p className="mono" style={{fontSize:'2rem',fontWeight:700,color:'var(--mint)'}}>Â£{potentialSavings.total.toLocaleString()}</p><p style={{fontSize:'0.8rem',color:'var(--dim)'}}>potential savings per year</p><p style={{fontSize:'0.7rem',color:'var(--muted)',marginTop:'0.3rem'}}>by making small changes across these categories</p></div><div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>{potentialSavings.items.map((item,i)=>(<div key={i}><div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline',marginBottom:'0.35rem'}}><span style={{color:'#fff',fontSize:'0.92rem',fontWeight:500}}>{item.category}</span><span className="mono" style={{color:'var(--text2)',fontSize:'0.88rem',fontWeight:600}}>Â£{item.monthlySpend}<span style={{color:'var(--muted)',fontWeight:400,fontSize:'0.7rem'}}>/mo</span></span></div><div style={{height:'6px',background:'rgba(255,255,255,0.04)',borderRadius:'3px',marginBottom:'0.4rem',overflow:'hidden'}}><div style={{height:'100%',width:Math.round((item.yearlySpend/maxSpend)*100)+'%',background:'linear-gradient(90deg,rgba(114,232,176,0.3),rgba(114,232,176,0.15))',borderRadius:'3px'}}/></div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{color:'var(--muted)',fontSize:'0.75rem'}}>{item.tip}</span><span className="mono" style={{color:'var(--mint)',fontSize:'0.78rem',fontWeight:600}}>save Â£{item.savingAmount.toLocaleString()}/yr</span></div></div>))}</div></div>)};

// RESULT
const Result=({result})=>{const cardRef=useRef();const[downloading,setDownloading]=useState(false);const[email,setEmail]=useState('');const[emailStatus,setEmailStatus]=useState('idle');const{archetype,profile,traits,strengths,blindSpots,peerComparison,insights,potentialSavings}=result;
const downloadCard=async()=>{if(!cardRef.current)return;setDownloading(true);try{const canvas=await html2canvas(cardRef.current,{backgroundColor:'#050505',scale:3});const link=document.createElement('a');link.download='my-money-personality.png';link.href=canvas.toDataURL('image/png');link.click()}catch(e){console.error(e)}setDownloading(false)};
const shareTwitter=()=>{const t='I am "'+archetype.name+'" '+archetype.emoji+'\n\n"'+archetype.vibe+'"\n\nApparently I could be saving Â£'+potentialSavings.total+'/year\n\nFind yours:';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(t)+'&url='+encodeURIComponent('https://bocy.io/personality'),'_blank')};
const submitEmail=async e=>{e.preventDefault();if(!email||emailStatus==='sending')return;setEmailStatus('sending');try{await fetch(CONFIG.googleScript,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,archetype:archetype.name,potentialSavings:potentialSavings.total,savingsRate:profile.metrics.savingsRate,subscriptionCount:profile.metrics.subscriptionCount,debtAccountCount:profile.metrics.debtAccountCount,traits:traits.map(t=>t.text).join(', '),timestamp:new Date().toISOString()})});setEmailStatus('done')}catch{setEmailStatus('done')}};

return(<div style={{minHeight:'100vh',padding:'5rem 1rem 3rem',position:'relative',zIndex:1}}><div style={{maxWidth:'500px',margin:'0 auto'}}>
<div className="fade-in" style={{display:'flex',justifyContent:'center',marginBottom:'1.5rem'}}><ResultCard ref={cardRef} result={result}/></div>
<div className="slide-up" style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem'}}><button onClick={downloadCard} disabled={downloading} className="mono" style={{flex:1,padding:'0.7rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'6px',fontSize:'0.65rem',fontWeight:700,cursor:'pointer'}}>{downloading?'...':'[ SAVE CARD ]'}</button><button onClick={shareTwitter} className="mono" style={{flex:1,padding:'0.7rem',background:'transparent',color:'#fff',border:'1px solid var(--border)',borderRadius:'6px',fontSize:'0.65rem',fontWeight:700,cursor:'pointer'}}>[ SHARE ]</button></div>

<div className="card-box slide-up"><div className="section-title">Your Money Personality</div><div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.75rem'}}><span style={{fontSize:'2rem'}}>{archetype.emoji}</span><h2 style={{fontSize:'1.2rem',fontWeight:600,color:archetype.color}}>{archetype.name}</h2></div><p style={{color:'var(--text2)',fontSize:'0.9rem',lineHeight:1.7}}>{archetype.description}</p></div>

<div className="card-box slide-up"><div className="section-title">What Your Money Says About You</div><p style={{color:'var(--text2)',fontSize:'0.9rem',lineHeight:1.7}}>{archetype.genMoneyStory?archetype.genMoneyStory(profile):''}</p></div>

{traits.length>0&&(<div className="card-box slide-up"><div className="section-title">Your Traits</div><div style={{display:'flex',flexWrap:'wrap',gap:'0.4rem'}}>{traits.map((t,i)=>(<span key={i} className="trait-tag">{t.emoji} {t.text}</span>))}</div></div>)}

<div className="card-box slide-up"><div className="section-title">Your Strengths</div><div style={{display:'flex',flexDirection:'column',gap:'0.6rem'}}>{strengths.length>0?strengths.map((s,i)=>(<div key={i} style={{display:'flex',alignItems:'center',gap:'0.6rem'}}><span style={{color:'var(--mint)',fontSize:'0.9rem'}}>âœ¦</span><span style={{color:'var(--text2)',fontSize:'0.9rem'}}>{s}</span></div>)):<p style={{color:'var(--dim)',fontSize:'0.85rem'}}>Upload more transactions for detailed analysis</p>}</div></div>

<div className="card-box slide-up"><div className="section-title">Your Blind Spots</div><div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>{blindSpots.length>0?blindSpots.map((b,i)=>(<div key={i}><div style={{display:'flex',alignItems:'center',gap:'0.6rem',marginBottom:'0.2rem'}}><span style={{color:'var(--coral)',fontSize:'0.9rem'}}>âš </span><span style={{color:'#fff',fontSize:'0.9rem',fontWeight:500}}>{b.text}</span></div><p style={{color:'var(--dim)',fontSize:'0.8rem',marginLeft:'1.5rem'}}>{b.detail}</p></div>)):<p style={{color:'var(--dim)',fontSize:'0.85rem'}}>No major blind spots detected</p>}</div></div>

<div className="card-box slide-up"><div className="section-title">How You Compare (UK Average)</div><div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>{peerComparison.map((p,i)=>(<div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{color:'var(--text2)',fontSize:'0.85rem'}}>{p.label}</span><div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span className="mono" style={{color:'#fff',fontSize:'0.9rem',fontWeight:600}}>{p.value}{p.unit==='Â£/mo'?'':p.unit}</span>{p.unit==='Â£/mo'&&<span style={{color:'var(--dim)',fontSize:'0.75rem'}}>Â£/mo</span>}{p.diff!==0&&(<span className="mono" style={{fontSize:'0.7rem',color:p.higherIsGood?(p.isHigher?'var(--mint)':'var(--coral)'):(p.isHigher?'var(--coral)':'var(--mint)'),padding:'0.15rem 0.4rem',background:p.higherIsGood?(p.isHigher?'rgba(114,232,176,0.1)':'rgba(232,114,114,0.1)'):(p.isHigher?'rgba(232,114,114,0.1)':'rgba(114,232,176,0.1)'),borderRadius:'4px'}}>{p.diff>0?'+':''}{p.diff}%</span>)}</div></div>))}</div></div>

{profile.spendingTrend&&(<div className="card-box slide-up"><div className="section-title">Spending Trend</div><div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.75rem'}}><span style={{fontSize:'1.5rem'}}>{profile.spendingTrend.direction==='up'?'ðŸ“ˆ':profile.spendingTrend.direction==='down'?'ðŸ“‰':'âž¡ï¸'}</span><div><p style={{color:'#fff',fontSize:'0.95rem',fontWeight:500}}>Last 30 days: Â£{profile.spendingTrend.recentMonthTotal}</p><p style={{color:'var(--dim)',fontSize:'0.8rem'}}>vs Â£{profile.spendingTrend.averageMonthly}/mo average ({profile.spendingTrend.pctChange>0?'+':''}{profile.spendingTrend.pctChange}%)</p></div></div>{profile.spendingTrend.topRecentCategories.length>0&&(<div style={{display:'flex',gap:'0.4rem',flexWrap:'wrap'}}>{profile.spendingTrend.topRecentCategories.map((c,i)=>(<span key={i} className="trait-tag" style={{background:'rgba(114,176,232,0.08)',borderColor:'rgba(114,176,232,0.15)',color:'var(--sky)'}}>{c.name} Â£{c.total}</span>))}</div>)}</div>)}

{insights.length>0&&(<div className="card-box slide-up"><div className="section-title">Your Personalised Insights</div><div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>{insights.map((ins,i)=>(<p key={i} style={{color:'var(--text2)',fontSize:'0.85rem',lineHeight:1.7,padding:'0.6rem',background:ins.type==='debt'?'rgba(232,114,114,0.05)':ins.type==='trend'?'rgba(114,176,232,0.05)':'rgba(232,200,114,0.05)',borderRadius:'6px',borderLeft:ins.type==='debt'?'3px solid var(--coral)':ins.type==='trend'?'3px solid var(--sky)':'3px solid var(--accent)'}}>{ins.text}</p>))}</div></div>)}

{potentialSavings.items.length>0&&(<SavingsBreakdown potentialSavings={potentialSavings}/>)}

{emailStatus!=='done'?(<div className="slide-up" style={{background:'linear-gradient(135deg,rgba(232,200,114,0.08) 0%,rgba(178,114,232,0.08) 100%)',border:'1px solid rgba(232,200,114,0.2)',borderRadius:'10px',padding:'1.5rem',marginTop:'1.5rem'}}><div className="section-title" style={{color:'var(--accent)'}}>ðŸ”’ Unlock Your Action Plan</div><p style={{color:'#fff',fontSize:'0.95rem',fontWeight:500,marginBottom:'0.75rem'}}>BOCY will automatically:</p><div style={{display:'flex',flexDirection:'column',gap:'0.5rem',marginBottom:'1.25rem'}}><div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span style={{color:'var(--accent)'}}>â†’</span><span style={{color:'var(--text2)',fontSize:'0.85rem'}}>Analyse your finances in real-time to surface immediate optimisation opportunities</span></div><div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span style={{color:'var(--accent)'}}>â†’</span><span style={{color:'var(--text2)',fontSize:'0.85rem'}}>Provides clear, instant recommendations with exact financial impacts</span></div><div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}><span style={{color:'var(--accent)'}}>â†’</span><span style={{color:'var(--text2)',fontSize:'0.85rem'}}>Execute only when you approve(One tap)</span></div></div><form onSubmit={submitEmail} style={{display:'flex',gap:'0.5rem'}}><input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="your@email.com" required style={{flex:1,padding:'0.75rem 1rem',background:'rgba(0,0,0,0.3)',border:'1px solid var(--border)',borderRadius:'6px',color:'#fff',fontSize:'0.85rem',outline:'none'}}/><button type="submit" disabled={emailStatus==='sending'} className="mono" style={{padding:'0.75rem 1.25rem',background:'var(--accent)',color:'var(--bg)',border:'none',borderRadius:'6px',fontSize:'0.75rem',fontWeight:700,cursor:'pointer'}}>{emailStatus==='sending'?'...':'JOIN'}</button></form></div>):(<div className="slide-up" style={{background:'rgba(114,232,176,0.08)',border:'1px solid rgba(114,232,176,0.2)',borderRadius:'10px',padding:'1.5rem',marginTop:'1.5rem',textAlign:'center'}}><span style={{fontSize:'2rem',display:'block',marginBottom:'0.5rem'}}>âœ“</span><p style={{color:'var(--mint)',fontSize:'1rem',fontWeight:600,marginBottom:'0.5rem'}}>You are on the list!</p><p style={{color:'var(--dim)',fontSize:'0.85rem',marginBottom:'1rem'}}>We will notify you when BOCY launches.</p><a href={CONFIG.landingPage} className="mono" style={{display:'inline-block',padding:'0.8rem 1.5rem',background:'var(--accent)',color:'var(--bg)',borderRadius:'6px',fontSize:'0.75rem',fontWeight:700,textDecoration:'none'}}>[ LEARN MORE ABOUT BOCY ]</a></div>)}

<div style={{textAlign:'center',marginTop:'2rem',paddingTop:'1.5rem',borderTop:'1px solid var(--border)'}}><p style={{color:'var(--dim)',fontSize:'0.8rem',marginBottom:'0.75rem'}}>Want to see the full picture?</p><a href={CONFIG.landingPage} style={{color:'var(--accent)',fontSize:'0.85rem',textDecoration:'none'}}>Learn more on bocy.io â†’</a></div>
</div></div>)};

// APP
const App=()=>{const[screen,setScreen]=useState('landing');const[result,setResult]=useState(null);const[tlCode,setTlCode]=useState(null);
// Lift bank state to App so it survives OAuth redirect cycle
const[bankCSVs,setBankCSVs]=useState([]);const[bankNames,setBankNames]=useState([]);
useEffect(()=>{initBg();
// Restore bank data from sessionStorage (persisted before OAuth redirect)
const savedCSVs=JSON.parse(sessionStorage.getItem('bocy_bank_csvs')||'[]');
const savedNames=JSON.parse(sessionStorage.getItem('bocy_bank_names')||'[]');
if(savedCSVs.length>0){setBankCSVs(savedCSVs);setBankNames(savedNames);sessionStorage.removeItem('bocy_bank_csvs');sessionStorage.removeItem('bocy_bank_names')}
const params=new URLSearchParams(window.location.search);const code=params.get('code');if(code){window.history.replaceState({},'',window.location.pathname);setTlCode(code);setScreen('upload')}},[]);
const handleData=r=>{setResult(r);setScreen('result')};return(<><Nav/>{screen==='landing'&&<Landing onStart={()=>setScreen('upload')}/>}{screen==='upload'&&<Upload onDone={handleData} onBack={()=>setScreen('landing')} tlCode={tlCode} onTlCodeUsed={()=>setTlCode(null)} bankCSVs={bankCSVs} setBankCSVs={setBankCSVs} bankNames={bankNames} setBankNames={setBankNames}/>}{screen==='result'&&<Result result={result}/>}</>)};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
